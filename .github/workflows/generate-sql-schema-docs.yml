name: Generate PostgreSQL Schema Dump

on:
  workflow_dispatch: # Allows manual trigger
  push:
    paths:
      - "Code/AppBlueprint/Shared-Modules/AppBlueprint.Infrastructure/Migrations/**"
      - "!**.md"
    branches:
      - main

permissions:
  contents: write  # Required to push changes back to the repository

jobs:
  generate-schema:
    runs-on: ubuntu-latest

    steps:
      # Step 1: Check out the repository
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          persist-credentials: true

      # Step 2: Install PostgreSQL 17 client tools
      - name: Install PostgreSQL 17 client
        run: |
          # Add PostgreSQL APT repository
          sudo sh -c 'echo "deb http://apt.postgresql.org/pub/repos/apt $(lsb_release -cs)-pgdg main" > /etc/apt/sources.list.d/pgdg.list'
          wget --quiet -O - https://www.postgresql.org/media/keys/ACCC4CF8.asc | sudo apt-key add -
          sudo apt-get update
          
          # Install PostgreSQL 17 client
          sudo apt-get install -y postgresql-client-17
          
          # Verify version
          pg_dump --version

      # Step 3: Generate the SQL schema dump with retry logic
      - name: Generate schema dump
        env:
          PGPASSWORD: ${{ secrets.PG_PASSWORD }}
        run: |
          MAX_RETRIES=3
          RETRY_DELAY=30
          ATTEMPT=1
          
          while [ $ATTEMPT -le $MAX_RETRIES ]; do
            echo "Attempt $ATTEMPT of $MAX_RETRIES..."
            
            if pg_dump --host=${{ secrets.PG_HOST }} \
                       --port=${{ secrets.PG_PORT }} \
                       --username=${{ secrets.PG_USER }} \
                       --dbname=${{ secrets.PG_DB }} \
                       --schema-only \
                       --no-owner \
                       --no-privileges \
                       --file=schema.sql; then
              echo "Schema dump generated successfully"
              break
            else
              EXIT_CODE=$?
              if [ $ATTEMPT -lt $MAX_RETRIES ]; then
                echo "pg_dump failed with exit code $EXIT_CODE. Database might be sleeping..."
                echo "Retrying in $RETRY_DELAY seconds..."
                sleep $RETRY_DELAY
                ATTEMPT=$((ATTEMPT + 1))
              else
                echo "pg_dump failed after $MAX_RETRIES attempts"
                exit $EXIT_CODE
              fi
            fi
          done
          
          # Verify the file was created
          if [ ! -f schema.sql ]; then
            echo "Error: schema.sql was not generated"
            exit 1
          fi
          
          ls -lh schema.sql

      # Step 4: Create Pull Request with schema changes
      - name: Create Pull Request
        id: create-pr
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "Update PostgreSQL schema dump [Automated]"
          branch: update-schema-dump
          delete-branch: true
          title: "Update PostgreSQL schema dump"
          body: |
            ## Automated Schema Update
            
            This PR updates the `schema.sql` file with the latest database schema from the production database.
            
            **Generated from:** `${{ secrets.PG_DB }}` database
            **Triggered by:** ${{ github.event_name }}
            **Workflow run:** ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
            
            ### Changes
            - Updated `schema.sql` with current database schema
            
            This is an automated update generated by the `generate-sql-schema-docs.yml` workflow.
          labels: |
            documentation
            automated
          assignees: ${{ github.actor }}

      # Step 5: Enable auto-merge for the PR
      - name: Enable auto-merge
        if: steps.create-pr.outputs.pull-request-number != ''
        run: |
          gh pr merge ${{ steps.create-pr.outputs.pull-request-number }} \
            --auto \
            --squash \
            --delete-branch
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  
          
