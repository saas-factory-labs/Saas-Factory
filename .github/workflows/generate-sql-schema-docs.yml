name: "üìë Quality: SQL Schema Documentation"

on:
  workflow_dispatch: # Allows manual trigger
  push:
    paths:
      - "Code/AppBlueprint/Shared-Modules/AppBlueprint.Infrastructure/Migrations/**"
      - "!**.md"
    branches:
      - main

permissions:
  contents: write       # Required to push changes back to the repository
  pull-requests: write  # Required to create pull requests

jobs:
  generate-schema:
    runs-on: blacksmith-2vcpu-ubuntu-2404

    steps:
      # Step 1: Check out the repository
      - name: Checkout repository
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5  # v4.3.1
        with:
          token: ${{ secrets.GH_ACTION_SCHEMA_AUTOMATION_TOKEN || github.token }}
          persist-credentials: true

      # Step 2: Install PostgreSQL 17 client tools
      - name: Install PostgreSQL 17 client
        run: |
          # Add PostgreSQL APT repository
          sudo sh -c 'echo "deb http://apt.postgresql.org/pub/repos/apt $(lsb_release -cs)-pgdg main" > /etc/apt/sources.list.d/pgdg.list'
          wget --quiet -O - https://www.postgresql.org/media/keys/ACCC4CF8.asc | sudo apt-key add -
          sudo apt-get update
          
          # Install PostgreSQL 17 client
          sudo apt-get install -y postgresql-client-17
          
          # Verify version
          pg_dump --version

      # Step 3: Generate the SQL schema dump with retry logic
      - name: Generate schema dump
        env:
          PGHOST: ${{ secrets.PG_HOST }}
          PGPORT: ${{ secrets.PG_PORT }}
          PGUSER: ${{ secrets.PG_USER }}
          PGDATABASE: ${{ secrets.PG_DB }}
          PGPASSWORD: ${{ secrets.PG_PASSWORD }}
        run: |
          MAX_RETRIES=3
          RETRY_DELAY=30
          ATTEMPT=1
          
          while [ $ATTEMPT -le $MAX_RETRIES ]; do
            echo "Attempt $ATTEMPT of $MAX_RETRIES..."
            
            if pg_dump --schema-only \
                       --no-owner \
                       --no-privileges \
                       --file=schema.sql; then
              echo "Schema dump generated successfully"
              break
            else
              EXIT_CODE=$?
              if [ $ATTEMPT -lt $MAX_RETRIES ]; then
                echo "pg_dump failed with exit code $EXIT_CODE. Database might be sleeping..."
                echo "Retrying in $RETRY_DELAY seconds..."
                sleep $RETRY_DELAY
                ATTEMPT=$((ATTEMPT + 1))
              else
                echo "pg_dump failed after $MAX_RETRIES attempts"
                exit $EXIT_CODE
              fi
            fi
          done
          
          # Verify the file was created
          if [ ! -f schema.sql ]; then
            echo "Error: schema.sql was not generated"
            exit 1
          fi
          
          ls -lh schema.sql

      # Step 4: Create PR with schema file changes
      - name: Create Pull Request
        id: create-pr
        uses: peter-evans/create-pull-request@5e914681df9dc83aa4e4905692ca88beb2f9e91f  # v7.0.5
        with:
          token: ${{ secrets.GH_ACTION_SCHEMA_AUTOMATION_TOKEN || github.token }}
          commit-message: "Update PostgreSQL schema dump [skip ci]"
          title: "üóÑÔ∏è Update PostgreSQL schema documentation"
          body: |
            ## Automated Schema Update
            
            This PR updates the PostgreSQL schema dump from the latest database state.
            
            **Generated by:** GitHub Actions workflow
            **Triggered by:** Migration changes in `AppBlueprint.Infrastructure/Migrations/`
            
            The schema file will be used for documentation and reference purposes.
            
            ---
            ‚úÖ Safe to merge - this is just a documentation update
          branch: automated/update-schema-dump
          delete-branch: true
          labels: |
            documentation
            automated
          add-paths: |
            schema.sql

      # Step 5: Enable auto-merge on the PR
      - name: Enable auto-merge
        if: steps.create-pr.outputs.pull-request-number != ''
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh pr merge ${{ steps.create-pr.outputs.pull-request-number }} \
            --auto \
            --squash \
            --delete-branch
  
          
