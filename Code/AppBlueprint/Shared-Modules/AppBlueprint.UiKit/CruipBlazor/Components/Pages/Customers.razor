@page "/customers"
@using MosaicPortal.Web.Components.Shared

<PageTitle>Customers - Mosaic</PageTitle>

<div class="px-4 sm:px-6 lg:px-8 py-8 w-full max-w-[96rem] mx-auto">
    @* Page header *@
    <div class="sm:flex sm:justify-between sm:items-center mb-8">
        <div class="mb-4 sm:mb-0">
            <h1 class="text-2xl md:text-3xl text-gray-800 dark:text-gray-100 font-bold">Customers âœ¨</h1>
        </div>
        <div class="grid grid-flow-col sm:auto-cols-max justify-start sm:justify-end gap-2">
            <button class="btn bg-gray-900 text-gray-100 hover:bg-gray-800 dark:bg-gray-100 dark:text-gray-800 dark:hover:bg-white">
                <svg class="fill-current shrink-0 xs:hidden" width="16" height="16" viewBox="0 0 16 16">
                    <path d="M15 7H9V1c0-.6-.4-1-1-1S7 .4 7 1v6H1c-.6 0-1 .4-1 1s.4 1 1 1h6v6c0 .6.4 1 1 1s1-.4 1-1V9h6c.6 0 1-.4 1-1s-.4-1-1-1z" />
                </svg>
                <span class="max-xs:sr-only">Add Customer</span>
            </button>
        </div>
    </div>

    @* DataTable *@
    <DataTable TItem="Customer"
               Items="@customers"
               Columns="@columns"
               SearchFilter="@((customer, term) =>
                   customer.Name.Contains(term, StringComparison.OrdinalIgnoreCase) ||
                   customer.Email.Contains(term, StringComparison.OrdinalIgnoreCase) ||
                   customer.Company.Contains(term, StringComparison.OrdinalIgnoreCase))"
               ItemKey="@(c => c.Id)"
               PageSize="10"
               SearchPlaceholder="Search customers..."
               SelectedItemsChanged="@OnSelectionChanged">
        <RowTemplate Context="customer">
            <td class="px-2 first:pl-5 last:pr-5 py-3 whitespace-nowrap">
                <div class="flex items-center">
                    <div class="w-10 h-10 shrink-0 mr-2 sm:mr-3">
                        <img class="rounded-full" src="@customer.Avatar" width="40" height="40" alt="@customer.Name" />
                    </div>
                    <div class="font-medium text-gray-800 dark:text-gray-100">@customer.Name</div>
                </div>
            </td>
            <td class="px-2 first:pl-5 last:pr-5 py-3 whitespace-nowrap">
                <div class="text-left">@customer.Email</div>
            </td>
            <td class="px-2 first:pl-5 last:pr-5 py-3 whitespace-nowrap">
                <div class="text-left">@customer.Company</div>
            </td>
            <td class="px-2 first:pl-5 last:pr-5 py-3 whitespace-nowrap">
                <div class="text-left font-medium @GetOrdersColor(customer.Orders)">@customer.Orders.ToString("C0")</div>
            </td>
            <td class="px-2 first:pl-5 last:pr-5 py-3 whitespace-nowrap">
                <div class="text-center">@customer.LastOrder.ToString("MMM dd, yyyy")</div>
            </td>
            <td class="px-2 first:pl-5 last:pr-5 py-3 whitespace-nowrap">
                <div class="flex items-center">
                    <div class="@GetStatusDotClasses(customer.Status)"></div>
                    <span class="text-sm">@customer.Status</span>
                </div>
            </td>
        </RowTemplate>
        <RowActions Context="customer">
            <button class="text-gray-400 hover:text-gray-500 dark:text-gray-500 dark:hover:text-gray-400 rounded-full p-1.5 hover:bg-gray-100 dark:hover:bg-gray-700/50">
                <span class="sr-only">Edit</span>
                <svg class="shrink-0 fill-current" width="16" height="16" viewBox="0 0 16 16">
                    <path d="M11.7.3c-.4-.4-1-.4-1.4 0l-10 10c-.2.2-.3.4-.3.7v4c0 .6.4 1 1 1h4c.3 0 .5-.1.7-.3l10-10c.4-.4.4-1 0-1.4l-4-4zM4.6 14H2v-2.6l6-6L10.6 8l-6 6zM12 6.6L9.4 4 11 2.4 13.6 5 12 6.6z" />
                </svg>
            </button>
        </RowActions>
        <BulkActions>
            <button class="btn-xs bg-white dark:bg-gray-800 border-gray-200 dark:border-gray-700/60 hover:border-gray-300 dark:hover:border-gray-600 text-red-500">
                <svg class="fill-current shrink-0" width="16" height="16" viewBox="0 0 16 16">
                    <path d="M5 7h2v6H5V7zm4 0h2v6H9V7zm3-6v2h4v2h-1v10c0 .6-.4 1-1 1H2c-.6 0-1-.4-1-1V5H0V3h4V1c0-.6.4-1 1-1h6c.6 0 1 .4 1 1zm-7 2h6V2H5v1zm6 2H3v9h10V5h-2z" />
                </svg>
                <span>Delete</span>
            </button>
        </BulkActions>
        <HeaderActions>
            <button class="btn bg-white dark:bg-gray-800 border-gray-200 dark:border-gray-700/60 hover:border-gray-300 dark:hover:border-gray-600 text-gray-400 dark:text-gray-500">
                <svg class="fill-current" width="16" height="16" viewBox="0 0 16 16">
                    <path d="M0 3a1 1 0 0 1 1-1h14a1 1 0 1 1 0 2H1a1 1 0 0 1-1-1zm3 5a1 1 0 0 1 1-1h8a1 1 0 1 1 0 2H4a1 1 0 0 1-1-1zm4 5a1 1 0 0 1 1-1h2a1 1 0 1 1 0 2H8a1 1 0 0 1-1-1z" />
                </svg>
                <span class="ml-2">Filter</span>
            </button>
        </HeaderActions>
    </DataTable>
</div>

@code {
    private List<Customer> customers = new();
    private List<DataTable<Customer>.DataTableColumn> columns = new();
    private List<Customer> selectedCustomers = new();

    protected override void OnInitialized()
    {
        columns = new List<DataTable<Customer>.DataTableColumn>
        {
            new() { PropertyName = "Name", Title = "Name", Sortable = true, SortFunc = c => c.Name },
            new() { PropertyName = "Email", Title = "Email", Sortable = true, SortFunc = c => c.Email },
            new() { PropertyName = "Company", Title = "Company", Sortable = true, SortFunc = c => c.Company },
            new() { PropertyName = "Orders", Title = "Orders", Sortable = true, SortFunc = c => c.Orders },
            new() { PropertyName = "LastOrder", Title = "Last Order", Sortable = true, SortFunc = c => c.LastOrder },
            new() { PropertyName = "Status", Title = "Status", Sortable = true, SortFunc = c => c.Status }
        };

        // Generate sample data
        customers = GenerateSampleCustomers();
    }

    private void OnSelectionChanged(List<Customer> selected)
    {
        selectedCustomers = selected;
    }

    private string GetOrdersColor(decimal orders)
    {
        return orders >= 1000 ? "text-green-600" : "text-gray-800 dark:text-gray-100";
    }

    private string GetStatusDotClasses(string status)
    {
        var baseClasses = "w-2 h-2 rounded-full mr-2";
        return status switch
        {
            "Active" => $"{baseClasses} bg-green-500",
            "Inactive" => $"{baseClasses} bg-gray-400",
            "Pending" => $"{baseClasses} bg-yellow-500",
            _ => $"{baseClasses} bg-gray-400"
        };
    }

    private List<Customer> GenerateSampleCustomers()
    {
        var statuses = new[] { "Active", "Inactive", "Pending" };
        var companies = new[] { "Acme Corp", "Globex", "Initech", "Umbrella Corp", "Wayne Enterprises", "Stark Industries", "Oscorp", "LexCorp" };
        var firstNames = new[] { "Alex", "Patricia", "Max", "Carolyn", "Mary", "Mark", "Emma", "John", "Sarah", "David", "Lisa", "James", "Jennifer", "Michael", "Emily" };
        var lastNames = new[] { "Shatov", "Semklo", "Mironov", "McNeail", "Flynn", "Smith", "Johnson", "Williams", "Brown", "Jones", "Garcia", "Miller", "Davis", "Rodriguez", "Martinez" };

        var random = new Random(42); // Fixed seed for consistent data
        var result = new List<Customer>();

        for (int i = 1; i <= 47; i++)
        {
            var firstName = firstNames[random.Next(firstNames.Length)];
            var lastName = lastNames[random.Next(lastNames.Length)];
            result.Add(new Customer
            {
                Id = i,
                Name = $"{firstName} {lastName}",
                Email = $"{firstName.ToLower()}.{lastName.ToLower()}@example.com",
                Company = companies[random.Next(companies.Length)],
                Avatar = $"https://i.pravatar.cc/40?img={i}",
                Orders = random.Next(100, 5000),
                LastOrder = DateTime.Now.AddDays(-random.Next(1, 365)),
                Status = statuses[random.Next(statuses.Length)]
            });
        }

        return result;
    }

    public class Customer
    {
        public int Id { get; set; }
        public string Name { get; set; } = "";
        public string Email { get; set; } = "";
        public string Company { get; set; } = "";
        public string Avatar { get; set; } = "";
        public decimal Orders { get; set; }
        public DateTime LastOrder { get; set; }
        public string Status { get; set; } = "";
    }
}
