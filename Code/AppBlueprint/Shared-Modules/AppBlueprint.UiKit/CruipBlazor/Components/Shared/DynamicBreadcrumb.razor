@* Dynamic Breadcrumb component with automatic route detection *@
@inject NavigationManager Navigation
@implements IDisposable

<nav class="@ContainerClass" aria-label="Breadcrumb">
    <ol class="flex items-center flex-wrap gap-1">
        @* Home link *@
        <li class="flex items-center">
            <a href="/" class="@GetLinkClasses(0)">
                @if (ShowHomeIcon)
                {
                    <svg class="shrink-0 fill-current @GetIconClasses(0)" width="16" height="16" viewBox="0 0 16 16">
                        <path d="M8.354 1.146a.5.5 0 0 0-.708 0l-6 6A.5.5 0 0 0 1.5 7.5v7a.5.5 0 0 0 .5.5h4.5a.5.5 0 0 0 .5-.5v-4h2v4a.5.5 0 0 0 .5.5H14a.5.5 0 0 0 .5-.5v-7a.5.5 0 0 0-.146-.354L13 5.793V2.5a.5.5 0 0 0-.5-.5h-1a.5.5 0 0 0-.5.5v1.293L8.354 1.146ZM2.5 14V7.707l5.5-5.5 5.5 5.5V14H10v-4a.5.5 0 0 0-.5-.5h-3a.5.5 0 0 0-.5.5v4H2.5Z"/>
                    </svg>
                }
                else
                {
                    <span>Home</span>
                }
            </a>
        </li>

        @for (int i = 0; i < BreadcrumbItems.Count; i++)
        {
            var item = BreadcrumbItems[i];
            var isLast = i == BreadcrumbItems.Count - 1;
            var index = i + 1;

            <li class="flex items-center">
                @* Separator *@
                <svg class="shrink-0 mx-2 fill-current text-gray-400 dark:text-gray-500" width="8" height="8" viewBox="0 0 8 8">
                    @if (SeparatorStyle == "chevron")
                    {
                        <path d="M2 0l4 4-4 4" fill="none" stroke="currentColor" stroke-width="1.5"/>
                    }
                    else if (SeparatorStyle == "arrow")
                    {
                        <path d="M1 0l4 4-4 4"/>
                    }
                    else
                    {
                        <circle cx="4" cy="4" r="1.5"/>
                    }
                </svg>

                @if (isLast)
                {
                    <span class="@GetCurrentClasses()">@item.Label</span>
                }
                else
                {
                    <a href="@item.Href" class="@GetLinkClasses(index)">@item.Label</a>
                }
            </li>
        }
    </ol>
</nav>

@code {
    [Parameter] public List<BreadcrumbItem>? Items { get; set; }
    [Parameter] public bool AutoGenerate { get; set; } = true;
    [Parameter] public bool ShowHomeIcon { get; set; } = true;
    [Parameter] public string SeparatorStyle { get; set; } = "chevron"; // chevron, arrow, dot
    [Parameter] public string? ContainerClass { get; set; }
    [Parameter] public Dictionary<string, string>? RouteLabels { get; set; }

    private List<BreadcrumbItem> BreadcrumbItems { get; set; } = new();

    protected override void OnInitialized()
    {
        Navigation.LocationChanged += OnLocationChanged;
        UpdateBreadcrumbs();
    }

    protected override void OnParametersSet()
    {
        UpdateBreadcrumbs();
    }

    private void OnLocationChanged(object? sender, LocationChangedEventArgs e)
    {
        UpdateBreadcrumbs();
        StateHasChanged();
    }

    private void UpdateBreadcrumbs()
    {
        if (Items != null && Items.Any())
        {
            BreadcrumbItems = Items;
            return;
        }

        if (!AutoGenerate)
        {
            BreadcrumbItems = new();
            return;
        }

        // Auto-generate from current URL
        var uri = new Uri(Navigation.Uri);
        var segments = uri.AbsolutePath.Split('/', StringSplitOptions.RemoveEmptyEntries);

        BreadcrumbItems = new();
        var currentPath = "";

        foreach (var segment in segments)
        {
            currentPath += "/" + segment;
            var label = GetLabelForSegment(segment);
            BreadcrumbItems.Add(new BreadcrumbItem
            {
                Label = label,
                Href = currentPath
            });
        }
    }

    private string GetLabelForSegment(string segment)
    {
        // Check custom route labels first
        if (RouteLabels != null && RouteLabels.TryGetValue(segment, out var customLabel))
        {
            return customLabel;
        }

        // Default label mappings for common routes
        var defaultLabels = new Dictionary<string, string>(StringComparer.OrdinalIgnoreCase)
        {
            { "dashboard", "Dashboard" },
            { "analytics", "Analytics" },
            { "fintech", "Fintech" },
            { "ecommerce", "E-Commerce" },
            { "customers", "Customers" },
            { "orders", "Orders" },
            { "invoices", "Invoices" },
            { "shop", "Shop" },
            { "community", "Community" },
            { "users", "Users" },
            { "profile", "Profile" },
            { "feed", "Feed" },
            { "forum", "Forum" },
            { "finance", "Finance" },
            { "cards", "Cards" },
            { "transactions", "Transactions" },
            { "settings", "Settings" },
            { "account", "Account" },
            { "notifications", "Notifications" },
            { "apps", "Apps" },
            { "billing", "Billing" },
            { "messages", "Messages" },
            { "inbox", "Inbox" },
            { "calendar", "Calendar" },
            { "campaigns", "Campaigns" },
            { "forms", "Forms" },
            { "modals", "Modals" }
        };

        if (defaultLabels.TryGetValue(segment, out var label))
        {
            return label;
        }

        // Convert segment to title case
        return System.Globalization.CultureInfo.CurrentCulture.TextInfo.ToTitleCase(
            segment.Replace("-", " ").Replace("_", " ")
        );
    }

    private string GetLinkClasses(int index)
    {
        return "text-sm font-medium text-gray-500 dark:text-gray-400 hover:text-violet-500 dark:hover:text-violet-400 transition-colors";
    }

    private string GetCurrentClasses()
    {
        return "text-sm font-medium text-gray-800 dark:text-gray-100";
    }

    private string GetIconClasses(int index)
    {
        return "text-gray-500 dark:text-gray-400";
    }

    public void Dispose()
    {
        Navigation.LocationChanged -= OnLocationChanged;
    }

    public class BreadcrumbItem
    {
        public string Label { get; set; } = "";
        public string Href { get; set; } = "";
    }
}
