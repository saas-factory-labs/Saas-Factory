@* Bar Chart Card component using Blazorise.Charts *@
@using Blazorise.Charts

<div class="@GetContainerClasses()">
    @* Header *@
    @if (!string.IsNullOrEmpty(Title) || HeaderActions != null)
    {
        <div class="flex items-center justify-between mb-4">
            <div>
                @if (!string.IsNullOrEmpty(Title))
                {
                    <h3 class="text-lg font-semibold text-gray-800 dark:text-gray-100">@Title</h3>
                }
                @if (!string.IsNullOrEmpty(Subtitle))
                {
                    <p class="text-sm text-gray-500 dark:text-gray-400">@Subtitle</p>
                }
            </div>
            @if (HeaderActions != null)
            {
                @HeaderActions
            }
        </div>
    }

    @* Chart *@
    <div style="height: @Height;">
        <BarChart @ref="chart" TItem="double" Options="@chartOptions" />
    </div>

    @* Legend *@
    @if (ShowLegend && Datasets != null && Datasets.Any())
    {
        <div class="flex flex-wrap items-center gap-4 mt-4 pt-4 border-t border-gray-200 dark:border-gray-700">
            @foreach (var dataset in Datasets)
            {
                <div class="flex items-center gap-2">
                    <span class="w-3 h-3 rounded" style="background-color: @dataset.Color"></span>
                    <span class="text-sm text-gray-600 dark:text-gray-400">@dataset.Label</span>
                </div>
            }
        </div>
    }
</div>

@code {
    [Parameter] public string? Title { get; set; }
    [Parameter] public string? Subtitle { get; set; }
    [Parameter] public string Height { get; set; } = "300px";
    [Parameter] public bool Horizontal { get; set; } = false;
    [Parameter] public bool Stacked { get; set; } = false;
    [Parameter] public bool ShowLegend { get; set; } = true;
    [Parameter] public List<string>? Labels { get; set; }
    [Parameter] public List<ChartDataset>? Datasets { get; set; }
    [Parameter] public RenderFragment? HeaderActions { get; set; }
    [Parameter] public string? Class { get; set; }

    private BarChart<double>? chart;
    private BarChartOptions chartOptions = new()
    {
        Responsive = true,
        MaintainAspectRatio = false
    };

    protected override void OnParametersSet()
    {
        // Configure horizontal mode via IndexAxis
        if (Horizontal)
        {
            chartOptions.IndexAxis = "y";
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && Labels != null && Datasets != null && chart != null)
        {
            var datasets = Datasets.Select(d => new BarChartDataset<double>
            {
                Label = d.Label,
                Data = d.Data,
                BackgroundColor = d.Color,
                BorderColor = d.BorderColor ?? d.Color,
                BorderWidth = 1,
                BorderRadius = 4
            }).ToArray();

            await chart.Clear();
            await chart.AddLabelsDatasetsAndUpdate(Labels, datasets);
        }
    }

    private string GetContainerClasses()
    {
        return $"bg-white dark:bg-gray-800 rounded-xl shadow-sm p-5 {Class}".Trim();
    }

    public class ChartDataset
    {
        public string Label { get; set; } = "";
        public List<double> Data { get; set; } = new();
        public string Color { get; set; } = "#8B5CF6";
        public string? BorderColor { get; set; }
    }
}
