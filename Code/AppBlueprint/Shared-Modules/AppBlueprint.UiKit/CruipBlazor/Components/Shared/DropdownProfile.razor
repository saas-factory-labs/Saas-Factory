@inject IJSRuntime JS

<div class="relative inline-flex" @ref="dropdownRef">
    <button @ref="triggerRef"
            class="inline-flex justify-center items-center group"
            aria-haspopup="true"
            @onclick="ToggleDropdown"
            @onclick:preventDefault
            aria-expanded="@dropdownOpen">
        <img class="w-8 h-8 rounded-full" src="_content/AppBlueprint.UiKit/cruip/images/user-avatar-32.png" width="32" height="32" alt="User"/>
        <div class="flex items-center truncate">
            <span class="truncate ml-2 text-sm font-medium text-gray-600 dark:text-gray-100 group-hover:text-gray-800 dark:group-hover:text-white">Acme Inc.</span>
            <svg class="w-3 h-3 shrink-0 ml-1 fill-current text-gray-400 dark:text-gray-500" viewBox="0 0 12 12">
                <path d="M5.9 11.4L.5 6l1.4-1.4 4 4 4-4L11.3 6z"/>
            </svg>
        </div>
    </button>
    @if (dropdownOpen)
    {
        <div class="origin-top-right z-10 absolute top-full min-w-44 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700/60 py-1.5 rounded-lg shadow-lg overflow-hidden mt-1 @(Align == "right" ? "right-0" : "left-0")">
            <div class="pt-0.5 pb-2 px-3 mb-1 border-b border-gray-200 dark:border-gray-700/60">
                <div class="font-medium text-gray-800 dark:text-gray-100">Acme Inc.</div>
                <div class="text-xs text-gray-500 dark:text-gray-400 italic">Administrator</div>
            </div>
            <ul>
                <li>
                    <a class="font-medium text-sm text-violet-500 hover:text-violet-600 dark:hover:text-violet-400 flex items-center py-1 px-3" href="/settings/account" @onclick="CloseDropdown">Settings</a>
                </li>
                <li>
                    <a class="font-medium text-sm text-violet-500 hover:text-violet-600 dark:hover:text-violet-400 flex items-center py-1 px-3" href="/signin" @onclick="CloseDropdown">Sign Out</a>
                </li>
            </ul>
        </div>
    }
</div>

@code {
    [Parameter] public string? Align { get; set; }

    private bool dropdownOpen;
    private ElementReference dropdownRef;
    private ElementReference triggerRef;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await JS.InvokeVoidAsync("dropdownManager.initialize", dropdownRef, triggerRef, DotNetObjectReference.Create(this));
        }
    }

    [JSInvokable]
    public void CloseFromJS()
    {
        dropdownOpen = false;
        StateHasChanged();
    }

    private void ToggleDropdown()
    {
        dropdownOpen = !dropdownOpen;
    }

    private void CloseDropdown()
    {
        dropdownOpen = false;
    }

}
