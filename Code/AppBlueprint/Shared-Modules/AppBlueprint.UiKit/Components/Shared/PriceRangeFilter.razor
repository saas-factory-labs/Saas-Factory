@namespace AppBlueprint.UiKit.Components.Shared

@* Price range filter with dropdown - reusable for budget filters, deal value ranges, etc. *@

<FilterGroup Title="@Title" Class="@Class">
    @if (PriceRanges.Any() && string.IsNullOrEmpty(SelectedRange) == false)
    {
        <label class="sr-only">@Title</label>
        <select class="form-select w-full" @bind="SelectedRange" @bind:after="OnRangeChanged">
            @foreach (var range in PriceRanges)
            {
                <option value="@range.Value">@range.Label</option>
            }
        </select>
    }
    else
    {
        <div class="mt-4 px-2">
            <div class="flex justify-between text-xs font-medium text-gray-500 dark:text-gray-400 mb-2">
                <span>$@CurrentMin</span>
                <span>$@CurrentMax</span>
            </div>
            <div class="relative h-2 bg-gray-200 dark:bg-gray-700 rounded-full">
                @* This is a simplified visual representation of a range slider *@
                <div class="absolute h-full bg-violet-500 rounded-full" 
                     style="left: @(GetPercentage(CurrentMin))%; right: @(100 - GetPercentage(CurrentMax))%"></div>
                
                <input type="range" 
                       min="@MinValue" 
                       max="@MaxValue" 
                       @bind="CurrentMin" 
                       @bind:after="OnSliderChanged"
                       class="absolute w-full h-full opacity-0 cursor-pointer z-10" />
                <input type="range" 
                       min="@MinValue" 
                       max="@MaxValue" 
                       @bind="CurrentMax" 
                       @bind:after="OnSliderChanged"
                       class="absolute w-full h-full opacity-0 cursor-pointer z-10" />
            </div>
            <div class="mt-4 flex gap-2">
                <input type="number" 
                       class="form-input w-full text-xs" 
                       @bind="CurrentMin" 
                       @bind:after="OnSliderChanged" />
                <span class="text-gray-400">-</span>
                <input type="number" 
                       class="form-input w-full text-xs" 
                       @bind="CurrentMax" 
                       @bind:after="OnSliderChanged" />
            </div>
        </div>
    }
</FilterGroup>

@code {
    /// <summary>
    /// Title of the filter section
    /// </summary>
    [Parameter]
    public string Title { get; set; } = "Price Range";

    /// <summary>
    /// List of price ranges to display
    /// </summary>
    [Parameter]
    public List<PriceRangeItem> PriceRanges { get; set; } = new();

    /// <summary>
    /// Minimum possible value
    /// </summary>
    [Parameter]
    public int MinValue { get; set; } = 0;

    /// <summary>
    /// Maximum possible value
    /// </summary>
    [Parameter]
    public int MaxValue { get; set; } = 1000;

    /// <summary>
    /// Currently selected minimum value
    /// </summary>
    [Parameter]
    public int CurrentMin { get; set; } = 0;

    /// <summary>
    /// Currently selected maximum value
    /// </summary>
    [Parameter]
    public int CurrentMax { get; set; } = 1000;

    /// <summary>
    /// Event callback when range changes
    /// </summary>
    [Parameter]
    public EventCallback<(int, int)> OnRangeChange { get; set; }

    /// <summary>
    /// Currently selected range value
    /// </summary>
    [Parameter]
    public string? SelectedRange { get; set; }

    /// <summary>
    /// Event callback when a range is selected
    /// </summary>
    [Parameter]
    public EventCallback<string> SelectedRangeChanged { get; set; }

    /// <summary>
    /// Event callback when a range is selected (with full item details)
    /// </summary>
    [Parameter]
    public EventCallback<PriceRangeItem> OnRangeSelected { get; set; }

    /// <summary>
    /// Additional CSS classes
    /// </summary>
    [Parameter]
    public string? Class { get; set; }

    protected override void OnInitialized()
    {
        // If no ranges provided AND no custom min/max bounds are used, use default price ranges
        if (PriceRanges.Count == 0 && MinValue == 0 && MaxValue == 1000 && CurrentMin == 0 && CurrentMax == 1000)
        {
            PriceRanges = GetDefaultPriceRanges();
        }

        // Set initial selection if not set and we have ranges
        if (PriceRanges.Any() && string.IsNullOrEmpty(SelectedRange))
        {
            SelectedRange = PriceRanges[0].Value;
        }
    }

    private double GetPercentage(int value)
    {
        var range = MaxValue - MinValue;
        if (range <= 0) return 0;
        return (double)(value - MinValue) / range * 100;
    }

    private async Task OnSliderChanged()
    {
        if (CurrentMin > CurrentMax)
        {
            var temp = CurrentMin;
            CurrentMin = CurrentMax;
            CurrentMax = temp;
        }

        await OnRangeChange.InvokeAsync((CurrentMin, CurrentMax));
    }

    private async Task OnRangeChanged()
    {
        await SelectedRangeChanged.InvokeAsync(SelectedRange);
        
        PriceRangeItem? selectedItem = PriceRanges.FirstOrDefault(r => r.Value == SelectedRange);
        if (selectedItem != null)
        {
            await OnRangeSelected.InvokeAsync(selectedItem);
        }
    }

    private List<PriceRangeItem> GetDefaultPriceRanges()
    {
        return new List<PriceRangeItem>
        {
            new() { Label = "Less than $20", Value = "0-20", MinValue = 0, MaxValue = 20 },
            new() { Label = "$20 - $40", Value = "20-40", MinValue = 20, MaxValue = 40 },
            new() { Label = "$40 - $80", Value = "40-80", MinValue = 40, MaxValue = 80 },
            new() { Label = "More than $80", Value = "80+", MinValue = 80, MaxValue = null }
        };
    }

    /// <summary>
    /// Model representing a price range item
    /// </summary>
    public sealed class PriceRangeItem
    {
        public string Label { get; set; } = string.Empty;
        public string Value { get; set; } = string.Empty;
        public decimal MinValue { get; set; }
        public decimal? MaxValue { get; set; }
    }
}
