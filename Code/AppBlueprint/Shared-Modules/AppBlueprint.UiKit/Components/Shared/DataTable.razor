@* Data table component with sorting, filtering, selection, and pagination *@
@typeparam TItem

<div class="bg-white dark:bg-gray-800 shadow-xs rounded-xl">
    @* Header with search and bulk actions *@
    <div class="px-5 py-4">
        <div class="flex flex-wrap justify-between items-center gap-3">
            <div class="flex items-center gap-3">
                @if (ShowSearch)
                {
                    <div class="relative">
                        <input type="text"
                               class="form-input pl-9 w-64 bg-white dark:bg-gray-800 border-gray-200 dark:border-gray-700/60 focus:border-violet-300 dark:focus:border-violet-500/50 text-sm"
                               placeholder="@SearchPlaceholder"
                               @bind="SearchTerm"
                               @bind:event="oninput"
                               @onkeyup="OnSearchChanged" />
                        <svg class="absolute left-3 top-1/2 -translate-y-1/2 fill-current text-gray-400 dark:text-gray-500" width="16" height="16" viewBox="0 0 16 16">
                            <path d="M7 14c-3.86 0-7-3.14-7-7s3.14-7 7-7 7 3.14 7 7-3.14 7-7 7zM7 2C4.243 2 2 4.243 2 7s2.243 5 5 5 5-2.243 5-5-2.243-5-5-5z" />
                            <path d="M15.707 14.293L13.314 11.9a8.019 8.019 0 01-1.414 1.414l2.393 2.393a.997.997 0 001.414 0 .999.999 0 000-1.414z" />
                        </svg>
                    </div>
                }
                @if (SelectedItems.Any() && BulkActions != null)
                {
                    <div class="flex items-center gap-2">
                        <span class="text-sm text-gray-500 dark:text-gray-400">
                            @SelectedItems.Count selected
                        </span>
                        @BulkActions
                    </div>
                }
            </div>
            @if (HeaderActions != null)
            {
                <div class="flex items-center gap-2">
                    @HeaderActions
                </div>
            }
        </div>
    </div>

    @* Table *@
    <div class="overflow-x-auto">
        <table class="table-auto w-full dark:text-gray-300">
            <thead class="text-xs font-semibold uppercase text-gray-500 dark:text-gray-400 bg-gray-50 dark:bg-gray-900/20 border-t border-b border-gray-100 dark:border-gray-700/60">
                <tr>
                    @if (ShowSelection)
                    {
                        <th class="px-2 first:pl-5 last:pr-5 py-3 whitespace-nowrap w-px">
                            <div class="flex items-center">
                                <input type="checkbox"
                                       class="form-checkbox"
                                       checked="@IsAllSelected"
                                       @onchange="ToggleSelectAll" />
                            </div>
                        </th>
                    }
                    @foreach (var column in Columns)
                    {
                        <th class="px-2 first:pl-5 last:pr-5 py-3 whitespace-nowrap @(column.Sortable ? "cursor-pointer" : "")"
                            @onclick="() => OnSort(column)">
                            <div class="flex items-center font-semibold text-left">
                                <span>@column.Title</span>
                                @if (column.Sortable && SortColumn == column.PropertyName)
                                {
                                    <svg class="shrink-0 ml-1 fill-current text-gray-400 dark:text-gray-500 @(SortDescending ? "rotate-180" : "")" width="8" height="8" viewBox="0 0 8 8">
                                        <path d="M4 0L0 4h8z" />
                                    </svg>
                                }
                            </div>
                        </th>
                    }
                    @if (RowActions != null)
                    {
                        <th class="px-2 first:pl-5 last:pr-5 py-3 whitespace-nowrap">
                            <span class="sr-only">Actions</span>
                        </th>
                    }
                </tr>
            </thead>
            <tbody class="text-sm divide-y divide-gray-100 dark:divide-gray-700/60">
                @if (!FilteredItems.Any())
                {
                    <tr>
                        <td colspan="@GetColumnCount()" class="px-5 py-8 text-center text-gray-500 dark:text-gray-400">
                            @if (!string.IsNullOrEmpty(SearchTerm))
                            {
                                <span>No results found for "@SearchTerm"</span>
                            }
                            else
                            {
                                <span>@EmptyMessage</span>
                            }
                        </td>
                    </tr>
                }
                else
                {
                    @foreach (var item in PagedItems)
                    {
                        <tr class="@(IsSelected(item) ? "bg-violet-50 dark:bg-violet-500/10" : "")">
                            @if (ShowSelection)
                            {
                                <td class="px-2 first:pl-5 last:pr-5 py-3 whitespace-nowrap w-px">
                                    <div class="flex items-center">
                                        <input type="checkbox"
                                               class="form-checkbox"
                                               checked="@IsSelected(item)"
                                               @onchange="() => ToggleSelection(item)" />
                                    </div>
                                </td>
                            }
                            @if (RowTemplate != null)
                            {
                                @RowTemplate(item)
                            }
                            @if (RowActions != null)
                            {
                                <td class="px-2 first:pl-5 last:pr-5 py-3 whitespace-nowrap w-px">
                                    @RowActions(item)
                                </td>
                            }
                        </tr>
                    }
                }
            </tbody>
        </table>
    </div>

    @* Pagination *@
    @if (ShowPagination && TotalPages > 1)
    {
        <div class="px-5 py-4 border-t border-gray-100 dark:border-gray-700/60">
            <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
                <div class="text-sm text-gray-500 dark:text-gray-400">
                    Showing <span class="font-medium text-gray-600 dark:text-gray-300">@StartIndex</span> to <span class="font-medium text-gray-600 dark:text-gray-300">@EndIndex</span> of <span class="font-medium text-gray-600 dark:text-gray-300">@FilteredItems.Count()</span> results
                </div>
                <nav class="flex items-center gap-1" aria-label="Pagination">
                    <button class="@GetPaginationButtonClasses(CurrentPage == 1)"
                            disabled="@(CurrentPage == 1)"
                            @onclick="() => GoToPage(CurrentPage - 1)">
                        <span class="sr-only">Previous</span>
                        <svg class="fill-current" width="4" height="7" viewBox="0 0 4 7">
                            <path d="M3.7.3c.4.4.4 1 0 1.4L1.4 4l2.3 2.3c.4.4.4 1 0 1.4-.4.4-1 .4-1.4 0L.3 5.7c-.4-.4-.4-1 0-1.4L2.3.3c.4-.4 1-.4 1.4 0z" />
                        </svg>
                    </button>
                    @foreach (var pageNum in GetPageNumbers())
                    {
                        @if (pageNum == -1)
                        {
                            <span class="px-2 text-gray-400">...</span>
                        }
                        else
                        {
                            <button class="@GetPageNumberClasses(pageNum == CurrentPage)"
                                    @onclick="() => GoToPage(pageNum)">
                                @pageNum
                            </button>
                        }
                    }
                    <button class="@GetPaginationButtonClasses(CurrentPage == TotalPages)"
                            disabled="@(CurrentPage == TotalPages)"
                            @onclick="() => GoToPage(CurrentPage + 1)">
                        <span class="sr-only">Next</span>
                        <svg class="fill-current" width="4" height="7" viewBox="0 0 4 7">
                            <path d="M.3 6.7c-.4-.4-.4-1 0-1.4L2.6 3 .3.7C-.1.3-.1-.3.3-.7c.4-.4 1-.4 1.4 0l2 2c.4.4.4 1 0 1.4l-2 2c-.4.4-1 .4-1.4 0z" />
                        </svg>
                    </button>
                </nav>
            </div>
        </div>
    }
</div>

@code {
    [Parameter] public IEnumerable<TItem> Items { get; set; } = Enumerable.Empty<TItem>();
    [Parameter] public List<DataTableColumn> Columns { get; set; } = new();
    [Parameter] public RenderFragment<TItem>? RowTemplate { get; set; }
    [Parameter] public RenderFragment<TItem>? RowActions { get; set; }
    [Parameter] public RenderFragment? BulkActions { get; set; }
    [Parameter] public RenderFragment? HeaderActions { get; set; }
    [Parameter] public bool ShowSearch { get; set; } = true;
    [Parameter] public bool ShowSelection { get; set; } = true;
    [Parameter] public bool ShowPagination { get; set; } = true;
    [Parameter] public int PageSize { get; set; } = 10;
    [Parameter] public string SearchPlaceholder { get; set; } = "Search...";
    [Parameter] public string EmptyMessage { get; set; } = "No data available";
    [Parameter] public Func<TItem, string, bool>? SearchFilter { get; set; }
    [Parameter] public Func<TItem, object>? ItemKey { get; set; }
    [Parameter] public EventCallback<List<TItem>> SelectedItemsChanged { get; set; }

    private string SearchTerm { get; set; } = "";
    private string SortColumn { get; set; } = "";
    private bool SortDescending { get; set; } = false;
    private int CurrentPage { get; set; } = 1;
    private List<TItem> SelectedItems { get; set; } = new();

    private IEnumerable<TItem> FilteredItems => GetFilteredItems();
    private IEnumerable<TItem> SortedItems => GetSortedItems();
    private IEnumerable<TItem> PagedItems => GetPagedItems();
    private int TotalPages => (int)Math.Ceiling(FilteredItems.Count() / (double)PageSize);
    private int StartIndex => FilteredItems.Any() ? (CurrentPage - 1) * PageSize + 1 : 0;
    private int EndIndex => Math.Min(CurrentPage * PageSize, FilteredItems.Count());
    private bool IsAllSelected => FilteredItems.Any() && FilteredItems.All(i => IsSelected(i));

    private IEnumerable<TItem> GetFilteredItems()
    {
        if (string.IsNullOrWhiteSpace(SearchTerm) || SearchFilter == null)
            return Items;
        return Items.Where(item => SearchFilter(item, SearchTerm));
    }

    private IEnumerable<TItem> GetSortedItems()
    {
        if (string.IsNullOrEmpty(SortColumn))
            return FilteredItems;

        var column = Columns.FirstOrDefault(c => c.PropertyName == SortColumn);
        if (column?.SortFunc == null)
            return FilteredItems;

        return SortDescending
            ? FilteredItems.OrderByDescending(column.SortFunc)
            : FilteredItems.OrderBy(column.SortFunc);
    }

    private IEnumerable<TItem> GetPagedItems()
    {
        return SortedItems.Skip((CurrentPage - 1) * PageSize).Take(PageSize);
    }

    private void OnSort(DataTableColumn column)
    {
        if (!column.Sortable) return;

        if (SortColumn == column.PropertyName)
        {
            SortDescending = !SortDescending;
        }
        else
        {
            SortColumn = column.PropertyName;
            SortDescending = false;
        }
    }

    private void OnSearchChanged()
    {
        CurrentPage = 1;
        SelectedItems.Clear();
    }

    private void GoToPage(int page)
    {
        CurrentPage = Math.Clamp(page, 1, TotalPages);
    }

    private bool IsSelected(TItem item)
    {
        if (ItemKey == null) return SelectedItems.Contains(item);
        var key = ItemKey(item);
        return SelectedItems.Any(i => ItemKey(i)?.Equals(key) == true);
    }

    private async Task ToggleSelection(TItem item)
    {
        if (IsSelected(item))
        {
            if (ItemKey != null)
            {
                var key = ItemKey(item);
                SelectedItems.RemoveAll(i => ItemKey(i)?.Equals(key) == true);
            }
            else
            {
                SelectedItems.Remove(item);
            }
        }
        else
        {
            SelectedItems.Add(item);
        }
        await SelectedItemsChanged.InvokeAsync(SelectedItems);
    }

    private async Task ToggleSelectAll()
    {
        if (IsAllSelected)
        {
            SelectedItems.Clear();
        }
        else
        {
            SelectedItems = FilteredItems.ToList();
        }
        await SelectedItemsChanged.InvokeAsync(SelectedItems);
    }

    private int GetColumnCount()
    {
        var count = Columns.Count;
        if (ShowSelection) count++;
        if (RowActions != null) count++;
        return count;
    }

    private List<int> GetPageNumbers()
    {
        var pages = new List<int>();
        var maxVisible = 5;

        if (TotalPages <= maxVisible)
        {
            for (int i = 1; i <= TotalPages; i++)
                pages.Add(i);
        }
        else
        {
            pages.Add(1);
            if (CurrentPage > 3) pages.Add(-1); // ellipsis

            var start = Math.Max(2, CurrentPage - 1);
            var end = Math.Min(TotalPages - 1, CurrentPage + 1);

            for (int i = start; i <= end; i++)
                pages.Add(i);

            if (CurrentPage < TotalPages - 2) pages.Add(-1); // ellipsis
            pages.Add(TotalPages);
        }

        return pages;
    }

    private string GetPaginationButtonClasses(bool disabled)
    {
        var baseClasses = "inline-flex items-center justify-center rounded-lg leading-5 px-2.5 py-2 border";
        return disabled
            ? $"{baseClasses} border-gray-200 dark:border-gray-700/60 text-gray-300 dark:text-gray-600"
            : $"{baseClasses} border-gray-200 dark:border-gray-700/60 text-gray-600 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700/50";
    }

    private string GetPageNumberClasses(bool isActive)
    {
        var baseClasses = "inline-flex items-center justify-center rounded-lg leading-5 px-3.5 py-2";
        return isActive
            ? $"{baseClasses} bg-violet-500 text-white"
            : $"{baseClasses} text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700/50";
    }

    public class DataTableColumn
    {
        public string PropertyName { get; set; } = "";
        public string Title { get; set; } = "";
        public bool Sortable { get; set; } = false;
        public Func<TItem, object>? SortFunc { get; set; }
    }
}
