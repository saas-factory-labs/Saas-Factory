@* Dropdown menu component *@
@implements IDisposable

<div class="relative inline-flex @ContainerClass" @onclick:stopPropagation="true">
    @* Trigger *@
    <div @onclick="Toggle">
        @Trigger
    </div>

    @* Dropdown menu *@
    @if (IsOpen)
    {
        <div class="@GetMenuClasses()" @onclick:stopPropagation="@(!CloseOnItemClick)">
            @ChildContent
        </div>
    }
</div>

@code {
    [Parameter] public RenderFragment? Trigger { get; set; }
    [Parameter] public RenderFragment? ChildContent { get; set; }
    [Parameter] public bool IsOpen { get; set; } = false;
    [Parameter] public EventCallback<bool> IsOpenChanged { get; set; }
    [Parameter] public string Align { get; set; } = "left"; // left, right
    [Parameter] public string Position { get; set; } = "bottom"; // bottom, top
    [Parameter] public bool CloseOnItemClick { get; set; } = true;
    [Parameter] public string? ContainerClass { get; set; }

    private System.Timers.Timer? _closeTimer;

    protected override void OnInitialized()
    {
        _closeTimer = new System.Timers.Timer(100);
        _closeTimer.Elapsed += async (_, _) =>
        {
            _closeTimer.Stop();
            if (IsOpen)
            {
                await InvokeAsync(async () =>
                {
                    IsOpen = false;
                    await IsOpenChanged.InvokeAsync(false);
                    StateHasChanged();
                });
            }
        };
    }

    private string GetMenuClasses()
    {
        var alignClass = Align == "right" ? "right-0" : "left-0";
        var positionClass = Position == "top" ? "bottom-full mb-1" : "top-full mt-1";

        return $"absolute {positionClass} {alignClass} z-50 min-w-44 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700/60 rounded-lg shadow-lg overflow-hidden py-1.5";
    }

    private async Task Toggle()
    {
        IsOpen = !IsOpen;
        await IsOpenChanged.InvokeAsync(IsOpen);
    }

    public async Task Close()
    {
        IsOpen = false;
        await IsOpenChanged.InvokeAsync(false);
    }

    public async Task Open()
    {
        IsOpen = true;
        await IsOpenChanged.InvokeAsync(true);
    }

    public void Dispose()
    {
        _closeTimer?.Dispose();
    }
}
