@* Bottom Navigation component for mobile *@
@using Microsoft.AspNetCore.Components.Routing
@inject NavigationManager Navigation
@implements IDisposable

<nav class="@GetContainerClasses()">
    <div class="flex items-center justify-around h-full max-w-lg mx-auto">
        @foreach (var item in Items)
        {
            var isActive = IsItemActive(item);
            <a href="@item.Href"
               class="@GetItemClasses(isActive)"
               @onclick="() => OnItemClick(item)"
               @onclick:preventDefault="@(item.OnClick.HasDelegate)">
                <span class="@GetIconClasses(isActive)">
                    @if (item.Icon != null)
                    {
                        @item.Icon
                    }
                    else
                    {
                        @GetDefaultIcon(item.Id)
                    }
                </span>
                @if (ShowLabels)
                {
                    <span class="@GetLabelClasses(isActive)">@item.Label</span>
                }
                @if (item.Badge > 0)
                {
                    <span class="@GetBadgeClasses()">
                        @(item.Badge > 99 ? "99+" : item.Badge.ToString())
                    </span>
                }
            </a>
        }
    </div>
</nav>

@code {
    [Parameter] public List<BottomNavItem> Items { get; set; } = new();
    [Parameter] public bool ShowLabels { get; set; } = true;
    [Parameter] public string Variant { get; set; } = "default"; // default, floating, minimal
    [Parameter] public bool HideOnDesktop { get; set; } = true;

    private string currentUrl = "";

    protected override void OnInitialized()
    {
        currentUrl = Navigation.Uri;
        Navigation.LocationChanged += OnLocationChanged;

        // Set default items if none provided
        if (!Items.Any())
        {
            Items = new List<BottomNavItem>
            {
                new() { Id = "home", Label = "Home", Href = "/" },
                new() { Id = "search", Label = "Search", Href = "/search" },
                new() { Id = "notifications", Label = "Alerts", Href = "/notifications", Badge = 3 },
                new() { Id = "messages", Label = "Messages", Href = "/messages" },
                new() { Id = "profile", Label = "Profile", Href = "/profile" }
            };
        }
    }

    private void OnLocationChanged(object? sender, LocationChangedEventArgs e)
    {
        currentUrl = e.Location;
        StateHasChanged();
    }

    private bool IsItemActive(BottomNavItem item)
    {
        if (string.IsNullOrEmpty(item.Href)) return false;

        var uri = new Uri(currentUrl);
        var itemPath = item.Href.TrimEnd('/');
        var currentPath = uri.AbsolutePath.TrimEnd('/');

        if (itemPath == "/" || itemPath == "")
            return currentPath == "/" || currentPath == "";

        return currentPath.StartsWith(itemPath, StringComparison.OrdinalIgnoreCase);
    }

    private async Task OnItemClick(BottomNavItem item)
    {
        if (item.OnClick.HasDelegate)
        {
            await item.OnClick.InvokeAsync();
        }
    }

    private string GetContainerClasses()
    {
        var hideClass = HideOnDesktop ? "lg:hidden" : "";

        var variantClasses = Variant switch
        {
            "floating" => "fixed bottom-4 left-4 right-4 h-16 bg-white dark:bg-gray-800 rounded-2xl shadow-lg border border-gray-200 dark:border-gray-700 z-50",
            "minimal" => "fixed bottom-0 left-0 right-0 h-14 bg-white/80 dark:bg-gray-800/80 backdrop-blur-md border-t border-gray-200/50 dark:border-gray-700/50 z-50",
            _ => "fixed bottom-0 left-0 right-0 h-16 bg-white dark:bg-gray-800 border-t border-gray-200 dark:border-gray-700 z-50"
        };

        return $"{variantClasses} {hideClass}";
    }

    private string GetItemClasses(bool isActive)
    {
        var baseClasses = "relative flex flex-col items-center justify-center flex-1 h-full transition-colors";

        return isActive
            ? $"{baseClasses} text-violet-600 dark:text-violet-400"
            : $"{baseClasses} text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300";
    }

    private string GetIconClasses(bool isActive)
    {
        var baseClasses = "flex items-center justify-center";

        if (Variant == "minimal")
        {
            return isActive
                ? $"{baseClasses} w-10 h-10 rounded-full bg-violet-100 dark:bg-violet-500/20"
                : baseClasses;
        }

        return baseClasses;
    }

    private string GetLabelClasses(bool isActive)
    {
        var baseClasses = "text-xs mt-1";

        return isActive
            ? $"{baseClasses} font-medium"
            : baseClasses;
    }

    private string GetBadgeClasses()
    {
        return "absolute -top-1 -right-1 flex items-center justify-center min-w-[18px] h-[18px] px-1 text-[10px] font-bold text-white bg-red-500 rounded-full";
    }

    private RenderFragment GetDefaultIcon(string id) => id switch
    {
        "home" => @<svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" /></svg>,
        "search" => @<svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg>,
        "notifications" => @<svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" /></svg>,
        "messages" => @<svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" /></svg>,
        "profile" => @<svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" /></svg>,
        _ => @<svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 12h16M4 18h16" /></svg>
    };

    public void Dispose()
    {
        Navigation.LocationChanged -= OnLocationChanged;
    }

    public class BottomNavItem
    {
        public string Id { get; set; } = "";
        public string Label { get; set; } = "";
        public string Href { get; set; } = "#";
        public RenderFragment? Icon { get; set; }
        public int Badge { get; set; }
        public EventCallback OnClick { get; set; }
    }
}
