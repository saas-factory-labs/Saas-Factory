@* Doughnut/Pie Chart Card component using Blazorise.Charts *@
@using Blazorise.Charts

<div class="@GetContainerClasses()">
    @* Header *@
    @if (!string.IsNullOrEmpty(Title) || HeaderActions != null)
    {
        <div class="flex items-center justify-between mb-4">
            <div>
                @if (!string.IsNullOrEmpty(Title))
                {
                    <h3 class="text-lg font-semibold text-gray-800 dark:text-gray-100">@Title</h3>
                }
                @if (!string.IsNullOrEmpty(Subtitle))
                {
                    <p class="text-sm text-gray-500 dark:text-gray-400">@Subtitle</p>
                }
            </div>
            @if (HeaderActions != null)
            {
                @HeaderActions
            }
        </div>
    }

    <div class="flex flex-col @(LegendPosition == "right" ? "md:flex-row" : "") items-center gap-6">
        @* Chart *@
        <div class="@GetChartContainerClasses()" style="height: @Height; width: @Height;">
            @if (Variant == "pie")
            {
                <PieChart @ref="pieChart" TItem="double" Options="@pieChartOptions" />
            }
            else
            {
                <DoughnutChart @ref="doughnutChart" TItem="double" Options="@doughnutChartOptions" />
            }

            @* Center content for doughnut *@
            @if (Variant == "doughnut" && CenterContent != null)
            {
                <div class="absolute inset-0 flex items-center justify-center pointer-events-none">
                    @CenterContent
                </div>
            }
        </div>

        @* Legend *@
        @if (ShowLegend && Data != null && Data.Any())
        {
            <div class="@GetLegendClasses()">
                @foreach (var (item, index) in Data.Select((d, i) => (d, i)))
                {
                    <div class="flex items-center gap-3 py-2">
                        <span class="w-3 h-3 rounded-full flex-shrink-0" style="background-color: @item.Color"></span>
                        <div class="flex-1 min-w-0">
                            <div class="text-sm font-medium text-gray-800 dark:text-gray-100">@item.Label</div>
                            @if (ShowValues)
                            {
                                <div class="text-xs text-gray-500 dark:text-gray-400">
                                    @item.Value.ToString("N0") (@GetPercentage(item.Value)%)
                                </div>
                            }
                        </div>
                    </div>
                }
            </div>
        }
    </div>
</div>

@code {
    [Parameter] public string? Title { get; set; }
    [Parameter] public string? Subtitle { get; set; }
    [Parameter] public string Variant { get; set; } = "doughnut"; // doughnut, pie
    [Parameter] public string Height { get; set; } = "200px";
    [Parameter] public string LegendPosition { get; set; } = "bottom"; // bottom, right
    [Parameter] public bool ShowLegend { get; set; } = true;
    [Parameter] public bool ShowValues { get; set; } = true;
    [Parameter] public List<ChartDataItem>? Data { get; set; }
    [Parameter] public RenderFragment? HeaderActions { get; set; }
    [Parameter] public RenderFragment? CenterContent { get; set; }
    [Parameter] public string? Class { get; set; }

    private DoughnutChart<double>? doughnutChart;
    private PieChart<double>? pieChart;

    private DoughnutChartOptions doughnutChartOptions = new()
    {
        Responsive = true,
        MaintainAspectRatio = true
    };

    private PieChartOptions pieChartOptions = new()
    {
        Responsive = true,
        MaintainAspectRatio = true
    };

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && Data != null && Data.Any())
        {
            var labels = Data.Select(d => d.Label).ToList();
            var values = Data.Select(d => d.Value).ToList();
            var colors = Data.Select(d => d.Color).ToList();

            if (Variant == "pie" && pieChart != null)
            {
                await pieChart.Clear();
                await pieChart.AddLabelsDatasetsAndUpdate(labels, new PieChartDataset<double>
                {
                    Data = values,
                    BackgroundColor = colors
                });
            }
            else if (doughnutChart != null)
            {
                await doughnutChart.Clear();
                await doughnutChart.AddLabelsDatasetsAndUpdate(labels, new DoughnutChartDataset<double>
                {
                    Data = values,
                    BackgroundColor = colors
                });
            }
        }
    }

    private string GetContainerClasses()
    {
        return $"bg-white dark:bg-gray-800 rounded-xl shadow-sm p-5 {Class}".Trim();
    }

    private string GetChartContainerClasses()
    {
        return "relative flex-shrink-0";
    }

    private string GetLegendClasses()
    {
        return LegendPosition == "right"
            ? "flex-1 space-y-1"
            : "w-full grid grid-cols-2 gap-2";
    }

    private string GetPercentage(double value)
    {
        if (Data == null || !Data.Any()) return "0";
        var total = Data.Sum(d => d.Value);
        return total > 0 ? (value / total * 100).ToString("0.#") : "0";
    }

    public class ChartDataItem
    {
        public string Label { get; set; } = "";
        public double Value { get; set; }
        public string Color { get; set; } = "#8B5CF6";
    }
}
