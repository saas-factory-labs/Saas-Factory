@* Command Palette component with keyboard navigation (Ctrl+K) *@
@using Microsoft.JSInterop
@inject IJSRuntime JS
@inject NavigationManager Navigation
@implements IDisposable

@if (IsOpen)
{
    @* Backdrop *@
    <div class="fixed inset-0 bg-gray-900/50 dark:bg-gray-900/80 z-50 transition-opacity"
         @onclick="Close">
    </div>

    @* Command palette *@
    <div class="fixed inset-0 z-50 overflow-y-auto p-4 sm:p-6 md:p-20">
        <div class="mx-auto max-w-xl transform divide-y divide-gray-200 dark:divide-gray-700 overflow-hidden rounded-xl bg-white dark:bg-gray-800 shadow-2xl ring-1 ring-gray-200 dark:ring-gray-700 transition-all">

            @* Search input *@
            <div class="relative">
                <svg class="pointer-events-none absolute left-4 top-3.5 h-5 w-5 text-gray-400 dark:text-gray-500" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M9 3.5a5.5 5.5 0 100 11 5.5 5.5 0 000-11zM2 9a7 7 0 1112.452 4.391l3.328 3.329a.75.75 0 11-1.06 1.06l-3.329-3.328A7 7 0 012 9z" clip-rule="evenodd"/>
                </svg>
                <input type="text"
                       class="h-12 w-full border-0 bg-transparent pl-11 pr-4 text-gray-900 dark:text-gray-100 placeholder:text-gray-400 dark:placeholder:text-gray-500 focus:ring-0 text-sm"
                       placeholder="Search commands, pages, or actions..."
                       @bind="searchQuery"
                       @bind:event="oninput"
                       @onkeydown="HandleKeyDown"
                       @ref="searchInput"/>
                <div class="absolute right-4 top-3.5">
                    <kbd class="hidden sm:inline-flex items-center gap-1 rounded border border-gray-200 dark:border-gray-600 bg-gray-100 dark:bg-gray-700 px-1.5 py-0.5 text-xs text-gray-500 dark:text-gray-400">
                        ESC
                    </kbd>
                </div>
            </div>

            @* Results *@
            @if (FilteredCommands.Any())
            {
                <div class="max-h-80 scroll-py-2 overflow-y-auto py-2">
                    @foreach (var group in FilteredCommands.GroupBy(c => c.Category))
                    {
                        <div class="px-4 py-2">
                            <h3 class="text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase">@group.Key</h3>
                        </div>
                        <ul>
                            @foreach (var command in group)
                            {
                                var isSelected = selectedIndex == GetCommandIndex(command);
                                <li>
                                    <button type="button"
                                            class="@GetCommandClasses(isSelected)"
                                            @onclick="() => ExecuteCommand(command)"
                                            @onmouseenter="() => selectedIndex = GetCommandIndex(command)">
                                        <span class="flex h-6 w-6 shrink-0 items-center justify-center rounded-md @GetIconBgClasses(command.Category)">
                                            @command.Icon
                                        </span>
                                        <div class="flex-1 text-left">
                                            <span class="block text-sm font-medium text-gray-900 dark:text-gray-100">@command.Label</span>
                                            @if (!string.IsNullOrEmpty(command.Description))
                                            {
                                                <span class="block text-xs text-gray-500 dark:text-gray-400">@command.Description</span>
                                            }
                                        </div>
                                        @if (!string.IsNullOrEmpty(command.Shortcut))
                                        {
                                            <kbd class="ml-3 flex-none text-xs text-gray-400 dark:text-gray-500">@command.Shortcut</kbd>
                                        }
                                    </button>
                                </li>
                            }
                        </ul>
                    }
                </div>
            }
            else if (!string.IsNullOrEmpty(searchQuery))
            {
                <div class="px-6 py-14 text-center">
                    <svg class="mx-auto h-6 w-6 text-gray-400 dark:text-gray-500" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m9-.75a9 9 0 11-18 0 9 9 0 0118 0zm-9 3.75h.008v.008H12v-.008z"/>
                    </svg>
                    <p class="mt-4 text-sm text-gray-900 dark:text-gray-100">No results found for "<strong>@searchQuery</strong>"</p>
                    <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">Try searching for something else.</p>
                </div>
            }

            @* Footer *@
            <div class="flex flex-wrap items-center bg-gray-50 dark:bg-gray-700/30 px-4 py-2.5 text-xs text-gray-500 dark:text-gray-400 gap-x-4">
                <span class="flex items-center gap-1">
                    <kbd class="rounded border border-gray-200 dark:border-gray-600 bg-white dark:bg-gray-700 px-1.5 py-0.5">↑</kbd>
                    <kbd class="rounded border border-gray-200 dark:border-gray-600 bg-white dark:bg-gray-700 px-1.5 py-0.5">↓</kbd>
                    to navigate
                </span>
                <span class="flex items-center gap-1">
                    <kbd class="rounded border border-gray-200 dark:border-gray-600 bg-white dark:bg-gray-700 px-1.5 py-0.5">↵</kbd>
                    to select
                </span>
                <span class="flex items-center gap-1">
                    <kbd class="rounded border border-gray-200 dark:border-gray-600 bg-white dark:bg-gray-700 px-1.5 py-0.5">esc</kbd>
                    to close
                </span>
            </div>
        </div>
    </div>
}

@code {
    [Parameter] public bool IsOpen { get; set; } = false;
    [Parameter] public EventCallback<bool> IsOpenChanged { get; set; }
    [Parameter] public List<CommandItem>? CustomCommands { get; set; }

    private ElementReference searchInput;
    private string searchQuery = "";
    private int selectedIndex;
    private DotNetObjectReference<CommandPalette>? objRef;

    private List<CommandItem> DefaultCommands => new()
    {
        // Navigation
        new() { Id = "nav-dashboard", Label = "Go to Dashboard", Description = "Main dashboard", Category = "Navigation", Href = "/", Shortcut = "G D", Icon = GetNavIcon() },
        new() { Id = "nav-customers", Label = "Go to Customers", Description = "Customer management", Category = "Navigation", Href = "/customers", Shortcut = "G C", Icon = GetNavIcon() },
        new() { Id = "nav-forms", Label = "Go to Forms", Description = "Form components", Category = "Navigation", Href = "/forms", Shortcut = "G F", Icon = GetNavIcon() },
        new() { Id = "nav-modals", Label = "Go to Modals", Description = "Modal examples", Category = "Navigation", Href = "/modals", Shortcut = "G M", Icon = GetNavIcon() },
        new() { Id = "nav-settings", Label = "Go to Settings", Description = "Account settings", Category = "Navigation", Href = "/settings/account", Icon = GetNavIcon() },

        // Actions
        new() { Id = "action-search", Label = "Search", Description = "Search anything", Category = "Actions", Shortcut = "Ctrl+K", Icon = GetActionIcon() },
        new() { Id = "action-theme", Label = "Toggle Theme", Description = "Switch light/dark mode", Category = "Actions", Shortcut = "Ctrl+T", Icon = GetActionIcon(), Action = ToggleTheme },
        new() { Id = "action-export", Label = "Export Data", Description = "Export dashboard data", Category = "Actions", Icon = GetActionIcon() },

        // Help
        new() { Id = "help-docs", Label = "Documentation", Description = "View documentation", Category = "Help", Icon = GetHelpIcon() },
        new() { Id = "help-support", Label = "Contact Support", Description = "Get help", Category = "Help", Icon = GetHelpIcon() }
    };

    private List<CommandItem> AllCommands => CustomCommands != null && CustomCommands.Any()
        ? CustomCommands.Concat(DefaultCommands).ToList()
        : DefaultCommands;

    private List<CommandItem> FilteredCommands
    {
        get
        {
            if (string.IsNullOrWhiteSpace(searchQuery))
                return AllCommands;

            var query = searchQuery.ToLower();
            return AllCommands
                .Where(c => c.Label.ToLower().Contains(query) ||
                            (c.Description?.ToLower().Contains(query) ?? false) ||
                            c.Category.ToLower().Contains(query))
                .ToList();
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            objRef = DotNetObjectReference.Create(this);
            await JS.InvokeVoidAsync("commandPaletteManager.initialize", objRef);
        }

        if (IsOpen)
        {
            await Task.Delay(50);
            try
            {
                await searchInput.FocusAsync();
            }
            catch
            {
            }
        }
    }

    [JSInvokable]
    public async Task OpenFromJS()
    {
        await Open();
        StateHasChanged();
    }

    public async Task Open()
    {
        searchQuery = "";
        selectedIndex = 0;
        IsOpen = true;
        await IsOpenChanged.InvokeAsync(true);
    }

    public async Task Close()
    {
        IsOpen = false;
        await IsOpenChanged.InvokeAsync(false);
    }

    private async Task HandleKeyDown(KeyboardEventArgs e)
    {
        switch (e.Key)
        {
            case "Escape":
                await Close();
                break;
            case "ArrowDown":
                selectedIndex = Math.Min(selectedIndex + 1, FilteredCommands.Count - 1);
                break;
            case "ArrowUp":
                selectedIndex = Math.Max(selectedIndex - 1, 0);
                break;
            case "Enter":
                if (FilteredCommands.Any() && selectedIndex < FilteredCommands.Count)
                {
                    await ExecuteCommand(FilteredCommands[selectedIndex]);
                }

                break;
        }
    }

    private async Task ExecuteCommand(CommandItem command)
    {
        await Close();

        if (command.Action != null)
        {
            await command.Action();
        }
        else if (!string.IsNullOrEmpty(command.Href))
        {
            Navigation.NavigateTo(command.Href);
        }
    }

    private int GetCommandIndex(CommandItem command)
    {
        return FilteredCommands.IndexOf(command);
    }

    private async Task ToggleTheme()
    {
        await JS.InvokeVoidAsync("themeManager.toggleDarkMode");
    }

    private string GetCommandClasses(bool isSelected)
    {
        var baseClasses = "flex w-full items-center gap-3 px-4 py-2 transition-colors";
        return isSelected
            ? $"{baseClasses} bg-violet-50 dark:bg-violet-500/10"
            : $"{baseClasses} hover:bg-gray-50 dark:hover:bg-gray-700/30";
    }

    private string GetIconBgClasses(string category)
    {
        return category switch
        {
            "Navigation" => "bg-violet-100 dark:bg-violet-500/20 text-violet-600 dark:text-violet-400",
            "Actions" => "bg-blue-100 dark:bg-blue-500/20 text-blue-600 dark:text-blue-400",
            "Help" => "bg-green-100 dark:bg-green-500/20 text-green-600 dark:text-green-400",
            _ => "bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-400"
        };
    }

    private static RenderFragment GetNavIcon() => @<svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                                      <path stroke-linecap="round" stroke-linejoin="round" d="M13 7l5 5m0 0l-5 5m5-5H6"/>
                                                  </svg>;
    private static RenderFragment GetActionIcon() => @<svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                                         <path stroke-linecap="round" stroke-linejoin="round" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                                                     </svg>;
    private static RenderFragment GetHelpIcon() => @<svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                                       <path stroke-linecap="round" stroke-linejoin="round" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                                   </svg>;

    public void Dispose()
    {
        objRef?.Dispose();
    }

    public class CommandItem
    {
        public string Id { get; set; } = "";
        public string Label { get; set; } = "";
        public string? Description { get; set; }
        public string Category { get; set; } = "General";
        public string? Href { get; set; }
        public string? Shortcut { get; set; }
        public RenderFragment? Icon { get; set; }
        public Func<Task>? Action { get; set; }
    }

}
