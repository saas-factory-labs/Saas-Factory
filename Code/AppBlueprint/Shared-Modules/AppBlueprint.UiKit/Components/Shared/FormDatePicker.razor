@* Date picker component with label and validation *@

<div class="@ContainerClass">
    @if (!string.IsNullOrEmpty(Label))
    {
        <label class="block text-sm font-medium mb-1 @LabelClasses" for="@Id">
            @Label
            @if (Required)
            {
                <span class="text-red-500">*</span>
            }
        </label>
    }
    <div class="relative">
        <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none text-gray-400 dark:text-gray-500">
            <svg class="fill-current" width="16" height="16" viewBox="0 0 16 16">
                <path d="M5 4a1 1 0 0 0-2 0v1H2a2 2 0 0 0-2 2v7a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2h-1V4a1 1 0 1 0-2 0v1H5V4zM2 9h12v5H2V9z" />
            </svg>
        </div>
        <input
            type="@InputType"
            id="@Id"
            name="@Name"
            class="@GetInputClasses()"
            value="@GetFormattedValue()"
            min="@GetFormattedMin()"
            max="@GetFormattedMax()"
            disabled="@Disabled"
            required="@Required"
            @onchange="OnChange"
            @attributes="AdditionalAttributes" />
    </div>
    @if (!string.IsNullOrEmpty(HelpText) && !HasError)
    {
        <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">@HelpText</p>
    }
    @if (HasError && !string.IsNullOrEmpty(ErrorMessage))
    {
        <p class="text-xs text-red-500 mt-1">@ErrorMessage</p>
    }
</div>

@code {
    [Parameter] public string? Id { get; set; }
    [Parameter] public string? Name { get; set; }
    [Parameter] public string? Label { get; set; }
    [Parameter] public DateTime? Value { get; set; }
    [Parameter] public EventCallback<DateTime?> ValueChanged { get; set; }
    [Parameter] public DateTime? MinDate { get; set; }
    [Parameter] public DateTime? MaxDate { get; set; }
    [Parameter] public string? HelpText { get; set; }
    [Parameter] public string? ErrorMessage { get; set; }
    [Parameter] public bool HasError { get; set; } = false;
    [Parameter] public bool Disabled { get; set; } = false;
    [Parameter] public bool Required { get; set; } = false;
    [Parameter] public bool IncludeTime { get; set; } = false;
    [Parameter] public string Size { get; set; } = "md"; // sm, md, lg
    [Parameter] public string? ContainerClass { get; set; }
    [Parameter(CaptureUnmatchedValues = true)] public Dictionary<string, object>? AdditionalAttributes { get; set; }

    private string InputType => IncludeTime ? "datetime-local" : "date";
    private string LabelClasses => HasError ? "text-red-500" : "text-gray-800 dark:text-gray-100";

    private string GetInputClasses()
    {
        var sizeClasses = Size switch
        {
            "sm" => "py-1.5 text-sm",
            "lg" => "py-3 text-base",
            _ => "py-2 text-sm"
        };

        var stateClasses = HasError
            ? "border-red-500 focus:border-red-500 focus:ring-red-500/20"
            : Disabled
                ? "border-gray-200 dark:border-gray-700/60 bg-gray-100 dark:bg-gray-900/50 text-gray-400 cursor-not-allowed"
                : "border-gray-200 dark:border-gray-700/60 hover:border-gray-300 dark:hover:border-gray-600 focus:border-violet-300 dark:focus:border-violet-500/50";

        return $"form-input w-full pl-10 pr-3 {sizeClasses} bg-white dark:bg-gray-800 {stateClasses} rounded-lg";
    }

    private string? GetFormattedValue()
    {
        if (Value == null) return null;
        return IncludeTime
            ? Value.Value.ToString("yyyy-MM-ddTHH:mm")
            : Value.Value.ToString("yyyy-MM-dd");
    }

    private string? GetFormattedMin()
    {
        if (MinDate == null) return null;
        return IncludeTime
            ? MinDate.Value.ToString("yyyy-MM-ddTHH:mm")
            : MinDate.Value.ToString("yyyy-MM-dd");
    }

    private string? GetFormattedMax()
    {
        if (MaxDate == null) return null;
        return IncludeTime
            ? MaxDate.Value.ToString("yyyy-MM-ddTHH:mm")
            : MaxDate.Value.ToString("yyyy-MM-dd");
    }

    private async Task OnChange(ChangeEventArgs e)
    {
        var stringValue = e.Value?.ToString();
        if (string.IsNullOrEmpty(stringValue))
        {
            Value = null;
        }
        else if (DateTime.TryParse(stringValue, out var date))
        {
            Value = date;
        }
        await ValueChanged.InvokeAsync(Value);
    }
}
