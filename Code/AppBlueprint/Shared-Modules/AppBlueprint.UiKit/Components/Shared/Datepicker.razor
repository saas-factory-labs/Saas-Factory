@using Microsoft.JSInterop
@using Microsoft.Extensions.Logging
@inject IJSRuntime JS
@inject ILogger<Datepicker> Logger
@implements IAsyncDisposable

<div class="relative">
    <input @ref="inputRef"
           id="@datePickerId"
           type="text"
           class="form-input pl-9 dark:bg-gray-800 text-gray-600 hover:text-gray-800 dark:text-gray-300 dark:hover:text-gray-100 font-medium w-[15.5rem]"
           placeholder="Select date range"
           readonly />
    <div class="absolute inset-0 right-auto flex items-center pointer-events-none">
        <svg class="fill-current text-gray-400 dark:text-gray-500 ml-3" width="16" height="16" viewBox="0 0 16 16">
            <path d="M5 4a1 1 0 0 0 0 2h6a1 1 0 1 0 0-2H5Z" />
            <path d="M4 0a4 4 0 0 0-4 4v8a4 4 0 0 0 4 4h8a4 4 0 0 0 4-4V4a4 4 0 0 0-4-4H4ZM2 4a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V4Z" />
        </svg>
    </div>
</div>

@code {
    [Parameter]
    public string? Align { get; set; }

    private ElementReference inputRef;
    private string datePickerId = $"datepicker-{Guid.NewGuid():N}";
    private bool isInitialized = false;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        try
        {
            if (firstRender)
            {
                // Check if datepickerManager is available before initializing
                bool isAvailable = await JS.InvokeAsync<bool>("eval", "typeof datepickerManager !== 'undefined' && typeof datepickerManager.initialize === 'function'");
                if (isAvailable)
                {
                    await JS.InvokeVoidAsync("datepickerManager.initialize", inputRef, Align);
                    isInitialized = true;
                }
                else
                {
                    Logger.LogWarning("⚠️ Datepicker JavaScript module not available");
                }
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "❌ Error in Datepicker");
        }
    }

    public async ValueTask DisposeAsync()
    {
        if (!isInitialized)
        {
            return;
        }

        try
        {
            bool isAvailable = await JS.InvokeAsync<bool>("eval", "typeof datepickerManager !== 'undefined' && typeof datepickerManager.cleanup === 'function'");
            if (isAvailable)
            {
                await JS.InvokeVoidAsync("datepickerManager.cleanup", inputRef);
            }
        }
        catch (JSDisconnectedException)
        {
            // Circuit disconnected, ignore - cleanup will happen on client side
        }
        catch (InvalidOperationException ex) when (ex.Message.Contains("statically rendered"))
        {
            // Component being statically rendered, ignore
        }
        catch (Exception ex)
        {
            Logger.LogWarning(ex, "⚠️ Error disposing Datepicker");
        }
    }
}
