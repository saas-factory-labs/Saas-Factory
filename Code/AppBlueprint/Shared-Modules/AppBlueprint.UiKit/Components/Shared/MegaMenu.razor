@* Mega Menu component with multi-column layout *@

<div class="relative" @onmouseenter="OnMouseEnter" @onmouseleave="OnMouseLeave">
    @* Trigger *@
    <button type="button"
            class="@GetTriggerClasses()"
            @onclick="Toggle"
            aria-expanded="@IsOpen"
            aria-haspopup="true">
        @if (TriggerIcon != null)
        {
            <span class="mr-2">@TriggerIcon</span>
        }
        <span>@TriggerText</span>
        <svg class="shrink-0 ml-1 fill-current text-gray-400 dark:text-gray-500 transition-transform @(IsOpen ? "rotate-180" : "")"
             width="10" height="10" viewBox="0 0 10 10">
            <path d="M1 3l4 4 4-4"/>
        </svg>
    </button>

    @* Mega menu panel *@
    @if (IsOpen)
    {
        @* Backdrop for click-outside *@
        <div class="fixed inset-0 z-40" @onclick="Close"></div>

        <div class="@GetPanelClasses()">
            @if (Sections != null && Sections.Any())
            {
                <div class="@GetGridClasses()">
                    @foreach (var menuSection in Sections)
                    {
                        <div class="@GetSectionClasses()">
                            @if (!string.IsNullOrEmpty(menuSection.Title))
                            {
                                <h4 class="text-xs font-semibold text-gray-400 dark:text-gray-500 uppercase tracking-wide mb-3">
                                    @menuSection.Title
                                </h4>
                            }
                            <ul class="space-y-1">
                                @foreach (var item in menuSection.Items)
                                {
                                    <li>
                                        <a href="@item.Href"
                                           class="@GetItemClasses(item)"
                                           @onclick="() => OnItemClick(item)">
                                            @if (item.Icon != null)
                                            {
                                                <span class="shrink-0 mr-3 text-gray-400 dark:text-gray-500">
                                                    @item.Icon
                                                </span>
                                            }
                                            <div class="flex-1 min-w-0">
                                                <div class="flex items-center gap-2">
                                                    <span class="font-medium text-gray-800 dark:text-gray-100">@item.Label</span>
                                                    @if (item.IsNew)
                                                    {
                                                        <span class="px-1.5 py-0.5 text-[10px] font-semibold bg-green-100 dark:bg-green-500/20 text-green-600 dark:text-green-400 rounded">NEW</span>
                                                    }
                                                    @if (item.IsBeta)
                                                    {
                                                        <span class="px-1.5 py-0.5 text-[10px] font-semibold bg-violet-100 dark:bg-violet-500/20 text-violet-600 dark:text-violet-400 rounded">BETA</span>
                                                    }
                                                </div>
                                                @if (!string.IsNullOrEmpty(item.Description))
                                                {
                                                    <p class="text-xs text-gray-500 dark:text-gray-400 mt-0.5 line-clamp-2">@item.Description</p>
                                                }
                                            </div>
                                            @if (item.HasSubmenu)
                                            {
                                                <svg class="shrink-0 ml-2 fill-current text-gray-400" width="6" height="10" viewBox="0 0 6 10">
                                                    <path d="M1 1l4 4-4 4"/>
                                                </svg>
                                            }
                                        </a>
                                    </li>
                                }
                            </ul>
                        </div>
                    }
                </div>

                @* Featured section *@
                @if (FeaturedContent != null)
                {
                    <div class="border-t border-gray-200 dark:border-gray-700/60 mt-4 pt-4">
                        @FeaturedContent
                    </div>
                }
            }
            else if (ChildContent != null)
            {
                @ChildContent
            }
        </div>
    }
</div>

@code {
    [Parameter] public string TriggerText { get; set; } = "Menu";
    [Parameter] public RenderFragment? TriggerIcon { get; set; }
    [Parameter] public List<MegaMenuSection>? Sections { get; set; }
    [Parameter] public RenderFragment? ChildContent { get; set; }
    [Parameter] public RenderFragment? FeaturedContent { get; set; }
    [Parameter] public bool IsOpen { get; set; }
    [Parameter] public EventCallback<bool> IsOpenChanged { get; set; }
    [Parameter] public int Columns { get; set; } = 3; // 2, 3, 4
    [Parameter] public string TriggerMode { get; set; } = "click"; // click, hover
    [Parameter] public string Align { get; set; } = "left"; // left, center, right
    [Parameter] public string Width { get; set; } = "auto"; // auto, full, or specific width
    [Parameter] public EventCallback<MegaMenuItem> OnItemClicked { get; set; }

    private System.Timers.Timer? _closeTimer;

    protected override void OnInitialized()
    {
        _closeTimer = new System.Timers.Timer(200);
        _closeTimer.AutoReset = false;
        _closeTimer.Elapsed += async (_, _) =>
        {
            await InvokeAsync(async () =>
            {
                await SetOpen(false);
                StateHasChanged();
            });
        };
    }

    private async Task OnMouseEnter()
    {
        if (TriggerMode == "hover")
        {
            _closeTimer?.Stop();
            await SetOpen(true);
        }
    }

    private async Task OnMouseLeave()
    {
        if (TriggerMode == "hover")
        {
            _closeTimer?.Start();
        }
    }

    private async Task Toggle()
    {
        await SetOpen(!IsOpen);
    }

    private async Task Close()
    {
        await SetOpen(false);
    }

    private async Task SetOpen(bool value)
    {
        IsOpen = value;
        await IsOpenChanged.InvokeAsync(value);
    }

    private async Task OnItemClick(MegaMenuItem item)
    {
        await OnItemClicked.InvokeAsync(item);
        await Close();
    }

    private string GetTriggerClasses()
    {
        return "flex items-center px-3 py-2 text-sm font-medium text-gray-700 dark:text-gray-200 hover:text-violet-600 dark:hover:text-violet-400 transition-colors";
    }

    private string GetPanelClasses()
    {
        var alignClass = Align switch
        {
            "center" => "left-1/2 -translate-x-1/2",
            "right" => "right-0",
            _ => "left-0"
        };

        var widthClass = Width switch
        {
            "full" => "w-screen max-w-screen-lg",
            "auto" => "w-auto min-w-[400px]",
            _ => $"w-[{Width}]"
        };

        return $"absolute z-50 top-full mt-2 {alignClass} {widthClass} p-6 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700/60 rounded-xl shadow-xl";
    }

    private string GetGridClasses()
    {
        var colClass = Columns switch
        {
            2 => "grid-cols-2",
            4 => "grid-cols-4",
            _ => "grid-cols-3"
        };

        return $"grid {colClass} gap-6";
    }

    private string GetSectionClasses()
    {
        return "";
    }

    private string GetItemClasses(MegaMenuItem item)
    {
        var baseClasses = "flex items-start p-2 -mx-2 rounded-lg transition-colors";
        var hoverClasses = "hover:bg-gray-50 dark:hover:bg-gray-700/50";

        return $"{baseClasses} {hoverClasses}";
    }

    public void Dispose()
    {
        _closeTimer?.Dispose();
    }

    public class MegaMenuSection
    {
        public string? Title { get; set; }
        public List<MegaMenuItem> Items { get; set; } = new();
    }

    public class MegaMenuItem
    {
        public string Label { get; set; } = "";
        public string? Description { get; set; }
        public string Href { get; set; } = "#";
        public RenderFragment? Icon { get; set; }
        public bool IsNew { get; set; } = false;
        public bool IsBeta { get; set; } = false;
        public bool HasSubmenu { get; set; } = false;
    }
}
