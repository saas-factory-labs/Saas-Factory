@* Stats Card widget with trends and sparklines *@
@inject AppBlueprint.UiKit.Services.ThemeService ThemeService

<div class="@GetContainerClasses()">
    <div class="flex items-start justify-between">
        @* Icon *@
        @if (Icon != null || !string.IsNullOrEmpty(IconName))
        {
            <div class="@GetIconClasses()">
                @if (Icon != null)
                {
                    @Icon
                }
                else
                {
                    @GetDefaultIcon(IconName)
                }
            </div>
        }

        @* Trend indicator *@
        @if (ShowTrend && TrendValue != 0)
        {
            <div class="@GetTrendClasses()">
                @if (TrendValue > 0)
                {
                    <svg class="w-3 h-3 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="3">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M5 15l7-7 7 7" />
                    </svg>
                }
                else
                {
                    <svg class="w-3 h-3 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="3">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" />
                    </svg>
                }
                <span>@Math.Abs(TrendValue).ToString("0.#")%</span>
            </div>
        }
    </div>

    @* Value *@
    <div class="mt-4">
        <div class="@GetValueClasses()">
            @if (!string.IsNullOrEmpty(Prefix))
            {
                <span class="text-lg mr-1">@Prefix</span>
            }
            @Value
            @if (!string.IsNullOrEmpty(Suffix))
            {
                <span class="text-lg ml-1">@Suffix</span>
            }
        </div>
        <div class="text-sm text-gray-500 dark:text-gray-400 mt-1">@Label</div>
    </div>

    @* Sparkline or progress *@
    @if (ShowSparkline && SparklineData != null && SparklineData.Any())
    {
        <div class="mt-4 h-12">
            <svg class="w-full h-full" viewBox="0 0 100 40" preserveAspectRatio="none">
                <path d="@GetSparklinePath()" fill="none" stroke="currentColor" stroke-width="2" class="@GetSparklineStrokeClasses()" />
                <path d="@GetSparklineAreaPath()" fill="currentColor" class="@GetSparklineFillClasses()" />
            </svg>
        </div>
    }

    @if (ShowProgress)
    {
        <div class="mt-4">
            <div class="flex items-center justify-between text-sm mb-1">
                <span class="text-gray-500 dark:text-gray-400">@ProgressLabel</span>
                <span class="font-medium text-gray-700 dark:text-gray-300">@ProgressValue%</span>
            </div>
            <div class="h-2 bg-gray-200 dark:bg-gray-700 rounded-full overflow-hidden">
                <div class="h-full rounded-full transition-all duration-500 @GetProgressBarClasses()"
                     style="width: @ProgressValue%"></div>
            </div>
        </div>
    }

    @* Footer/Additional info *@
    @if (Footer != null)
    {
        <div class="mt-4 pt-4 border-t border-gray-200 dark:border-gray-700">
            @Footer
        </div>
    }
</div>

@code {
    [Parameter] public string Value { get; set; } = "0";
    [Parameter] public string Label { get; set; } = "";
    [Parameter] public string? Prefix { get; set; }
    [Parameter] public string? Suffix { get; set; }
    [Parameter] public decimal TrendValue { get; set; } = 0;
    [Parameter] public bool ShowTrend { get; set; } = true;
    [Parameter] public string Variant { get; set; } = "default"; // default, primary, success, warning, danger
    [Parameter] public RenderFragment? Icon { get; set; }
    [Parameter] public string? IconName { get; set; }
    [Parameter] public List<decimal>? SparklineData { get; set; }
    [Parameter] public bool ShowSparkline { get; set; } = false;
    [Parameter] public bool ShowProgress { get; set; } = false;
    [Parameter] public int ProgressValue { get; set; } = 0;
    [Parameter] public string ProgressLabel { get; set; } = "Progress";
    [Parameter] public RenderFragment? Footer { get; set; }
    [Parameter] public string? Class { get; set; }

    private string GetContainerClasses()
    {
        return $"bg-white dark:bg-gray-800 rounded-xl shadow-sm p-5 {Class}".Trim();
    }

    private string GetIconClasses()
    {
        var baseClasses = "w-12 h-12 rounded-xl flex items-center justify-center";
        return Variant switch
        {
            "primary" => $"{baseClasses} {ThemeService.GetPrimaryClass("bg", "100")} dark:{ThemeService.GetPrimaryClass("bg", "500")}/20 {ThemeService.GetPrimaryClass("text", "600")} dark:{ThemeService.GetPrimaryClass("text", "400")}",
            "success" => $"{baseClasses} bg-green-100 dark:bg-green-500/20 text-green-600 dark:text-green-400",
            "warning" => $"{baseClasses} bg-yellow-100 dark:bg-yellow-500/20 text-yellow-600 dark:text-yellow-400",
            "danger" => $"{baseClasses} bg-red-100 dark:bg-red-500/20 text-red-600 dark:text-red-400",
            _ => $"{baseClasses} bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-400"
        };
    }

    private string GetValueClasses()
    {
        return "text-3xl font-bold text-gray-800 dark:text-gray-100";
    }

    private string GetTrendClasses()
    {
        var baseClasses = "inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium";
        return TrendValue >= 0
            ? $"{baseClasses} bg-green-100 dark:bg-green-500/20 text-green-600 dark:text-green-400"
            : $"{baseClasses} bg-red-100 dark:bg-red-500/20 text-red-600 dark:text-red-400";
    }

    private string GetSparklineStrokeClasses()
    {
        return Variant switch
        {
            "primary" => ThemeService.GetPrimaryClass("text", "500"),
            "success" => "text-green-500",
            "warning" => "text-yellow-500",
            "danger" => "text-red-500",
            _ => ThemeService.GetPrimaryClass("text", "500")
        };
    }

    private string GetSparklineFillClasses()
    {
        return Variant switch
        {
            "primary" => $"{ThemeService.GetPrimaryClass("text", "500")}/10",
            "success" => "text-green-500/10",
            "warning" => "text-yellow-500/10",
            "danger" => "text-red-500/10",
            _ => $"{ThemeService.GetPrimaryClass("text", "500")}/10"
        };
    }

    private string GetProgressBarClasses()
    {
        return Variant switch
        {
            "primary" => ThemeService.GetPrimaryClass("bg", "500"),
            "success" => "bg-green-500",
            "warning" => "bg-yellow-500",
            "danger" => "bg-red-500",
            _ => ThemeService.GetPrimaryClass("bg", "500")
        };
    }

    private string GetSparklinePath()
    {
        if (SparklineData == null || !SparklineData.Any()) return "";

        var max = SparklineData.Max();
        var min = SparklineData.Min();
        var range = max - min;
        if (range == 0) range = 1;

        var points = SparklineData.Select((v, i) => {
            var x = (decimal)i / (SparklineData.Count - 1) * 100;
            var y = 40 - ((v - min) / range * 35 + 2.5m);
            return $"{x:F1},{y:F1}";
        });

        return $"M {string.Join(" L ", points)}";
    }

    private string GetSparklineAreaPath()
    {
        if (SparklineData == null || !SparklineData.Any()) return "";

        var linePath = GetSparklinePath();
        return $"{linePath} L 100,40 L 0,40 Z";
    }

    private RenderFragment GetDefaultIcon(string? name) => name switch
    {
        "users" => @<svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z" /></svg>,
        "revenue" => @<svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>,
        "orders" => @<svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z" /></svg>,
        "chart" => @<svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" /></svg>,
        _ => @<svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" /></svg>
    };
}
