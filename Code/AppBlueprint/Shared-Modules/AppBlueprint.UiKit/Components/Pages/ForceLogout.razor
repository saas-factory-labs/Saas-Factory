@page "/force-logout"
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.JSInterop
@inject NavigationManager NavigationManager
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject IJSRuntime JS

<PageTitle>Force Logout</PageTitle>

<MudContainer MaxWidth="MaxWidth.Small" Class="mt-8">
    <MudPaper Class="pa-8" Elevation="4">
        <MudText Typo="Typo.h4" Class="mb-4">Force Logout</MudText>
        
        <MudText Class="mb-4">
            Current Status: <strong>@(_isAuthenticated ? "LOGGED IN" : "LOGGED OUT")</strong>
        </MudText>
        
        <MudText Class="mb-4">
            User: <strong>@_userName</strong>
        </MudText>
        
        <MudDivider Class="my-4" />
        
        <MudText Typo="Typo.h6" Class="mb-4">Emergency Logout Options:</MudText>
        
        <MudStack Spacing="3">
            <MudButton Variant="Variant.Filled" 
                       Color="Color.Error" 
                       FullWidth="true"
                       OnClick="ForceLogoutJavaScript">
                Option 1: JavaScript Force Logout
            </MudButton>
            
            <MudButton Variant="Variant.Filled" 
                       Color="Color.Warning" 
                       FullWidth="true"
                       Href="/SignOut/Local">
                Option 2: Direct Link to /SignOut/Local
            </MudButton>
            
            <MudButton Variant="Variant.Filled" 
                       Color="Color.Primary" 
                       FullWidth="true"
                       OnClick="ClearCookiesAndReload">
                Option 3: Clear Cookies + Reload
            </MudButton>
        </MudStack>
        
        <MudDivider Class="my-4" />
        
        <MudText Typo="Typo.body2" Class="mb-2">
            <strong>Diagnostic Info:</strong>
        </MudText>
        <MudText Typo="Typo.body2" Class="mb-2">
            Current URL: @NavigationManager.Uri
        </MudText>
        <MudText Typo="Typo.body2">
            If all options fail, open browser DevTools → Application → Cookies → Delete all localhost cookies manually.
        </MudText>
    </MudPaper>
</MudContainer>

@code {
    private bool _isAuthenticated;
    private string _userName = "Not authenticated";

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        _isAuthenticated = authState.User?.Identity?.IsAuthenticated ?? false;
        _userName = authState.User?.Identity?.Name ?? "Not authenticated";
        
        Console.WriteLine($"[ForceLogout] Page loaded. IsAuthenticated: {_isAuthenticated}, User: {_userName}");
    }

    private async Task ForceLogoutJavaScript()
    {
        Console.WriteLine("[ForceLogout] Option 1: JavaScript force logout");
        
        // Use JavaScript to navigate directly to SignOut/Local endpoint
        await JS.InvokeVoidAsync("eval", "window.location.href = '/SignOut/Local';");
    }
    
    private async Task ClearCookiesAndReload()
    {
        Console.WriteLine("[ForceLogout] Option 3: Clear cookies and reload");
        
        // Clear all cookies for this domain using JavaScript
        await JS.InvokeVoidAsync("eval", @"
            document.cookie.split(';').forEach(function(c) { 
                document.cookie = c.replace(/^ +/, '').replace(/=.*/, '=;expires=' + new Date().toUTCString() + ';path=/'); 
            });
            window.location.href = '/login';
        ");
    }
}

