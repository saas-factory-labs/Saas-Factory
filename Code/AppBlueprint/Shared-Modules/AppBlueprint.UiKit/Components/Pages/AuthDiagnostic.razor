@page "/auth-diagnostic"
@using Microsoft.AspNetCore.Components.Authorization
@using System.Security.Claims
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject NavigationManager NavigationManager

<PageTitle>Authentication Diagnostic</PageTitle>

<MudContainer MaxWidth="MaxWidth.Large" Class="mt-8">
    <MudPaper Class="pa-8" Elevation="4">
        <MudText Typo="Typo.h4" Class="mb-4">Authentication Diagnostic</MudText>
        
        <MudDivider Class="my-4" />
        
        <MudText Typo="Typo.h6" Class="mb-2">Current URL</MudText>
        <MudText Class="mb-4"><code>@NavigationManager.Uri</code></MudText>
        
        <MudDivider Class="my-4" />
        
        <MudText Typo="Typo.h6" Class="mb-2">Authentication State</MudText>
        <MudText Class="mb-2"><strong>Is Authenticated:</strong> @_isAuthenticated</MudText>
        <MudText Class="mb-2"><strong>User Name:</strong> @_userName</MudText>
        <MudText Class="mb-4"><strong>Identity Type:</strong> @_identityType</MudText>
        
        <MudDivider Class="my-4" />
        
        <MudText Typo="Typo.h6" Class="mb-2">All Claims</MudText>
        @if (_claims != null && _claims.Any())
        {
            <MudTable Items="_claims" Dense="true" Hover="true" Class="mb-4">
                <HeaderContent>
                    <MudTh>Type</MudTh>
                    <MudTh>Value</MudTh>
                </HeaderContent>
                <RowTemplate>
                    <MudTd>@context.Type</MudTd>
                    <MudTd><code>@context.Value</code></MudTd>
                </RowTemplate>
            </MudTable>
        }
        else
        {
            <MudText Class="mb-4"><em>No claims found</em></MudText>
        }
        
        <MudDivider Class="my-4" />
        
        <MudText Typo="Typo.h6" Class="mb-2">Query Parameters</MudText>
        @if (_queryParams != null && _queryParams.Any())
        {
            <MudTable Items="_queryParams" Dense="true" Hover="true" Class="mb-4">
                <HeaderContent>
                    <MudTh>Key</MudTh>
                    <MudTh>Value</MudTh>
                </HeaderContent>
                <RowTemplate>
                    <MudTd>@context.Key</MudTd>
                    <MudTd><code>@context.Value</code></MudTd>
                </RowTemplate>
            </MudTable>
        }
        else
        {
            <MudText Class="mb-4"><em>No query parameters</em></MudText>
        }
        
        <MudDivider Class="my-4" />
        
        <MudText Typo="Typo.h6" Class="mb-4">Test Sign-Out Methods</MudText>
        
        <MudButton Variant="Variant.Filled" 
                   Color="Color.Error" 
                   StartIcon="@Icons.Material.Filled.Logout"
                   Href="/SignOut"
                   Class="mr-2">
            Test /SignOut (Full Logto)
        </MudButton>
        
        <MudButton Variant="Variant.Outlined" 
                   Color="Color.Warning" 
                   StartIcon="@Icons.Material.Filled.Logout"
                   Href="/SignOut/Local"
                   Class="mr-2">
            Test /SignOut/Local (Cookie Only)
        </MudButton>
        
        <MudButton Variant="Variant.Text" 
                   Color="Color.Primary" 
                   StartIcon="@Icons.Material.Filled.Refresh"
                   OnClick="Refresh">
            Refresh Page
        </MudButton>
    </MudPaper>
</MudContainer>

@code {
    private bool _isAuthenticated;
    private string? _userName;
    private string? _identityType;
    private List<Claim>? _claims;
    private Dictionary<string, string>? _queryParams;

    protected override async Task OnInitializedAsync()
    {
        await LoadAuthState();
        LoadQueryParams();
    }

    private async Task LoadAuthState()
    {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;
        
        _isAuthenticated = user?.Identity?.IsAuthenticated ?? false;
        _userName = user?.Identity?.Name ?? "Not authenticated";
        _identityType = user?.Identity?.AuthenticationType ?? "None";
        _claims = user?.Claims?.ToList();
        
        Console.WriteLine($"[AuthDiagnostic] Is Authenticated: {_isAuthenticated}");
        Console.WriteLine($"[AuthDiagnostic] User Name: {_userName}");
        Console.WriteLine($"[AuthDiagnostic] Claims Count: {_claims?.Count ?? 0}");
    }

    private void LoadQueryParams()
    {
        var uri = new Uri(NavigationManager.Uri);
        var query = System.Web.HttpUtility.ParseQueryString(uri.Query);
        
        _queryParams = new Dictionary<string, string>();
        foreach (string key in query.AllKeys)
        {
            if (key != null)
            {
                _queryParams[key] = query[key] ?? "";
            }
        }
        
        Console.WriteLine($"[AuthDiagnostic] Query Parameters: {_queryParams.Count}");
    }

    private async Task Refresh()
    {
        await LoadAuthState();
        LoadQueryParams();
        StateHasChanged();
    }
}

