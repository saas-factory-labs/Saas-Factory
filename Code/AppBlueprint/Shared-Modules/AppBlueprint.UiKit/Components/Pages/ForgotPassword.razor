@page "/forgot-password"
@using AppBlueprint.Application.Services.Users
@using System.ComponentModel.DataAnnotations
@using Microsoft.Extensions.Configuration
@using Microsoft.JSInterop
@inject ISnackbar Snackbar
@inject IServiceProvider ServiceProvider
@inject IConfiguration Configuration
@inject IJSRuntime JSRuntime

<PageTitle>Forgot Password - AppBlueprint</PageTitle>

<MudContainer MaxWidth="MaxWidth.Small" Class="pa-4">
    <MudPaper Elevation="3" Class="pa-4">
        <MudText Typo="Typo.h5" Class="mb-4 text-center">Forgot Password</MudText>
        
        @if (_isSuccess)
        {
            <div class="d-flex flex-column align-center my-4">
                <MudIcon Icon="@Icons.Material.Filled.Email" Color="Color.Success" Size="Size.Large" Class="mb-4" />
                <MudText Typo="Typo.h6" Align="Align.Center" Class="mb-2">Check Your Email</MudText>
                <MudText Align="Align.Center" Class="mb-4">
                    We've sent a password reset link to <strong>@_email</strong>. 
                    Please check your inbox and follow the instructions to reset your password.
                </MudText>
                <MudText Align="Align.Center" Class="mud-text-secondary mb-4">
                    If you don't see the email in your inbox, please check your spam folder.
                </MudText>
                <div class="d-flex gap-2">
                    <MudButton Variant="Variant.Outlined" Color="Color.Primary" OnClick="ResetForm">
                        Send to another email
                    </MudButton>
                    <MudButton Variant="Variant.Filled" Color="Color.Primary" Link="/login">
                        Return to Login
                    </MudButton>
                </div>
            </div>
        }
        else
        {
            <form id="forgot-password-form"
                  method="post"
                  action="/forgot-password"
                  @onsubmit="HandleForgotPassword"
                  @onsubmit:preventDefault="true"
                  data-dashlane-rid="forgot-password-form"
                  data-form-type="other">
                
                @* Hidden native input for password managers *@
                <div style="position: absolute; left: -9999px; width: 1px; height: 1px; opacity: 0;">
                    <input type="email" 
                           name="email" 
                           autocomplete="username"
                           value="@_email"
                           @onchange="(e) => _email = e.Value?.ToString() ?? string.Empty"
                           data-dashlane-rid="hidden-email"
                           data-lpignore="false" />
                </div>
                
                <MudForm @ref="_form" Class="mt-4">
                    <MudText Class="mb-4">
                        Enter your email address and we'll send you a link to reset your password.
                    </MudText>
                      <MudTextField @bind-Value="_email" 
                                  Label="Email" 
                                  Required="true"
                                  RequiredError="Email is required"
                                  InputType="InputType.Email" 
                                  id="email"
                                  Validation="@(new EmailAddressAttribute() { ErrorMessage = "Invalid email format" })"
                                  InputAttributes="@(new Dictionary<string, object>
                                  {
                                      ["autocomplete"] = "username",
                                      ["name"] = "email",
                                      ["type"] = "email",
                                      ["data-lpignore"] = "false",
                                      ["data-form-type"] = "other",
                                      ["data-dashlane-rid"] = "email-field",
                                      ["data-dashlane-label"] = "Email"
                                  })" />
                
                <div class="d-flex justify-space-between align-center mt-6">
                    <MudButton Variant="Variant.Text" Color="Color.Primary" Link="/login">
                        Back to Login
                    </MudButton>
                    <MudButton Variant="Variant.Filled" Color="Color.Primary" DisableElevation="true"
                           OnClick="HandleForgotPassword" Disabled="@_isLoading">
                        @if (_isLoading)
                        {
                            <MudProgressCircular Class="ms-n1" Size="Size.Small" Indeterminate="true" />
                            <span class="ms-2">Sending...</span>
                        }
                        else
                        {
                            <span>Reset Password</span>
                        }
                    </MudButton>
                </div>
                </MudForm>
            </form>
        }
    </MudPaper>
</MudContainer>

@code {
    private string _email = string.Empty;
    private bool _isLoading;
    private bool _isSuccess;
    private MudForm _form = default!;
    private IUserService? _userService;
    private string? _authProvider;
    private string? _logtoEndpoint;

    protected override void OnInitialized()
    {
        // Get the configured authentication provider
        _authProvider = Configuration["Authentication:Provider"];
        _logtoEndpoint = Configuration["Authentication:Logto:Endpoint"];
        
        // Manually resolve IUserService to handle it being optional
        _userService = ServiceProvider.GetService(typeof(IUserService)) as IUserService;
        
        Console.WriteLine($"[ForgotPassword] Auth Provider: {_authProvider ?? "Not configured"}");
        
        if (_authProvider?.Equals("Logto", StringComparison.OrdinalIgnoreCase) == true)
        {
            Console.WriteLine($"[ForgotPassword] Logto endpoint: {_logtoEndpoint}");
        }
        else if (_userService is null)
        {
            Console.WriteLine("[ForgotPassword] IUserService not registered - using mock implementation");
        }
    }
    
    private async Task HandleForgotPassword()
    {
        await _form.Validate();
        
        if (!_form.IsValid)
        {
            return;
        }

        if (string.IsNullOrEmpty(_email))
        {
            Snackbar.Add("Please enter your email address", Severity.Warning);
            return;
        }

        try
        {
            _isLoading = true;
            
            // Check if using Logto
            if (_authProvider?.Equals("Logto", StringComparison.OrdinalIgnoreCase) == true)
            {
                // Redirect to Logto's forgot password page
                if (!string.IsNullOrEmpty(_logtoEndpoint))
                {
                    var logtoForgotPasswordUrl = $"{_logtoEndpoint.TrimEnd('/')}/forgot-password";
                    Console.WriteLine($"[ForgotPassword] Redirecting to Logto forgot password: {logtoForgotPasswordUrl}");
                    
                    // Open Logto's forgot password page in a new tab
                    await JSRuntime.InvokeVoidAsync("open", logtoForgotPasswordUrl, "_blank");
                    
                    Snackbar.Add("Opening Logto password reset page...", Severity.Info);
                    
                    // Show success message
                    await Task.Delay(500);
                    _isSuccess = true;
                }
                else
                {
                    Snackbar.Add("Logto endpoint not configured", Severity.Error);
                }
            }
            else if (_userService is not null)
            {
                // Real implementation when UserService is available (for custom auth)
                await _userService.InitiatePasswordResetAsync(_email, CancellationToken.None);
                _isSuccess = true;
            }
            else
            {
                // Mock implementation when no auth service is available
                Console.WriteLine($"[ForgotPassword] Mock password reset request for: {_email}");
                await Task.Delay(1000); // Simulate network delay
                _isSuccess = true;
                Snackbar.Add("Password reset email sent! (Mock mode)", Severity.Success);
            }
        }
        catch (Exception ex)
        {
            Console.Error.WriteLine($"[ForgotPassword] Error: {ex.Message}");
            Snackbar.Add($"An error occurred: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isLoading = false;
        }
    }
    
    private void ResetForm()
    {
        _isSuccess = false;
        _email = string.Empty;
    }
}