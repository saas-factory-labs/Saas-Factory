@page "/calendar"
@using AppBlueprint.UiKit.Components.Pages.CalendarComponents
@inject ThemeService ThemeService

<div class="px-4 sm:px-6 lg:px-8 py-8 w-full max-w-[96rem] mx-auto">

    <!-- Page header -->
    <div class="sm:flex sm:justify-between sm:items-center mb-4">

        <!-- Left: Title -->
        <div class="mb-4 sm:mb-0">
            <h1 class="text-2xl md:text-3xl text-gray-800 dark:text-gray-100 font-bold">@($"{MonthNames[currentMonth]} {currentYear}")</h1>
        </div>

        <!-- Right: Actions -->
        <div class="grid grid-flow-col sm:auto-cols-max justify-start sm:justify-end gap-2">

            <!-- Previous month button -->
            <button class="btn px-2.5 bg-white dark:bg-gray-800 border-gray-200 dark:border-gray-700 hover:border-gray-300 dark:hover:border-gray-600 text-gray-500 hover:text-gray-600 dark:text-gray-400 dark:hover:text-gray-300 disabled:border-gray-200 dark:disabled:border-gray-700 disabled:bg-gray-100 dark:disabled:bg-gray-800 disabled:text-gray-400 dark:disabled:text-gray-600 disabled:cursor-not-allowed"
                    disabled="@(currentMonth == 0)"
                    @onclick="PreviousMonth">
                <span class="sr-only">Previous month</span>
                <svg class="h-4 w-4 fill-current" viewBox="0 0 16 16">
                    <path d="M9.4 13.4l1.4-1.4-4-4 4-4-1.4-1.4L4 8z"/>
                </svg>
            </button>

            <!-- Next month button -->
            <button class="btn px-2.5 bg-white dark:bg-gray-800 border-gray-200 dark:border-gray-700 hover:border-gray-300 dark:hover:border-gray-600 text-gray-500 hover:text-gray-600 dark:text-gray-400 dark:hover:text-gray-300 disabled:border-gray-200 dark:disabled:border-gray-700 disabled:bg-gray-100 dark:disabled:bg-gray-800 disabled:text-gray-400 dark:disabled:text-gray-600 disabled:cursor-not-allowed"
                    disabled="@(currentMonth == 11)"
                    @onclick="NextMonth">
                <span class="sr-only">Next month</span>
                <svg class="h-4 w-4 fill-current" viewBox="0 0 16 16">
                    <path d="M6.6 13.4L5.2 12l4-4-4-4 1.4-1.4L12 8z"/>
                </svg>
            </button>

            <hr class="w-px h-full bg-gray-200 dark:bg-gray-700 border-none mx-1"/>

            <!-- Create event button -->
            <button class="@ThemeService.GetPrimaryButtonClasses()">
                <svg class="w-4 h-4 fill-current opacity-50 shrink-0" viewBox="0 0 16 16">
                    <path d="M15 7H9V1c0-.6-.4-1-1-1S7 .4 7 1v6H1c-.6 0-1 .4-1 1s.4 1 1 1h6v6c0 .6.4 1 1 1s1-.4 1-1V9h6c.6 0 1-.4 1-1s-.4-1-1-1z"/>
                </svg>
                <span class="hidden xs:block ml-2">Create Event</span>
            </button>

        </div>

    </div>

    <!-- Filters and view buttons -->
    <div class="sm:flex sm:justify-between sm:items-center mb-4">

        <!-- Filters  -->
        <div class="mb-4 sm:mb-0 mr-2">
            <ul class="flex flex-wrap items-center -m-1">
                <li class="m-1">
                    <CalendarFilterButton ColorClass="bg-sky-500" Label="Acme Inc." />
                </li>
                <li class="m-1">
                    <CalendarFilterButton ColorClass="bg-emerald-500" Label="Life & Family" />
                </li>
                <li class="m-1">
                    <CalendarFilterButton ColorClass="@ThemeService.GetPrimaryClass("bg", "500")" Label="Reservations" />
                </li>
                <li class="m-1">
                    <CalendarFilterButton ColorClass="bg-rose-400" Label="Events" />
                </li>
                <li class="m-1">
                    <CalendarFilterButton ColorClass="bg-amber-500" Label="Misc" />
                </li>
                <li class="m-1">
                    <button class="btn-sm bg-white dark:bg-gray-800 border-gray-200 dark:border-gray-700 hover:border-gray-300 dark:hover:border-gray-600 @ThemeService.GetPrimaryClass("text", "500")">+Add New</button>
                </li>
            </ul>
        </div>

        <!-- View buttons -->
        <div class="flex flex-nowrap -space-x-px">
            <button class="btn bg-gray-50 dark:bg-gray-900 border-gray-200 dark:border-gray-700 hover:bg-gray-50 @ThemeService.GetPrimaryClass("text", "500") rounded-none first:rounded-l last:rounded-r">Month</button>
            <button class="btn bg-white dark:bg-gray-800 border-gray-200 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-900 text-gray-600 dark:text-gray-300 rounded-none first:rounded-l last:rounded-r">Week</button>
            <button class="btn bg-white dark:bg-gray-800 border-gray-200 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-900 text-gray-600 dark:text-gray-300 rounded-none first:rounded-l last:rounded-r">Day</button>
        </div>
    </div>

    <!-- Calendar table -->
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-xs overflow-hidden">

        <!-- Days of the week -->
        <div class="grid grid-cols-7 gap-px border-b border-gray-200 dark:border-gray-700">
            @foreach (var day in DayNames)
            {
                <div class="px-1 py-3">
                    <div class="text-gray-500 text-sm font-medium text-center lg:hidden">@day.Substring(0, 3)</div>
                    <div class="text-gray-500 dark:text-gray-400 text-sm font-medium text-center hidden lg:block">@day</div>
                </div>
            }
        </div>

        <!-- Day cells -->
        <div class="grid grid-cols-7 gap-px bg-gray-200 dark:bg-gray-700">
            <!-- Diagonal stripes pattern -->
            <svg class="sr-only">
                <defs>
                    <pattern id="stripes" patternUnits="userSpaceOnUse" width="5" height="5" patternTransform="rotate(135)">
                        <line class="stroke-current text-gray-200 dark:text-gray-700 opacity-50" x1="0" y="0" x2="0" y2="5" stroke-width="2"/>
                    </pattern>
                </defs>
            </svg>

            <!-- Empty cells (previous month) -->
            @for (int i = 0; i < startingBlankDays; i++)
            {
                <CalendarEmptyCell />
            }

            <!-- Days of the current month -->
            @for (int day = 1; day <= daysInMonth; day++)
            {
                var currentDay = day;
                var dayEvents = GetEventsForDay(currentDay);
                <CalendarDayCell DayNumber="@currentDay" 
                                 IsToday="@IsToday(currentDay)" 
                                 ShowMoreButton="@(dayEvents.Count > 2)" 
                                 MoreCount="@(dayEvents.Count - 2)">
                    <Events>
                        @foreach (var evt in dayEvents.Take(2))
                        {
                            <CalendarEventButton EventName="@evt.Name" 
                                                 ColorClass="@GetEventColorClass(evt.Color)" 
                                                 StartTime="@evt.StartTime" 
                                                 EndTime="@evt.EndTime" />
                        }
                    </Events>
                </CalendarDayCell>
            }

            <!-- Empty cells (next month) -->
            @for (int i = 0; i < endingBlankDays; i++)
            {
                <CalendarEmptyCell />
            }
        </div>
    </div>

</div>

@code {
    private readonly string[] MonthNames = { "January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December" };
    private readonly string[] DayNames = { "Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday" };

    private int currentMonth;
    private int currentYear;
    private int daysInMonth;
    private int startingBlankDays;
    private int endingBlankDays;
    private List<CalendarEvent> events = new();

    protected override void OnInitialized()
    {
        var today = DateTime.Today;
        currentMonth = today.Month - 1;
        currentYear = today.Year;
        InitializeEvents();
        CalculateDays();
    }

    private void InitializeEvents()
    {
        var now = DateTime.Now;
        events = new List<CalendarEvent>
        {
            new() { Date = new DateTime(currentYear, currentMonth + 1, 1), Name = "Meeting w/ Patrick Lin", Color = "sky", StartTime = new TimeSpan(10, 0, 0), EndTime = new TimeSpan(11, 0, 0) },
            new() { Date = new DateTime(currentYear, currentMonth + 1, 1), Name = "Reservation at La Ginestre", Color = "indigo", StartTime = new TimeSpan(19, 0, 0) },
            new() { Date = new DateTime(currentYear, currentMonth + 1, 3), Name = "New Project", Color = "yellow", StartTime = new TimeSpan(9, 0, 0), EndTime = new TimeSpan(10, 0, 0) },
            new() { Date = new DateTime(currentYear, currentMonth + 1, 7), Name = "2024 - Semi-final", Color = "red", StartTime = new TimeSpan(21, 0, 0), EndTime = new TimeSpan(22, 0, 0) },
            new() { Date = new DateTime(currentYear, currentMonth + 1, 9), Name = "Meeting w/Carolyn", Color = "sky", StartTime = new TimeSpan(10, 0, 0), EndTime = new TimeSpan(11, 0, 0) },
            new() { Date = new DateTime(currentYear, currentMonth + 1, 9), Name = "Pick up Marta at school", Color = "emerald", StartTime = new TimeSpan(13, 0, 0) },
            new() { Date = new DateTime(currentYear, currentMonth + 1, 9), Name = "Meeting w/ Patrick Lin", Color = "emerald", StartTime = new TimeSpan(14, 0, 0), EndTime = new TimeSpan(15, 0, 0) },
            new() { Date = new DateTime(currentYear, currentMonth + 1, 9), Name = "Reservation at La Ginestre", Color = "indigo", StartTime = new TimeSpan(19, 0, 0) },
            new() { Date = new DateTime(currentYear, currentMonth + 1, 11), Name = "Relax for 2 at Marienbad", Color = "indigo", StartTime = new TimeSpan(10, 0, 0), EndTime = new TimeSpan(11, 0, 0) },
            new() { Date = new DateTime(currentYear, currentMonth + 1, 14), Name = "Team Catch-up", Color = "sky", StartTime = new TimeSpan(10, 0, 0), EndTime = new TimeSpan(11, 0, 0) },
            new() { Date = new DateTime(currentYear, currentMonth + 1, 21), Name = "Pick up Marta at school", Color = "emerald", StartTime = new TimeSpan(14, 0, 0) },
            new() { Date = new DateTime(currentYear, currentMonth + 1, 21), Name = "New Project (2)", Color = "yellow", StartTime = new TimeSpan(15, 0, 0), EndTime = new TimeSpan(19, 0, 0) },
            new() { Date = new DateTime(currentYear, currentMonth + 1, 22), Name = "Team Catch-up", Color = "sky", StartTime = new TimeSpan(10, 0, 0), EndTime = new TimeSpan(11, 0, 0) },
            new() { Date = new DateTime(currentYear, currentMonth + 1, 22), Name = "2024 - Semi-final", Color = "red", StartTime = new TimeSpan(19, 0, 0) },
            new() { Date = new DateTime(currentYear, currentMonth + 1, 25), Name = "Meeting w/ Kylie Joh", Color = "sky", StartTime = new TimeSpan(10, 0, 0), EndTime = new TimeSpan(11, 0, 0) },
            new() { Date = new DateTime(currentYear, currentMonth + 1, 28), Name = "Call Request", Color = "sky", StartTime = new TimeSpan(10, 0, 0), EndTime = new TimeSpan(11, 0, 0) },
        };
    }

    private void CalculateDays()
    {
        daysInMonth = DateTime.DaysInMonth(currentYear, currentMonth + 1);
        var firstDayOfMonth = new DateTime(currentYear, currentMonth + 1, 1);
        startingBlankDays = (int)firstDayOfMonth.DayOfWeek;
        var lastDayOfMonth = new DateTime(currentYear, currentMonth + 1, daysInMonth);
        endingBlankDays = 6 - (int)lastDayOfMonth.DayOfWeek;
    }

    private void PreviousMonth()
    {
        if (currentMonth > 0)
        {
            currentMonth--;
            CalculateDays();
        }
    }

    private void NextMonth()
    {
        if (currentMonth < 11)
        {
            currentMonth++;
            CalculateDays();
        }
    }

    private bool IsToday(int day)
    {
        var today = DateTime.Today;
        return today.Year == currentYear && today.Month == currentMonth + 1 && today.Day == day;
    }

    private List<CalendarEvent> GetEventsForDay(int day)
    {
        return events.Where(e => e.Date.Month == currentMonth + 1 && e.Date.Day == day).ToList();
    }

    private string GetEventColorClass(string color) => color switch
    {
        "sky" => "text-white bg-sky-500",
        "indigo" => $"text-white {ThemeService.GetPrimaryClass("bg", "500")}",
        "yellow" => "text-white bg-amber-500",
        "emerald" => "text-white bg-emerald-500",
        "red" => "text-white bg-rose-400",
        _ => ""
    };

    private class CalendarEvent
    {
        public DateTime Date { get; set; }
        public string Name { get; set; } = "";
        public string Color { get; set; } = "";
        public TimeSpan? StartTime { get; set; }
        public TimeSpan? EndTime { get; set; }
    }

}
