@using Microsoft.JSInterop
@using AppBlueprint.Application.Services
@using AppBlueprint.SharedKernel.Enums
@using Microsoft.AspNetCore.Components.Authorization
@inject IJSRuntime JS
@inject ICurrentTenantService CurrentTenantService
@inject AuthenticationStateProvider AuthenticationStateProvider

<header class="sticky top-0 before:absolute before:inset-0 before:backdrop-blur-md max-lg:before:bg-white/90 dark:max-lg:before:bg-gray-800/90 before:-z-10 z-30 max-lg:shadow-xs lg:before:bg-gray-100/90 dark:lg:before:bg-gray-900/90">
    <div class="px-4 sm:px-6 lg:px-8">
        <div class="flex items-center justify-between h-16 lg:border-b border-gray-200 dark:border-gray-700/60">

            <!-- Header: Left side -->
            <div class="flex">
                <!-- Hamburger button -->
                <button class="text-gray-500 hover:text-gray-600 dark:hover:text-gray-400 lg:hidden"
                        @onclick="HandleToggleSidebarAsync"
                        aria-controls="sidebar"
                        aria-expanded="@SidebarOpen">
                    <span class="sr-only">Open sidebar</span>
                    <svg class="w-6 h-6 fill-current" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <rect x="4" y="5" width="16" height="2"/>
                        <rect x="4" y="11" width="16" height="2"/>
                        <rect x="4" y="17" width="16" height="2"/>
                    </svg>
                </button>
            </div>

            <!-- Header: Right side -->
            <div class="flex items-center space-x-3">
                
                <!-- Tenant Info Display -->
                @if (!string.IsNullOrEmpty(tenantName))
                {
                    <div class="hidden sm:flex items-center gap-2">
                        <!-- Tenant Name -->
                        <div class="flex items-center px-3 py-1 bg-violet-50 dark:bg-violet-900/20 rounded-lg border border-violet-200 dark:border-violet-800/50">
                            <svg class="w-4 h-4 mr-2 text-violet-600 dark:text-violet-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
                            </svg>
                            <span class="text-sm font-medium text-violet-700 dark:text-violet-300">@tenantName</span>
                        </div>
                        
                        <!-- Tenant Type Chip -->
                        @if (tenantType.HasValue)
                        {
                            <div class="@GetTenantTypeChipClass()">
                                <span class="text-xs font-semibold">@GetTenantTypeLabel()</span>
                            </div>
                        }
                    </div>
                }
                
                <!-- Search button -->
                <div>
                    <button class="w-8 h-8 flex items-center justify-center hover:bg-gray-100 lg:hover:bg-gray-200 dark:hover:bg-gray-700/50 dark:lg:hover:bg-gray-800 rounded-full ml-3 @(searchModalOpen ? "bg-gray-200 dark:bg-gray-800" : "")"
                            @onclick="() => searchModalOpen = true"
                            @onclick:stopPropagation
                            aria-controls="search-modal">
                        <span class="sr-only">Search</span>
                        <svg class="fill-current text-gray-500/80 dark:text-gray-400/80" width="16" height="16" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg">
                            <path d="M7 14c-3.86 0-7-3.14-7-7s3.14-7 7-7 7 3.14 7 7-3.14 7-7 7ZM7 2C4.243 2 2 4.243 2 7s2.243 5 5 5 5-2.243 5-5-2.243-5-5-5Z"/>
                            <path d="m13.314 11.9 2.393 2.393a.999.999 0 1 1-1.414 1.414L11.9 13.314a8.019 8.019 0 0 0 1.414-1.414Z"/>
                        </svg>
                    </button>
                    <ModalSearch Id="search-modal" SearchId="search" @bind-IsOpen="searchModalOpen"/>
                </div>

                <!-- Notifications -->
                <DropdownNotifications Align="right"/>

                <!-- Help -->
                <DropdownHelp Align="right"/>

                <!-- Theme Toggle -->
                <div>
                    <button class="flex items-center justify-center cursor-pointer w-8 h-8 hover:bg-gray-100 lg:hover:bg-gray-200 dark:hover:bg-gray-700/50 dark:lg:hover:bg-gray-800 rounded-full"
                            @onclick="ToggleTheme"
                            aria-label="Toggle dark mode">
                        <!-- Sun icon (shown in light mode) -->
                        <svg class="dark:hidden fill-current text-gray-500/80 dark:text-gray-400/80" width="16" height="16" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg">
                            <path d="M8 0a1 1 0 0 1 1 1v.5a1 1 0 1 1-2 0V1a1 1 0 0 1 1-1Z"/>
                            <path d="M12 8a4 4 0 1 1-8 0 4 4 0 0 1 8 0Zm-4 2a2 2 0 1 0 0-4 2 2 0 0 0 0 4Z"/>
                            <path d="M13.657 3.757a1 1 0 0 0-1.414-1.414l-.354.354a1 1 0 0 0 1.414 1.414l.354-.354ZM13.5 8a1 1 0 0 1 1-1h.5a1 1 0 1 1 0 2h-.5a1 1 0 0 1-1-1ZM13.303 11.889a1 1 0 0 0-1.414 1.414l.354.354a1 1 0 0 0 1.414-1.414l-.354-.354ZM8 13.5a1 1 0 0 1 1 1v.5a1 1 0 1 1-2 0v-.5a1 1 0 0 1 1-1ZM4.111 13.303a1 1 0 1 0-1.414-1.414l-.354.354a1 1 0 1 0 1.414 1.414l.354-.354ZM0 8a1 1 0 0 1 1-1h.5a1 1 0 0 1 0 2H1a1 1 0 0 1-1-1ZM3.757 2.343a1 1 0 1 0-1.414 1.414l.354.354A1 1 0 1 0 4.11 2.697l-.354-.354Z"/>
                        </svg>
                        <!-- Moon icon (shown in dark mode) -->
                        <svg class="hidden dark:block fill-current text-gray-500/80 dark:text-gray-400/80" width="16" height="16" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg">
                            <path d="M11.875 4.375a.625.625 0 1 0 1.25 0c.001-.69.56-1.249 1.25-1.25a.625.625 0 1 0 0-1.25 1.252 1.252 0 0 1-1.25-1.25.625.625 0 1 0-1.25 0 1.252 1.252 0 0 1-1.25 1.25.625.625 0 1 0 0 1.25c.69.001 1.249.56 1.25 1.25Z"/>
                            <path d="M7.019 1.985a1.55 1.55 0 0 0-.483-1.36 1.44 1.44 0 0 0-1.53-.277C2.056 1.553 0 4.5 0 7.9 0 12.352 3.648 16 8.1 16c3.407 0 6.246-2.058 7.51-4.963a1.446 1.446 0 0 0-.25-1.55 1.554 1.554 0 0 0-1.372-.502c-4.01.552-7.539-2.987-6.97-7ZM2 7.9C2 5.64 3.193 3.664 4.961 2.6 4.82 7.245 8.72 11.158 13.36 11.04 12.265 12.822 10.341 14 8.1 14 4.752 14 2 11.248 2 7.9Z"/>
                        </svg>
                        <span class="sr-only">Switch to light / dark version</span>
                    </button>
                </div>

                <!-- Divider -->
                <hr class="w-px h-6 bg-gray-200 dark:bg-gray-700/60 border-none"/>

                <!-- User Menu -->
                <DropdownProfile Align="right"/>
            </div>

        </div>
    </div>
</header>

@code {
    [Parameter] public bool SidebarOpen { get; set; }

    [Parameter] public EventCallback OnToggleSidebar { get; set; }

    private bool searchModalOpen;
    private string? tenantName;
    private TenantType? tenantType;

    protected override async Task OnInitializedAsync()
    {
        // Only load tenant info if user is authenticated
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        if (authState?.User?.Identity?.IsAuthenticated == true)
        {
            await LoadTenantInfoAsync();
        }
    }

    private async Task LoadTenantInfoAsync()
    {
        try
        {
            // Check if tenant ID is available before making database calls
            string? tenantId = CurrentTenantService.TenantId;
            
            if (string.IsNullOrEmpty(tenantId))
            {
                Console.WriteLine("[Header] No tenant ID available in JWT claims");
                return;
            }
            
            tenantName = await CurrentTenantService.GetTenantNameAsync();
            tenantType = await CurrentTenantService.GetTenantTypeAsync();
            
            Console.WriteLine($"[Header] Tenant info loaded: {tenantName} ({tenantType})");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"[Header] Error loading tenant info: {ex.Message}");
            Console.WriteLine($"[Header] Stack trace: {ex.StackTrace}");
            tenantName = null;
            tenantType = null;
        }
    }

    private string GetTenantTypeLabel()
    {
        return tenantType switch
        {
            TenantType.Personal => "B2C",
            TenantType.Organization => "B2B",
            _ => "Unknown"
        };
    }

    private string GetTenantTypeChipClass()
    {
        return tenantType switch
        {
            TenantType.Personal => "px-2 py-1 bg-blue-50 dark:bg-blue-900/20 rounded-md border border-blue-200 dark:border-blue-800/50 text-blue-700 dark:text-blue-300",
            TenantType.Organization => "px-2 py-1 bg-emerald-50 dark:bg-emerald-900/20 rounded-md border border-emerald-200 dark:border-emerald-800/50 text-emerald-700 dark:text-emerald-300",
            _ => "px-2 py-1 bg-gray-50 dark:bg-gray-800 rounded-md border border-gray-200 dark:border-gray-700 text-gray-700 dark:text-gray-300"
        };
    }

    private async Task ToggleTheme()
    {
        await JS.InvokeVoidAsync("themeManager.toggleDarkMode");
    }

    private async Task HandleToggleSidebarAsync()
    {
        try
        {
            await OnToggleSidebar.InvokeAsync();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"[Header] Error toggling sidebar: {ex.Message}");
        }
    }

}
