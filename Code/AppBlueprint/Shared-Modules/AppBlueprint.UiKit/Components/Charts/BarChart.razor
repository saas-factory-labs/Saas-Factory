@using Microsoft.JSInterop
@inject IJSRuntime JSRuntime
@implements IAsyncDisposable

<div class="@ContainerClass">
    <canvas id="@CanvasId" width="@Width" height="@Height"></canvas>
</div>

@code {
    [Parameter] public string CanvasId { get; set; } = $"bar-chart-{Guid.NewGuid():N}";
    [Parameter] public int Width { get; set; } = 595;
    [Parameter] public int Height { get; set; } = 248;
    [Parameter] public string ContainerClass { get; set; } = "grow";
    [Parameter] public List<string> Labels { get; set; } = new();
    [Parameter] public List<BarChartDataset> Datasets { get; set; } = new();
    [Parameter] public bool UseTimeScale { get; set; } = true;

    private bool _initialized;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && Labels.Any() && Datasets.Any())
        {
            await InitializeChart();
        }
    }

    private async Task InitializeChart()
    {
        if (_initialized) return;

        var config = new
        {
            data = new
            {
                labels = Labels,
                datasets = Datasets.Select(d => new
                {
                    label = d.Label,
                    data = d.Data,
                    backgroundColor = d.BackgroundColor,
                    hoverBackgroundColor = d.HoverBackgroundColor,
                    barPercentage = d.BarPercentage,
                    categoryPercentage = d.CategoryPercentage,
                    borderRadius = d.BorderRadius
                }).ToArray()
            },
            useTimeScale = UseTimeScale
        };

        await JSRuntime.InvokeVoidAsync("chartJsInterop.createBarChart", CanvasId, config);
        _initialized = true;
    }

    public async Task UpdateData(List<string> labels, List<BarChartDataset> datasets)
    {
        Labels = labels;
        Datasets = datasets;

        if (_initialized)
        {
            var newData = new
            {
                labels = Labels,
                datasets = Datasets.Select(d => new
                {
                    label = d.Label,
                    data = d.Data,
                    backgroundColor = d.BackgroundColor,
                    hoverBackgroundColor = d.HoverBackgroundColor,
                    barPercentage = d.BarPercentage,
                    categoryPercentage = d.CategoryPercentage,
                    borderRadius = d.BorderRadius
                }).ToArray()
            };

            await JSRuntime.InvokeVoidAsync("chartJsInterop.updateChart", CanvasId, newData);
        }
    }

    public async ValueTask DisposeAsync()
    {
        if (_initialized)
        {
            try
            {
                await JSRuntime.InvokeVoidAsync("chartJsInterop.destroyChart", CanvasId);
            }
            catch (JSDisconnectedException)
            {
                // Ignore - circuit is already disconnected
            }
        }
    }

    public class BarChartDataset
    {
        public string Label { get; set; } = "";
        public List<double> Data { get; set; } = new();
        public string BackgroundColor { get; set; } = "rgb(99, 102, 241)";
        public string HoverBackgroundColor { get; set; } = "rgb(79, 70, 229)";
        public double BarPercentage { get; set; } = 0.7;
        public double CategoryPercentage { get; set; } = 0.7;
        public int BorderRadius { get; set; } = 4;
    }

}
