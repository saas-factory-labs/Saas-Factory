@* all injections need to be at the top of the file or it wont work! *@
@implements IDisposable
@inject IDialogService DialogService
@using Microsoft.AspNetCore.Components.Authorization
@inject NavigationManager NavigationManager
@inject AuthenticationStateProvider AuthenticationStateProvider

<MudThemeProvider @bind-IsDarkMode="@_isDarkMode" Theme="_theme"/>

<MudAppBar Elevation="1">
    <MudIconButton Icon="@Icons.Material.Filled.Menu" Color="Color.Inherit" Edge="Edge.Start" OnClick="@ToggleDrawer"/>
    <MudSpacer/>

    @* <!-- Search Button --> *@
    <MudButton Class="mr-2" Size="Size.Medium" StartIcon="@Icons.Material.Filled.Search" OnClick="OpenDialogAsync"
               Variant="Variant.Filled"></MudButton>

    <!-- Notifications Menu -->
    <MudMenu Class="mr-2" StartIcon="@Icons.Material.Filled.Notifications" Color="Color.Default"
             Variant="Variant.Filled" IconColor="Color.Primary">
        <MudMenuItem>Notification 1</MudMenuItem>
        <MudMenuItem>Notification 2</MudMenuItem>
        <MudMenuItem>Notification 3</MudMenuItem>
    </MudMenu>

    <!-- Info Menu -->
    <MudMenu Class="mr-2" StartIcon="@Icons.Material.Filled.Info" Color="Color.Default" Variant="Variant.Filled"
             IconColor="Color.Default">
        <MudMenuItem>Documentation</MudMenuItem>
        <MudMenuItem>Support Site</MudMenuItem>
        <MudMenuItem>Contact Us</MudMenuItem>
    </MudMenu>

    <!-- Theme Toggle Button -->
    <MudButton StartIcon="@(_isDarkMode ? Icons.Material.Filled.WbSunny : Icons.Material.Filled.Nightlight)"
               OnClick="ChangeTheme" Color="Color.Inherit" Variant="Variant.Text">
    </MudButton>

    @if (_isAuthenticated)
    {
        <MudMenu StartIcon="@Icons.Material.Filled.Person" EndIcon="@Icons.Material.Filled.KeyboardArrowDown" Label="Account"
                Color="Color.Primary" Variant="Variant.Filled" IconColor="Color.Default">
            <MudMenuItem>
                <MudNavLink Href="/account-settings" Icon="@Icons.Material.Filled.Settings">Account Settings
                </MudNavLink>
            </MudMenuItem>
            <MudMenuItem Href="/SignOut">
                <div class="d-flex align-center">
                    <MudIcon Icon="@Icons.Material.Filled.Logout" Class="mr-2" />
                    Sign Out
                </div>
            </MudMenuItem>
        </MudMenu>
    }
    else
    {
        <MudButton Href="/login" Variant="Variant.Filled" Color="Color.Primary">Login</MudButton>
    }

    @ChildContent

</MudAppBar>

@code{
    [Parameter] public EventCallback OnToggleDrawer { get; set; }
    [Parameter] public required RenderFragment ChildContent { get; set; }

    private bool _isDarkMode = true; // Default to dark mode
    private bool _isAuthenticated = false;
    
    protected override async Task OnInitializedAsync()
    {
        await CheckAuthenticationState();
        
        // Subscribe to authentication state changes
        AuthenticationStateProvider.AuthenticationStateChanged += OnAuthenticationStateChanged;
    }
    
    private async void OnAuthenticationStateChanged(Task<AuthenticationState> task)
    {
        await CheckAuthenticationState();
        await InvokeAsync(StateHasChanged);
    }
    
    private async Task CheckAuthenticationState()
    {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        _isAuthenticated = authState.User?.Identity?.IsAuthenticated ?? false;
        Console.WriteLine($"[Appbar] Authentication state checked: {_isAuthenticated}");
    }
    
    public void Dispose()
    {
        AuthenticationStateProvider.AuthenticationStateChanged -= OnAuthenticationStateChanged;
    }

    private void ToggleDrawer()
    {
        if (OnToggleDrawer.HasDelegate)
        {
            // Invoke the parent's method to toggle the Sidebar
            OnToggleDrawer.InvokeAsync();
        }
    }

    private Task OpenDialogAsync()
    {
        var options = new DialogOptions { CloseOnEscapeKey = true };
        return DialogService.ShowAsync<AppbarSearchDialog>("Search Dialog", options);
    }

    private MudTheme _theme = new();

    private void ChangeTheme()
    {
        _isDarkMode = !_isDarkMode; // Toggle the dark mode state
        Console.WriteLine($"Theme toggled. IsDarkMode: {_isDarkMode}");
    }

    // Handle logout action - Full Logto sign-out
    private void HandleLogoutDirectly()
    {
        Console.WriteLine("========================================");
        Console.WriteLine("[Appbar] LOGOUT BUTTON CLICKED!");
        Console.WriteLine("========================================");
        
        try
        {
            // Full sign-out from both app and Logto IdP
            Console.WriteLine("[Appbar] Navigating to /SignOut endpoint (Full Logto sign-out)");
            
            // Navigate to the signout endpoint which handles full Logto logout
            // This will redirect to Logto's end session endpoint, sign out from IdP,
            // and then redirect back to /login
            NavigationManager.NavigateTo("/SignOut", forceLoad: true);
            
            Console.WriteLine("[Appbar] Navigation to /SignOut initiated");
        }
        catch (Exception ex)
        {
            Console.Error.WriteLine($"[Appbar] ERROR during logout: {ex.Message}");
            Console.Error.WriteLine($"[Appbar] Stack: {ex.StackTrace}");
            
            // Fallback - just navigate to login
            Console.WriteLine("[Appbar] Attempting fallback navigation to /login...");
            NavigationManager.NavigateTo("/login", forceLoad: true);
        }
        
        Console.WriteLine("[Appbar] HandleLogoutDirectly END");
        Console.WriteLine("========================================");
    }

    // Handle logout action
    private async Task HandleLogoutWithDelay()
    {
        Console.WriteLine("========================================");
        Console.WriteLine("[Appbar] HandleLogoutWithDelay - LOGOUT BUTTON CLICKED");
        Console.WriteLine("[Appbar] Giving menu time to close before logout...");
        Console.WriteLine("========================================");
        
        // Small delay to let the menu close properly
        await Task.Delay(100);
        
        HandleLogoutDirectly();
    }
    
    private void HandleLogout()
    {
        Console.WriteLine("========================================");
        Console.WriteLine("[Appbar] HandleLogout - STARTING LOGOUT PROCESS");
        Console.WriteLine("========================================");
        
        HandleLogoutDirectly();
        
        Console.WriteLine("[Appbar] HandleLogout - END");
        Console.WriteLine("========================================");
    }
}
