@page "/auth-status"
@using Microsoft.AspNetCore.Components.Authorization
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject NavigationManager Navigation

<PageTitle>Authentication Status</PageTitle>

<MudContainer MaxWidth="MaxWidth.Medium" Class="mt-8">
    <MudPaper Class="pa-8" Elevation="4">
        <MudText Typo="Typo.h4" Class="mb-4">Authentication Status</MudText>
        
        @if (_authState != null)
        {
            <MudText Typo="Typo.h6" Class="mb-2">Status</MudText>
            <MudChip T="string" Color="@(_isAuthenticated ? Color.Success : Color.Error)">
                @(_isAuthenticated ? "✅ Authenticated" : "❌ Not Authenticated")
            </MudChip>
            
            <MudDivider Class="my-4" />
            
            <MudText Typo="Typo.h6" Class="mb-2">User Information</MudText>
            <MudSimpleTable Dense="true">
                <tbody>
                    <tr>
                        <td><strong>Is Authenticated:</strong></td>
                        <td>@_isAuthenticated</td>
                    </tr>
                    <tr>
                        <td><strong>Identity Name:</strong></td>
                        <td>@(_authState.User?.Identity?.Name ?? "(none)")</td>
                    </tr>
                    <tr>
                        <td><strong>Authentication Type:</strong></td>
                        <td>@(_authState.User?.Identity?.AuthenticationType ?? "(none)")</td>
                    </tr>
                </tbody>
            </MudSimpleTable>
            
            <MudDivider Class="my-4" />
            
            <MudText Typo="Typo.h6" Class="mb-2">Claims (@_authState.User.Claims.Count())</MudText>
            @if (_authState.User.Claims.Any())
            {
                <MudSimpleTable Dense="true" Hover="true" Class="mt-2">
                    <thead>
                        <tr>
                            <th>Type</th>
                            <th>Value</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var claim in _authState.User.Claims)
                        {
                            <tr>
                                <td><code>@claim.Type</code></td>
                                <td>@claim.Value</td>
                            </tr>
                        }
                    </tbody>
                </MudSimpleTable>
            }
            else
            {
                <MudText Color="Color.Secondary">No claims found</MudText>
            }
            
            <MudDivider Class="my-4" />
            
            <MudText Typo="Typo.h6" Class="mb-2">Actions</MudText>
            <MudStack Row="true" Class="mt-2">
                @if (_isAuthenticated)
                {
                    <MudButton Variant="Variant.Filled" Color="Color.Error" OnClick="@(() => Navigation.NavigateTo("/SignOut", forceLoad: true))">
                        Sign Out (Full Logto Flow)
                    </MudButton>
                    <MudButton Variant="Variant.Outlined" Color="Color.Warning" OnClick="@(() => Navigation.NavigateTo("/local-logout", forceLoad: true))">
                        Local Logout Only
                    </MudButton>
                }
                else
                {
                    <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="@(() => Navigation.NavigateTo("/SignIn", forceLoad: true))">
                        Sign In
                    </MudButton>
                }
                <MudButton Variant="Variant.Text" OnClick="Refresh">
                    Refresh Status
                </MudButton>
            </MudStack>
        }
        else
        {
            <MudProgressCircular Indeterminate="true" />
        }
    </MudPaper>
</MudContainer>

@code {
    private AuthenticationState? _authState;
    private bool _isAuthenticated;
    
    protected override async Task OnInitializedAsync()
    {
        await LoadAuthState();
    }
    
    private async Task LoadAuthState()
    {
        _authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        _isAuthenticated = _authState.User?.Identity?.IsAuthenticated ?? false;
        
        Console.WriteLine("========================================");
        Console.WriteLine("[AuthStatus] Current authentication state:");
        Console.WriteLine($"[AuthStatus] Is Authenticated: {_isAuthenticated}");
        Console.WriteLine($"[AuthStatus] Identity Name: {_authState.User?.Identity?.Name ?? "(none)"}");
        Console.WriteLine($"[AuthStatus] Claims Count: {_authState.User.Claims.Count()}");
        Console.WriteLine("========================================");
    }
    
    private async Task Refresh()
    {
        await LoadAuthState();
        StateHasChanged();
    }
}

