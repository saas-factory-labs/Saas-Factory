@page "/teams"
@attribute [Authorize]
@using AppBlueprint.Contracts.B2B.Contracts.Team.Requests
@using AppBlueprint.Contracts.B2B.Contracts.Team.Responses
@using AppBlueprint.Web.Services
@using Microsoft.AspNetCore.Authorization
@inject TeamService TeamService
@inject ISnackbar Snackbar
@inject ILogger<TeamsPage> Logger

<PageTitle>Teams</PageTitle>

<MudContainer MaxWidth="MaxWidth.Large" Class="mt-4">
    <MudText Typo="Typo.h4" Class="mb-4">Teams Management</MudText>

    @if (_isLoading)
    {
        <MudProgressLinear Color="Color.Primary" Indeterminate="true" Class="my-7" />
    }
    else if (!string.IsNullOrEmpty(_errorMessage))
    {
        <MudAlert Severity="Severity.Error" Class="mb-4">@_errorMessage</MudAlert>
    }
    else
    {
        <!-- Add New Team Section -->
        <MudPaper Class="pa-4 mb-4" Elevation="2">
            <MudText Typo="Typo.h6" Class="mb-3">Add New Team</MudText>
            <MudForm @ref="_form" @bind-IsValid="@_isFormValid">
                <MudGrid>
                    <MudItem xs="12" sm="6">
                        <MudTextField @bind-Value="_newTeamName"
                                      Label="Team Name"
                                      Variant="Variant.Outlined"
                                      Required="true"
                                      RequiredError="Team name is required"
                                      MaxLength="100"
                                      Counter="100"
                                      Immediate="true" />
                    </MudItem>
                    <MudItem xs="12" sm="6">
                        <MudTextField @bind-Value="_newTeamDescription"
                                      Label="Description"
                                      Variant="Variant.Outlined"
                                      MaxLength="500"
                                      Counter="500"
                                      Lines="3" />
                    </MudItem>
                    <MudItem xs="12">
                        <MudButton Variant="Variant.Filled"
                                   Color="Color.Primary"
                                   StartIcon="@Icons.Material.Filled.Add"
                                   OnClick="AddTeamAsync"
                                   Disabled="@(!_isFormValid || _isAdding)">
                            @if (_isAdding)
                            {
                                <MudProgressCircular Class="ms-n1" Size="Size.Small" Indeterminate="true" />
                                <MudText Class="ms-2">Adding...</MudText>
                            }
                            else
                            {
                                <span>Add Team</span>
                            }
                        </MudButton>
                    </MudItem>
                </MudGrid>
            </MudForm>
        </MudPaper>

        <!-- Teams List -->
        <MudText Typo="Typo.h6" Class="mb-3">
            Teams List (@_teams.Count teams)
        </MudText>

        @if (!_teams.Any())
        {
            <MudPaper Class="pa-8 text-center" Elevation="0">
                <MudIcon Icon="@Icons.Material.Filled.Groups" Size="Size.Large" Color="Color.Default" Class="mb-2" />
                <MudText Typo="Typo.h6" Color="Color.Default">No teams yet</MudText>
                <MudText Typo="Typo.body2" Color="Color.Default">Add your first team above to get started!</MudText>
            </MudPaper>
        }
        else
        {
            <MudStack Spacing="2">
                @foreach (var team in _teams.OrderBy(t => t.Name))
                {
                    <MudPaper Class="pa-3" Elevation="1">
                        @if (_editingTeamId == team.Id)
                        {
                            <!-- Edit Mode -->
                            <MudForm @ref="_editForm" @bind-IsValid="@_isEditFormValid">
                                <MudGrid>
                                    <MudItem xs="12" sm="6">
                                        <MudTextField @bind-Value="_editTeamName"
                                                      Label="Team Name"
                                                      Variant="Variant.Outlined"
                                                      Required="true"
                                                      RequiredError="Team name is required"
                                                      MaxLength="100"
                                                      Immediate="true" />
                                    </MudItem>
                                    <MudItem xs="12" sm="6">
                                        <MudTextField @bind-Value="_editTeamDescription"
                                                      Label="Description"
                                                      Variant="Variant.Outlined"
                                                      MaxLength="500"
                                                      Lines="2" />
                                    </MudItem>
                                    <MudItem xs="12" Class="d-flex gap-2">
                                        <MudButton Variant="Variant.Filled"
                                                   Color="Color.Success"
                                                   Size="Size.Small"
                                                   StartIcon="@Icons.Material.Filled.Save"
                                                   OnClick="@(async () => await SaveTeamAsync(team.Id))"
                                                   Disabled="@(!_isEditFormValid || _isSaving)">
                                            Save
                                        </MudButton>
                                        <MudButton Variant="Variant.Outlined"
                                                   Color="Color.Default"
                                                   Size="Size.Small"
                                                   OnClick="CancelEdit"
                                                   Disabled="@_isSaving">
                                            Cancel
                                        </MudButton>
                                    </MudItem>
                                </MudGrid>
                            </MudForm>
                        }
                        else
                        {
                            <!-- View Mode -->
                            <MudGrid>
                                <MudItem xs="12" sm="8">
                                    <div>
                                        <MudText Typo="Typo.h6" Class="mb-1">
                                            @team.Name
                                        </MudText>
                                        @if (!string.IsNullOrEmpty(team.Description))
                                        {
                                            <MudText Typo="Typo.body2" Color="Color.Default">
                                                @team.Description
                                            </MudText>
                                        }
                                        @if (team.Members is not null && team.Members.Any())
                                        {
                                            <MudText Typo="Typo.caption" Color="Color.Primary" Class="mt-2">
                                                @team.Members.Count member(s)
                                            </MudText>
                                        }
                                    </div>
                                </MudItem>
                                <MudItem xs="12" sm="4" Class="d-flex align-center justify-end gap-2">
                                    <MudIconButton Icon="@Icons.Material.Filled.Edit"
                                                   Color="Color.Primary"
                                                   Size="Size.Small"
                                                   OnClick="@(() => StartEditTeam(team))"
                                                   Title="Edit" />
                                    <MudIconButton Icon="@Icons.Material.Filled.Delete"
                                                   Color="Color.Error"
                                                   Size="Size.Small"
                                                   OnClick="@(async () => await DeleteTeamAsync(team))"
                                                   Title="Delete" />
                                </MudItem>
                            </MudGrid>
                        }
                    </MudPaper>
                }
            </MudStack>
        }
    }
</MudContainer>

@code {
    private MudForm? _form;
    private MudForm? _editForm;
    private bool _isFormValid;
    private bool _isEditFormValid;
    private bool _isLoading = true;
    private bool _isAdding;
    private bool _isSaving;
    private string _errorMessage = string.Empty;
    private string _newTeamName = string.Empty;
    private string _newTeamDescription = string.Empty;
    private string _editTeamName = string.Empty;
    private string _editTeamDescription = string.Empty;
    private string? _editingTeamId = null;
    private List<TeamResponse> _teams = new();

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await LoadTeamsAsync();
            StateHasChanged();
        }
    }

    private async Task LoadTeamsAsync()
    {
        _isLoading = true;
        _errorMessage = string.Empty;

        try
        {
            var teams = await TeamService.GetTeamsAsync();
            _teams = teams.ToList();
        }
        catch (Exception ex)
        {
            _errorMessage = $"Failed to load teams: {ex.Message}";
            Logger.LogError(ex, "Error loading teams");
            Snackbar.Add(_errorMessage, Severity.Error);
        }
        finally
        {
            _isLoading = false;
        }
    }

    private async Task AddTeamAsync()
    {
        if (!_isFormValid || string.IsNullOrWhiteSpace(_newTeamName))
        {
            return;
        }

        _isAdding = true;

        try
        {
            var request = new CreateTeamRequest
                {
                    Name = _newTeamName.Trim(),
                    Description = string.IsNullOrWhiteSpace(_newTeamDescription) ? null : _newTeamDescription.Trim()
                };

            var newTeam = await TeamService.CreateTeamAsync(request);

            if (newTeam is not null)
            {
                _teams.Add(newTeam);
                _newTeamName = string.Empty;
                _newTeamDescription = string.Empty;
                await _form!.ResetAsync();
                Snackbar.Add("Team added successfully!", Severity.Success);
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error adding team");
            Snackbar.Add($"Failed to add team: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isAdding = false;
        }
    }

    private void StartEditTeam(TeamResponse team)
    {
        ArgumentNullException.ThrowIfNull(team);

        _editingTeamId = team.Id;
        _editTeamName = team.Name ?? string.Empty;
        _editTeamDescription = team.Description ?? string.Empty;
    }

    private void CancelEdit()
    {
        _editingTeamId = null;
        _editTeamName = string.Empty;
        _editTeamDescription = string.Empty;
    }

    private async Task SaveTeamAsync(string teamId)
    {
        if (!_isEditFormValid || string.IsNullOrWhiteSpace(_editTeamName))
        {
            return;
        }

        _isSaving = true;

        try
        {
            var request = new UpdateTeamRequest
                {
                    Name = _editTeamName.Trim(),
                    Description = string.IsNullOrWhiteSpace(_editTeamDescription) ? null : _editTeamDescription.Trim()
                };

            await TeamService.UpdateTeamAsync(teamId, request);

            // Update the local list
            var team = _teams.FirstOrDefault(t => t.Id == teamId);
            if (team is not null)
            {
                team.Name = request.Name;
                team.Description = request.Description;
            }

            CancelEdit();
            Snackbar.Add("Team updated successfully!", Severity.Success);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error updating team {TeamId}", teamId);
            Snackbar.Add($"Failed to update team: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isSaving = false;
        }
    }

    private async Task DeleteTeamAsync(TeamResponse team)
    {
        ArgumentNullException.ThrowIfNull(team);

        try
        {
            await TeamService.DeleteTeamAsync(team.Id);
            _teams.Remove(team);
            Snackbar.Add("Team deleted successfully!", Severity.Success);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error deleting team {TeamId}", team.Id);
            Snackbar.Add($"Failed to delete team: {ex.Message}", Severity.Error);
        }
    }
}
