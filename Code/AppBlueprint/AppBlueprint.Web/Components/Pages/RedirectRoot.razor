@page "/"
@using Microsoft.AspNetCore.Components.Authorization
@inject NavigationManager Navigation
@inject AuthenticationStateProvider AuthenticationStateProvider

@if (!string.IsNullOrEmpty(_errorMessage))
{
    <MudAlert Severity="Severity.Error" Class="mb-4">
        @_errorMessage
    </MudAlert>
}

<p>Checking authentication...</p>

@code {
    private string? _errorMessage;
    
    protected override async Task OnInitializedAsync()
    {
        // Check for authentication error in query string
        var uri = new Uri(Navigation.Uri);
        var query = System.Web.HttpUtility.ParseQueryString(uri.Query);
        var authError = query["auth-error"];
        
        if (!string.IsNullOrEmpty(authError))
        {
            _errorMessage = authError switch
            {
                "session-expired" => "Your login session expired. Please sign in again.",
                "redirect-uri-mismatch" => "âŒ Redirect URI not configured in Logto. Please add 'https://appblueprint-web-staging.up.railway.app/callback' to your Logto application's Redirect URIs.",
                "logto-unreachable" => "Cannot connect to the authentication provider. Please check your network connection.",
                "network-failed" => "Network error during authentication. Please try again.",
                "auth-failed" => "Authentication failed. Please try again or contact support.",
                "remote-failed" => "Authentication service error. This may be a configuration issue. Check the logs for details.",
                "challenge-failed" => "Failed to initiate authentication. Please try again.",
                _ => "Authentication error occurred. Please try again or check the application logs."
            };
            
            Console.WriteLine($"[RedirectRoot] Authentication error: {authError} - {_errorMessage}");
        }
        
        // Check if user is authenticated using ASP.NET Core auth state
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;
        var isAuthenticated = user?.Identity?.IsAuthenticated == true;
        
        Console.WriteLine($"[RedirectRoot] User authenticated: {isAuthenticated}, Name: {user?.Identity?.Name}");
        
        if (isAuthenticated)
        {
            // Authenticated users go to dashboard
            Console.WriteLine("[RedirectRoot] Redirecting to /dashboard");
            Navigation.NavigateTo("/dashboard", forceLoad: false);
        }
        else
        {
            // Non-authenticated users go to login
            Console.WriteLine("[RedirectRoot] Redirecting to /login");
            Navigation.NavigateTo("/login", forceLoad: false);
        }
    }
}

