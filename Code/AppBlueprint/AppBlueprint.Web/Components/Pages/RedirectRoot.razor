@page "/"
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Authorization
@attribute [AllowAnonymous]
@inject NavigationManager Navigation
@inject AuthenticationStateProvider AuthenticationStateProvider

@if (!string.IsNullOrEmpty(_errorMessage))
{
    <div class="mb-4 p-4 text-red-700 bg-red-100 rounded-lg dark:bg-red-200 dark:text-red-800" role="alert">
        @_errorMessage
    </div>
}

<div class="flex justify-center items-center h-screen">
    <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"></div>
    <span class="ml-4 text-lg font-semibold text-gray-700 dark:text-gray-200">Checking authentication...</span>
</div>

@code {
    private string? _errorMessage;
    
    protected override async Task OnInitializedAsync()
    {
        Console.WriteLine("========================================");
        Console.WriteLine("[RedirectRoot] OnInitializedAsync START");
        Console.WriteLine("========================================");
        
        // Check for authentication error in query string
        var uri = new Uri(Navigation.Uri);
        var query = System.Web.HttpUtility.ParseQueryString(uri.Query);
        var authError = query["auth-error"];
        
        if (!string.IsNullOrEmpty(authError))
        {
            _errorMessage = authError switch
            {
                "session-expired" => "Your login session expired. Please sign in again.",
                "redirect-uri-mismatch" => "❌ Redirect URI not configured in Logto. Please add the correct redirect URI to your Logto application's settings.",
                "logto-unreachable" => "Cannot connect to the authentication provider. Please check your network connection.",
                "network-failed" => "Network error during authentication. Please try again.",
                "auth-failed" => "Authentication failed. Please try again or contact support.",
                "remote-failed" => "Authentication service error. This may be a configuration issue. Check the logs for details.",
                "challenge-failed" => "Failed to initiate authentication. Please try again.",
                _ => "Authentication error occurred. Please try again or check the application logs."
            };
            
            Console.WriteLine($"[RedirectRoot] ❌ Authentication error: {authError}");
            Console.WriteLine($"[RedirectRoot] Error message: {_errorMessage}");
        }
        
        // Check if user is authenticated using ASP.NET Core auth state
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;
        var isAuthenticated = user.Identity?.IsAuthenticated == true;
        
        Console.WriteLine($"[RedirectRoot] Authentication check:");
        Console.WriteLine($"[RedirectRoot]   - Is Authenticated: {isAuthenticated}");
        Console.WriteLine($"[RedirectRoot]   - User Name: {user.Identity?.Name ?? "(none)"}");
        Console.WriteLine($"[RedirectRoot]   - Claims Count: {user.Claims.Count()}");
        
        if (isAuthenticated)
        {
            // Authenticated users go to dashboard
            Console.WriteLine("[RedirectRoot] ✅ User is authenticated - redirecting to /dashboard");
            Console.WriteLine("========================================");
            Navigation.NavigateTo("/dashboard", forceLoad: false);
        }
        else
        {
            // Non-authenticated users go to login
            Console.WriteLine("[RedirectRoot] ❌ User is NOT authenticated - redirecting to /login");
            Console.WriteLine("========================================");
            Navigation.NavigateTo("/signin", forceLoad: false);
        }
    }
}

