@page "/auth-demo"
@using AppBlueprint.Infrastructure.Authorization
@inject IUserAuthenticationProvider AuthProvider
@inject ITokenStorageService TokenStorage

<PageTitle>Authentication Demo (DEPRECATED)</PageTitle>

<MudAlert Severity="Severity.Warning" Variant="Variant.Filled" Class="mb-4">
    <MudText Typo="Typo.h6">‚ö†Ô∏è DEPRECATED DEMO PAGE</MudText>
    <MudText Typo="Typo.body2" Class="mt-2">
        This page demonstrates the <strong>legacy custom authentication system</strong> which is deprecated.
    </MudText>
    <MudText Typo="Typo.body2" Class="mt-2">
        The application now uses <strong>ASP.NET Core authentication with Logto SDK</strong>.
    </MudText>
    <MudText Typo="Typo.body2" Class="mt-2">
        This page is kept for reference only and will be removed in a future version.
    </MudText>
    <MudDivider Class="my-2" />
    <MudText Typo="Typo.body2">
        <strong>Current Authentication System:</strong> Use the "Sign In with Logto" button on the login page.
    </MudText>
</MudAlert>

<h3>JWT Token Demo - Blazor Server (Legacy)</h3>

<MudCard Class="my-4">
    <MudCardContent>
        <MudText Typo="Typo.h6">Current Authentication Status</MudText>
        <MudDivider Class="my-2" />
        
        @if (isAuthenticated)
        {
            <MudAlert Severity="Severity.Success">‚úÖ Authenticated</MudAlert>
            
            <MudText Class="mt-4"><strong>Access Token:</strong></MudText>
            <MudTextField @bind-Value="currentToken" 
                         Label="JWT Token" 
                         Variant="Variant.Outlined" 
                         Lines="5"
                         ReadOnly="true"
                         Class="mt-2" />
            
            <MudText Class="mt-2" Typo="Typo.caption">
                Token Length: @(currentToken?.Length ?? 0) characters
            </MudText>
            
            <MudButton Variant="Variant.Filled" 
                      Color="Color.Primary" 
                      StartIcon="@Icons.Material.Filled.ContentCopy"
                      OnClick="CopyTokenToClipboard"
                      Class="mt-2">
                Copy Token
            </MudButton>
            
            <MudButton Variant="Variant.Outlined" 
                      Color="Color.Secondary" 
                      StartIcon="@Icons.Material.Filled.Refresh"
                      OnClick="RefreshToken"
                      Class="mt-2 ml-2">
                Refresh Display
            </MudButton>
        }
        else
        {
            <MudAlert Severity="Severity.Warning">‚ö†Ô∏è Not Authenticated</MudAlert>
            <MudText Class="mt-2">Please log in to get a JWT token.</MudText>
        }
    </MudCardContent>
</MudCard>

@if (isAuthenticated)
{
    <MudCard Class="my-4">
        <MudCardContent>
            <MudText Typo="Typo.h6">Test API Call with Token</MudText>
            <MudDivider Class="my-2" />
            
            <MudButton Variant="Variant.Filled" 
                      Color="Color.Primary" 
                      OnClick="TestProtectedEndpoint"
                      Disabled="isLoading">
                @if (isLoading)
                {
                    <MudProgressCircular Size="Size.Small" Indeterminate="true" />
                    <MudText Class="ml-2">Testing...</MudText>
                }
                else
                {
                    <MudText>Test Protected Endpoint</MudText>
                }
            </MudButton>
            
            @if (!string.IsNullOrEmpty(apiResponse))
            {
                <MudAlert Severity="@apiSeverity" Class="mt-4">
                    @apiResponse
                </MudAlert>
            }
        </MudCardContent>
    </MudCard>
    
    <MudCard Class="my-4">
        <MudCardContent>
            <MudText Typo="Typo.h6">How to Use This Token</MudText>
            <MudDivider Class="my-2" />
            
            <MudText Class="mt-2"><strong>1. In PowerShell:</strong></MudText>
            <MudPaper Class="pa-2 mt-2" Elevation="0">
                <code style="font-size: 12px;">
                    $token = "@(currentToken?.Substring(0, Math.Min(50, currentToken?.Length ?? 0)))..."<br/>
                    Invoke-RestMethod -Uri 'https://localhost:5002/api/v1/authtest/protected' `<br/>
                    &nbsp;&nbsp;-Headers @@{Authorization="Bearer $token"} -SkipCertificateCheck
                </code>
            </MudPaper>
            
            <MudText Class="mt-3"><strong>2. In Swagger:</strong></MudText>
            <MudStack Spacing="1" Class="mt-2">
                <MudText>
                    <MudIcon Icon="@Icons.Material.Filled.ArrowRight" Size="Size.Small" /> 
                    Go to https://localhost:5002/swagger
                </MudText>
                <MudText>
                    <MudIcon Icon="@Icons.Material.Filled.ArrowRight" Size="Size.Small" /> 
                    Click "Authorize" button (lock icon)
                </MudText>
                <MudText>
                    <MudIcon Icon="@Icons.Material.Filled.ArrowRight" Size="Size.Small" /> 
                    Enter: Bearer [paste token]
                </MudText>
                <MudText>
                    <MudIcon Icon="@Icons.Material.Filled.ArrowRight" Size="Size.Small" /> 
                    Test the protected endpoints
                </MudText>
            </MudStack>
            
            <MudText Class="mt-3"><strong>3. In cURL:</strong></MudText>
            <MudPaper Class="pa-2 mt-2" Elevation="0">
                <code style="font-size: 12px;">
                    curl -H "Authorization: Bearer [token]" https://localhost:5002/api/v1/authtest/protected
                </code>
            </MudPaper>
        </MudCardContent>
    </MudCard>
}

<MudCard Class="my-4">
    <MudCardContent>
        <MudText Typo="Typo.h6">Login Form (Mock Provider)</MudText>
        <MudDivider Class="my-2" />
        
        @if (!isAuthenticated)
        {
            <MudTextField @bind-Value="email" 
                         Label="Email" 
                         Variant="Variant.Outlined"
                         Class="mt-2" />
            
            <MudTextField @bind-Value="password" 
                         Label="Password" 
                         Variant="Variant.Outlined"
                         InputType="InputType.Password"
                         Class="mt-2" />
            
            <MudButton Variant="Variant.Filled" 
                      Color="Color.Primary" 
                      OnClick="Login"
                      Disabled="isLoading"
                      Class="mt-3">
                @if (isLoading)
                {
                    <MudProgressCircular Size="Size.Small" Indeterminate="true" />
                    <MudText Class="ml-2">Logging in...</MudText>
                }
                else
                {
                    <MudText>Login</MudText>
                }
            </MudButton>
            
            <MudText Typo="Typo.caption" Class="mt-2">
                Tip: Use any email/password with Mock provider
            </MudText>
        }
        else
        {
            <MudButton Variant="Variant.Outlined" 
                      Color="Color.Error" 
                      OnClick="Logout"
                      Class="mt-2">
                Logout
            </MudButton>
        }
        
        @if (!string.IsNullOrEmpty(loginMessage))
        {
            <MudAlert Severity="@loginSeverity" Class="mt-3">
                @loginMessage
            </MudAlert>
        }
    </MudCardContent>
</MudCard>

@code {
    private bool isAuthenticated;
    private string? currentToken;
    private string email = "test@example.com";
    private string password = "password";
    private bool isLoading;
    private string? loginMessage;
    private Severity loginSeverity = Severity.Info;
    private string? apiResponse;
    private Severity apiSeverity = Severity.Info;
    private bool isInitialized;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            await RefreshToken();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error initializing auth demo: {ex.Message}");
        }
        finally
        {
            isInitialized = true;
            StateHasChanged();
        }
    }

    private async Task RefreshToken()
    {
        try
        {
            isAuthenticated = AuthProvider.IsAuthenticated();
            
            if (isAuthenticated)
            {
                currentToken = await TokenStorage.GetTokenAsync();
            }
            else
            {
                currentToken = null;
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error refreshing token: {ex.Message}");
            isAuthenticated = false;
            currentToken = null;
        }
        finally
        {
            StateHasChanged();
        }
    }

    private async Task Login()
    {
        isLoading = true;
        loginMessage = null;
        StateHasChanged();

        try
        {
            var success = await AuthProvider.LoginAsync(email, password);
            
            if (success)
            {
                loginMessage = "‚úÖ Login successful! Token generated.";
                loginSeverity = Severity.Success;
                await RefreshToken();
            }
            else
            {
                loginMessage = "‚ùå Login failed. Please try again.";
                loginSeverity = Severity.Error;
            }
        }
        catch (Exception ex)
        {
            loginMessage = $"‚ùå Error: {ex.Message}";
            loginSeverity = Severity.Error;
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private async Task Logout()
    {
        await AuthProvider.LogoutAsync();
        currentToken = null;
        isAuthenticated = false;
        loginMessage = "Logged out successfully.";
        loginSeverity = Severity.Info;
        StateHasChanged();
    }

    private async Task CopyTokenToClipboard()
    {
        // Note: This requires JavaScript interop for clipboard access
        // For now, just show a message
        loginMessage = "üí° Token displayed above - copy it manually or use the examples below";
        loginSeverity = Severity.Info;
        StateHasChanged();
    }

    private async Task TestProtectedEndpoint()
    {
        isLoading = true;
        apiResponse = null;
        StateHasChanged();

        try
        {
            using var httpClient = new HttpClient();
            httpClient.DefaultRequestHeaders.Authorization = 
                new System.Net.Http.Headers.AuthenticationHeaderValue("Bearer", currentToken);
            
            var response = await httpClient.GetAsync("https://localhost:5002/api/v1/authtest/protected");
            
            if (response.IsSuccessStatusCode)
            {
                var content = await response.Content.ReadAsStringAsync();
                apiResponse = $"‚úÖ SUCCESS (200 OK)\n\nResponse: {content}";
                apiSeverity = Severity.Success;
            }
            else
            {
                apiResponse = $"‚ùå FAILED ({(int)response.StatusCode} {response.ReasonPhrase})";
                apiSeverity = Severity.Error;
            }
        }
        catch (Exception ex)
        {
            apiResponse = $"‚ùå Error: {ex.Message}";
            apiSeverity = Severity.Error;
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }
}
