@page "/onboarding"
@layout AuthLayout
@attribute [Microsoft.AspNetCore.Authorization.Authorize]
@using AppBlueprint.Web.Models.Auth
@using AppBlueprint.Infrastructure.Authorization
@using AppBlueprint.Application.Services
@using AppBlueprint.SharedKernel
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Http
@inject NavigationManager Navigation
@inject IJSRuntime JSRuntime
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject IAuthenticationTokenService AuthenticationTokenService
@inject ISignupService SignupService
@inject IHttpContextAccessor HttpContextAccessor
@inject ILogger<Onboarding> Logger

<main class="min-h-screen bg-gradient-to-br from-indigo-50 via-white to-cyan-50 dark:from-slate-950 dark:via-slate-900 dark:to-slate-950">
    <div class="relative min-h-screen flex flex-col justify-center py-20 px-4">
        <div class="w-full max-w-4xl mx-auto">
            
            @if (isProcessing)
            {
                <!-- Loading State -->
                <div class="text-center">
                    <div class="mb-6">
                        <div class="animate-spin rounded-full h-16 w-16 border-b-4 border-indigo-600 mx-auto"></div>
                    </div>
                    <h1 class="text-2xl font-bold text-gray-800 dark:text-gray-100 mb-2">
                        @loadingMessage
                    </h1>
                    <p class="text-gray-600 dark:text-gray-400">
                        Please wait...
                    </p>
                </div>
            }
            else if (!string.IsNullOrEmpty(errorMessage))
            {
                <!-- Error State -->
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl p-8">
                    <div class="text-center mb-6">
                        <div class="w-16 h-16 bg-red-100 dark:bg-red-900/20 rounded-full flex items-center justify-center mx-auto mb-4">
                            <svg class="w-8 h-8 text-red-600 dark:text-red-400" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
                            </svg>
                        </div>
                        <h1 class="text-2xl font-bold text-gray-800 dark:text-gray-100 mb-2">Setup Failed</h1>
                        <p class="text-red-600 dark:text-red-400 mb-6">@errorMessage</p>
                    </div>
                    <button @onclick="RetrySetup" class="w-full px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors">
                        Try Again
                    </button>
                </div>
            }
            else if (showAccountTypeSelection)
            {
                <!-- Account Type Selection -->
                <div class="text-center mb-12">
                    <h1 class="text-5xl font-black mb-4 bg-gradient-to-r from-blue-600 via-cyan-600 to-indigo-600 bg-clip-text text-transparent">
                        Welcome! ðŸŽ‰
                    </h1>
                    <p class="text-xl text-gray-600 dark:text-gray-300">Let's set up your account</p>
                </div>

                <div class="grid md:grid-cols-2 gap-6">
                    <!-- Personal Account -->
                    <div class="group bg-white dark:bg-slate-800 rounded-2xl shadow-lg hover:shadow-xl p-8 border-2 border-blue-100 dark:border-blue-900 hover:border-blue-400 dark:hover:border-blue-500 hover:-translate-y-1 transition-all duration-300 cursor-pointer"
                         @onclick="@(() => SelectAccountType("personal"))">
                        <div class="text-center mb-6">
                            <div class="inline-flex items-center justify-center w-20 h-20 rounded-2xl bg-gradient-to-br from-blue-500 to-cyan-500 mb-4 shadow-lg">
                                <svg class="w-12 h-12 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                                </svg>
                            </div>
                            <h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-2">Personal Account</h2>
                            <p class="text-sm text-blue-600 dark:text-blue-400 font-semibold uppercase">For Individuals</p>
                        </div>
                        <ul class="space-y-3 mb-6">
                            <li class="flex items-center text-gray-700 dark:text-gray-300">
                                <svg class="w-5 h-5 text-green-500 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                                </svg>
                                Personal workspace
                            </li>
                            <li class="flex items-center text-gray-700 dark:text-gray-300">
                                <svg class="w-5 h-5 text-green-500 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                                </svg>
                                Individual features
                            </li>
                            <li class="flex items-center text-gray-700 dark:text-gray-300">
                                <svg class="w-5 h-5 text-green-500 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                                </svg>
                                Perfect for personal use
                            </li>
                        </ul>
                        <div class="w-full py-3 px-6 bg-gradient-to-r from-blue-600 to-cyan-600 text-white font-bold rounded-xl shadow-lg text-center">
                            Choose Personal
                        </div>
                    </div>

                    <!-- Business Account -->
                    <div class="group bg-white dark:bg-slate-800 rounded-2xl shadow-lg hover:shadow-xl p-8 border-2 border-purple-100 dark:border-purple-900 hover:border-purple-400 dark:hover:border-purple-500 hover:-translate-y-1 transition-all duration-300 cursor-pointer"
                         @onclick="@(() => SelectAccountType("business"))">
                        <div class="text-center mb-6">
                            <div class="inline-flex items-center justify-center w-20 h-20 rounded-2xl bg-gradient-to-br from-purple-500 to-pink-500 mb-4 shadow-lg">
                                <svg class="w-12 h-12 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />
                                </svg>
                            </div>
                            <h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-2">Business Account</h2>
                            <p class="text-sm text-purple-600 dark:text-purple-400 font-semibold uppercase">For Organizations</p>
                        </div>
                        <ul class="space-y-3 mb-6">
                            <li class="flex items-center text-gray-700 dark:text-gray-300">
                                <svg class="w-5 h-5 text-green-500 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                                </svg>
                                Team collaboration
                            </li>
                            <li class="flex items-center text-gray-700 dark:text-gray-300">
                                <svg class="w-5 h-5 text-green-500 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                                </svg>
                                Advanced features
                            </li>
                            <li class="flex items-center text-gray-700 dark:text-gray-300">
                                <svg class="w-5 h-5 text-green-500 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                                </svg>
                                Organization management
                            </li>
                        </ul>
                        <div class="w-full py-3 px-6 bg-gradient-to-r from-purple-600 to-pink-600 text-white font-bold rounded-xl shadow-lg text-center">
                            Choose Business
                        </div>
                    </div>
                </div>
            }
            else if (showPersonalForm)
            {
                <!-- Personal Account Form -->
                <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-xl p-8">
                    <div class="text-center mb-8">
                        <div class="inline-flex items-center justify-center w-16 h-16 rounded-2xl bg-gradient-to-br from-blue-500 to-cyan-500 mb-4">
                            <svg class="w-10 h-10 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                            </svg>
                        </div>
                        <h1 class="text-3xl font-bold text-gray-900 dark:text-white mb-2">Personal Account Setup</h1>
                        <p class="text-gray-600 dark:text-gray-400">Tell us a bit about yourself</p>
                    </div>

                    <EditForm Model="@personalModel" OnValidSubmit="@CreatePersonalAccountAsync" class="space-y-6">
                        <DataAnnotationsValidator />
                        
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">First Name</label>
                            <InputText @bind-Value="personalModel.FirstName" class="w-full px-4 py-3 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="John" />
                            <ValidationMessage For="@(() => personalModel.FirstName)" class="text-red-500 text-sm mt-1" />
                        </div>

                        <div>
                            <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">Last Name</label>
                            <InputText @bind-Value="personalModel.LastName" class="w-full px-4 py-3 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Doe" />
                            <ValidationMessage For="@(() => personalModel.LastName)" class="text-red-500 text-sm mt-1" />
                        </div>

                        <div class="flex items-start">
                            <div class="flex items-center h-5">
                                <InputCheckbox @bind-Value="personalModel.AcceptTerms" id="personal-terms" class="w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500 dark:focus:ring-blue-600 dark:ring-offset-gray-800 focus:ring-2 dark:bg-gray-700 dark:border-gray-600" />
                            </div>
                            <div class="ml-3 text-sm">
                                <label for="personal-terms" class="text-gray-700 dark:text-gray-300">
                                    I accept the <a href="/terms" target="_blank" class="text-blue-600 dark:text-blue-400 hover:underline">Terms and Conditions</a>
                                </label>
                                <ValidationMessage For="@(() => personalModel.AcceptTerms)" class="text-red-500 text-xs mt-1 block" />
                            </div>
                        </div>

                        <div class="flex gap-4">
                            <button type="button" @onclick="BackToAccountTypeSelection" class="flex-1 px-6 py-3 border-2 border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors font-semibold">
                                Back
                            </button>
                            <button type="submit" class="flex-1 px-6 py-3 bg-gradient-to-r from-blue-600 to-cyan-600 hover:from-blue-700 hover:to-cyan-700 text-white rounded-lg shadow-lg hover:shadow-xl transition-all font-semibold">
                                Create Account
                            </button>
                        </div>
                    </EditForm>
                </div>
            }
            else if (showBusinessForm)
            {
                <!-- Business Account Form -->
                <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-xl p-8">
                    <div class="text-center mb-8">
                        <div class="inline-flex items-center justify-center w-16 h-16 rounded-2xl bg-gradient-to-br from-purple-500 to-pink-500 mb-4">
                            <svg class="w-10 h-10 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />
                            </svg>
                        </div>
                        <h1 class="text-3xl font-bold text-gray-900 dark:text-white mb-2">Business Account Setup</h1>
                        <p class="text-gray-600 dark:text-gray-400">Tell us about your organization</p>
                    </div>

                    <EditForm Model="@businessModel" OnValidSubmit="@CreateBusinessAccountAsync" class="space-y-6">
                        <DataAnnotationsValidator />
                        
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">Company Name</label>
                            <InputText @bind-Value="businessModel.CompanyName" class="w-full px-4 py-3 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-purple-500 focus:border-transparent" placeholder="Acme Inc." />
                            <ValidationMessage For="@(() => businessModel.CompanyName)" class="text-red-500 text-sm mt-1" />
                        </div>

                        <div>
                            <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">Country</label>
                            <InputText @bind-Value="businessModel.Country" class="w-full px-4 py-3 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-purple-500 focus:border-transparent" placeholder="United States" />
                            <ValidationMessage For="@(() => businessModel.Country)" class="text-red-500 text-sm mt-1" />
                        </div>

                        <div class="grid md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">First Name</label>
                                <InputText @bind-Value="businessModel.FirstName" class="w-full px-4 py-3 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-purple-500 focus:border-transparent" placeholder="John" />
                                <ValidationMessage For="@(() => businessModel.FirstName)" class="text-red-500 text-sm mt-1" />
                            </div>

                            <div>
                                <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">Last Name</label>
                                <InputText @bind-Value="businessModel.LastName" class="w-full px-4 py-3 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-purple-500 focus:border-transparent" placeholder="Doe" />
                                <ValidationMessage For="@(() => businessModel.LastName)" class="text-red-500 text-sm mt-1" />
                            </div>
                        </div>

                        <div class="flex items-start">
                            <div class="flex items-center h-5">
                                <InputCheckbox @bind-Value="businessModel.AcceptTerms" id="business-terms" class="w-4 h-4 text-purple-600 bg-gray-100 border-gray-300 rounded focus:ring-purple-500 dark:focus:ring-purple-600 dark:ring-offset-gray-800 focus:ring-2 dark:bg-gray-700 dark:border-gray-600" />
                            </div>
                            <div class="ml-3 text-sm">
                                <label for="business-terms" class="text-gray-700 dark:text-gray-300">
                                    I accept the <a href="/terms" target="_blank" class="text-purple-600 dark:text-purple-400 hover:underline">Terms and Conditions</a>
                                </label>
                                <ValidationMessage For="@(() => businessModel.AcceptTerms)" class="text-red-500 text-xs mt-1 block" />
                            </div>
                        </div>

                        <div class="flex gap-4">
                            <button type="button" @onclick="BackToAccountTypeSelection" class="flex-1 px-6 py-3 border-2 border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors font-semibold">
                                Back
                            </button>
                            <button type="submit" class="flex-1 px-6 py-3 bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-700 hover:to-pink-700 text-white rounded-lg shadow-lg hover:shadow-xl transition-all font-semibold">
                                Create Account
                            </button>
                        </div>
                    </EditForm>
                </div>
            }
            else if (isSuccess)
            {
                <!-- Success State -->
                <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-xl p-8">
                    <div class="text-center">
                        <div class="w-20 h-20 bg-green-100 dark:bg-green-900/20 rounded-full flex items-center justify-center mx-auto mb-6">
                            <svg class="w-12 h-12 text-green-600 dark:text-green-400" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
                            </svg>
                        </div>
                        <h1 class="text-3xl font-bold text-gray-900 dark:text-white mb-4">Account Created! ðŸŽ‰</h1>
                        <p class="text-lg text-gray-600 dark:text-gray-400 mb-8">
                            Your @(selectedAccountType == "personal" ? "personal" : "business") account has been set up successfully.
                        </p>
                        <div class="bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-lg p-6 mb-6">
                            <p class="text-sm text-blue-800 dark:text-blue-200 mb-2">
                                <strong>Important:</strong> Please sign out and sign in again to activate your account.
                            </p>
                            <p class="text-sm text-blue-700 dark:text-blue-300">
                                This updates your session with the new account information.
                            </p>
                        </div>
                        <a href="/auth/signout" class="inline-block px-8 py-3 bg-gradient-to-r from-blue-600 to-cyan-600 hover:from-blue-700 hover:to-cyan-700 text-white rounded-lg shadow-lg hover:shadow-xl transition-all font-semibold">
                            Sign Out & Continue
                        </a>
                    </div>
                </div>
            }
        </div>
    </div>
</main>

@code {
    private bool showAccountTypeSelection = true;
    private bool showPersonalForm;
    private bool showBusinessForm;
    private bool isProcessing;
    private bool isSuccess;
    private string errorMessage = string.Empty;
    private string loadingMessage = "Setting up your account...";
    private string selectedAccountType = string.Empty;

    private PersonalSignupModel personalModel = new();
    private BusinessSignupModel businessModel = new();

    protected override async Task OnInitializedAsync()
    {
        try
        {
            Logger.LogInformation("[Onboarding] Page loaded");
            
            // Check if user already has a tenant
            var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
            var user = authState.User;
            string? tenantIdClaim = user.FindFirst("tenant_id")?.Value;
            
            if (!string.IsNullOrEmpty(tenantIdClaim))
            {
                Logger.LogInformation("[Onboarding] User already has tenant_id: {TenantId} - redirecting to dashboard", tenantIdClaim);
                Navigation.NavigateTo("/", forceLoad: true);
                return;
            }

            Logger.LogInformation("[Onboarding] User needs to set up account");
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "[Onboarding] Error during initialization");
            errorMessage = "An unexpected error occurred. Please try again.";
        }
    }

    private void SelectAccountType(string accountType)
    {
        selectedAccountType = accountType;
        showAccountTypeSelection = false;
        
        if (accountType == "personal")
        {
            showPersonalForm = true;
        }
        else
        {
            showBusinessForm = true;
        }
    }

    private void BackToAccountTypeSelection()
    {
        showPersonalForm = false;
        showBusinessForm = false;
        showAccountTypeSelection = true;
        selectedAccountType = string.Empty;
    }

    private async Task CreatePersonalAccountAsync()
    {
        try
        {
            isProcessing = true;
            loadingMessage = "Creating your personal workspace...";
            StateHasChanged();

            var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
            var user = authState.User;

            string logtoUserId = user.FindFirst("sub")?.Value 
                                ?? user.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value 
                                ?? throw new InvalidOperationException("No user ID found in claims");
            
            string email = user.FindFirst("email")?.Value 
                          ?? user.FindFirst(System.Security.Claims.ClaimTypes.Email)?.Value 
                          ?? throw new InvalidOperationException("No email found in claims");

            Logger.LogInformation("[Onboarding] Creating Personal tenant for {Email}", email);

            string? ipAddress = HttpContextAccessor.HttpContext?.Connection.RemoteIpAddress?.ToString();
            string? userAgent = HttpContextAccessor.HttpContext?.Request.Headers["User-Agent"].ToString();

            SignupResult result = await SignupService.CreateTenantAndUserAsync(new SignupRequest
            {
                TenantId = PrefixedUlid.Generate("tenant"),
                TenantName = $"{personalModel.FirstName} {personalModel.LastName}",
                UserId = PrefixedUlid.Generate("user"),
                FirstName = personalModel.FirstName,
                LastName = personalModel.LastName,
                Email = email,
                ExternalAuthId = logtoUserId,
                IpAddress = ipAddress,
                UserAgent = userAgent,
                TenantType = 0 // Personal (B2C)
            });

            Logger.LogInformation(
                "[Onboarding] Personal account created - TenantId: {TenantId}, UserId: {UserId}",
                result.TenantId, result.UserId);

            // Update loading message and trigger authentication refresh
            loadingMessage = "Account created! Refreshing your session...";
            StateHasChanged();
            
            // Redirect to /onboarding-complete which will handle the re-authentication flow
            Logger.LogInformation("[Onboarding] Redirecting to onboarding-complete");
            Navigation.NavigateTo("/onboarding-complete", forceLoad: true);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "[Onboarding] Failed to create Personal account");
            errorMessage = ex.Message.Contains("already registered") 
                ? "This email is already registered. Please contact support if you believe this is an error."
                : "Failed to create account. Please try again.";
            isProcessing = false;
        }
    }

    private async Task CreateBusinessAccountAsync()
    {
        try
        {
            isProcessing = true;
            loadingMessage = "Creating your business account...";
            StateHasChanged();

            var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
            var user = authState.User;

            string logtoUserId = user.FindFirst("sub")?.Value 
                                ?? user.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value 
                                ?? throw new InvalidOperationException("No user ID found in claims");
            
            string email = user.FindFirst("email")?.Value 
                          ?? user.FindFirst(System.Security.Claims.ClaimTypes.Email)?.Value 
                          ?? throw new InvalidOperationException("No email found in claims");

            Logger.LogInformation("[Onboarding] Creating Business tenant for {Email}, Company: {CompanyName}", 
                email, businessModel.CompanyName);

            string? ipAddress = HttpContextAccessor.HttpContext?.Connection.RemoteIpAddress?.ToString();
            string? userAgent = HttpContextAccessor.HttpContext?.Request.Headers["User-Agent"].ToString();

            SignupResult result = await SignupService.CreateTenantAndUserAsync(new SignupRequest
            {
                TenantId = PrefixedUlid.Generate("tenant"),
                TenantName = businessModel.CompanyName,
                UserId = PrefixedUlid.Generate("user"),
                FirstName = businessModel.FirstName,
                LastName = businessModel.LastName,
                Email = email,
                ExternalAuthId = logtoUserId,
                IpAddress = ipAddress,
                UserAgent = userAgent,
                TenantType = 1 // Organization (B2B)
            });

            Logger.LogInformation(
                "[Onboarding] Business account created - Company: {CompanyName}, TenantId: {TenantId}, UserId: {UserId}",
                businessModel.CompanyName, result.TenantId, result.UserId);

            // Update loading message and trigger authentication refresh
            loadingMessage = "Account created! Refreshing your session...";
            StateHasChanged();
            
            // Redirect to /onboarding-complete which will handle the re-authentication flow
            Logger.LogInformation("[Onboarding] Redirecting to onboarding-complete");
            Navigation.NavigateTo("/onboarding-complete", forceLoad: true);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "[Onboarding] Failed to create Business account");
            errorMessage = ex.Message.Contains("already registered") 
                ? "This email is already registered. Please contact support if you believe this is an error."
                : "Failed to create account. Please try again.";
            isProcessing = false;
        }
    }

    private void RetrySetup()
    {
        errorMessage = string.Empty;
        isProcessing = false;
        BackToAccountTypeSelection();
    }
}
