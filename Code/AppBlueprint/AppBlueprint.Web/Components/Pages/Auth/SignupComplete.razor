@page "/signup-complete"
@layout AppBlueprint.UiKit.Components.Layout.AuthLayout
@attribute [Microsoft.AspNetCore.Authorization.Authorize]
@using System.Text.Json
@using System.Net.Http.Headers
@using AppBlueprint.Web.Models.Auth
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Authentication
@using AppBlueprint.Infrastructure.Authorization
@using AppBlueprint.Application.Services
@using AppBlueprint.SharedKernel
@using Microsoft.AspNetCore.Http
@inject NavigationManager Navigation
@inject IJSRuntime JSRuntime
@inject IHttpClientFactory HttpClientFactory
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject IAuthenticationTokenService AuthenticationTokenService
@inject ISignupService SignupService
@inject IHttpContextAccessor HttpContextAccessor
@inject ILogger<SignupComplete> Logger

<main class="bg-white dark:bg-gray-900">
    <div class="min-h-[100dvh] flex items-center justify-center px-4 py-8">
        <div class="max-w-md w-full">
            @if (isProcessing)
            {
                <!-- Loading State -->
                <div class="text-center">
                    <div class="mb-6">
                        <div class="animate-spin rounded-full h-16 w-16 border-b-4 border-indigo-600 mx-auto"></div>
                    </div>
                    <h1 class="text-2xl font-bold text-gray-800 dark:text-gray-100 mb-2">
                        @loadingMessage
                    </h1>
                    <p class="text-gray-600 dark:text-gray-400">
                        Please wait while we set up your account...
                    </p>
                </div>
            }
            else if (!string.IsNullOrEmpty(errorMessage))
            {
                <!-- Error State -->
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl p-8">
                    <div class="text-center mb-6">
                        <div class="w-16 h-16 bg-red-100 dark:bg-red-900/20 rounded-full flex items-center justify-center mx-auto mb-4">
                            <svg class="w-8 h-8 text-red-600 dark:text-red-400" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
                            </svg>
                        </div>
                        <h1 class="text-2xl font-bold text-gray-800 dark:text-gray-100 mb-2">Setup Failed</h1>
                        <p class="text-red-600 dark:text-red-400 mb-6">@errorMessage</p>
                    </div>
                    <div class="space-y-3">
                        <button @onclick="RetrySetup" class="w-full px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors">
                            Try Again
                        </button>
                        <a href="/signup" class="block w-full px-4 py-2 bg-gray-100 dark:bg-gray-700 text-gray-800 dark:text-gray-200 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors text-center">
                            Back to Signup
                        </a>
                    </div>
                </div>
            }
            else if (isSuccess)
            {
                <!-- Success State -->
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl p-8">
                    <div class="text-center mb-6">
                        <div class="w-16 h-16 bg-green-100 dark:bg-green-900/20 rounded-full flex items-center justify-center mx-auto mb-4">
                            <svg class="w-8 h-8 text-green-600 dark:text-green-400" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
                            </svg>
                        </div>
                        <h1 class="text-2xl font-bold text-gray-800 dark:text-gray-100 mb-2">Welcome! ðŸŽ‰</h1>
                        <p class="text-gray-600 dark:text-gray-400 mb-6">Your account has been created successfully.</p>
                    </div>
                    <div class="text-center">
                        <p class="text-sm text-gray-500 dark:text-gray-400 mb-4">Redirecting to dashboard in @redirectCountdown seconds...</p>
                        <a href="/" class="text-indigo-600 dark:text-indigo-400 hover:underline">Go to Dashboard Now</a>
                    </div>
                </div>
            }
        </div>
    </div>
</main>

@code {
    private bool isProcessing = true;
    private bool isSuccess = false;
    private string errorMessage = string.Empty;
    private string loadingMessage = "Setting up your account...";
    private int redirectCountdown = 3;
    private Timer? redirectTimer;
    private string? accessToken;
    private bool hasRendered = false;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            Logger.LogInformation("[SignupComplete] Page loaded - starting account setup");
            
            // Get authentication state
            var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
            var user = authState.User;

            if (user?.Identity?.IsAuthenticated != true)
            {
                Logger.LogWarning("[SignupComplete] User not authenticated - redirecting to signup");
                Navigation.NavigateTo("/signup", forceLoad: true);
                return;
            }

            Logger.LogInformation("[SignupComplete] User authenticated: {Name}", user.Identity.Name);

            // Get access token from authentication properties using the new service
            accessToken = await AuthenticationTokenService.GetAccessTokenAsync();
            
            if (string.IsNullOrEmpty(accessToken))
            {
                Logger.LogWarning("[SignupComplete] No access token found in authentication properties");
            }
            else
            {
                Logger.LogInformation("[SignupComplete] Access token retrieved successfully (length: {Length})", accessToken.Length);
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "[SignupComplete] Error during initialization");
            errorMessage = "An unexpected error occurred. Please try again.";
            isProcessing = false;
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender || hasRendered)
            return;

        hasRendered = true;

        try
        {
            // Now we can safely call JavaScript interop
            // Try to get signup session data from localStorage
            string? sessionJson = await JSRuntime.InvokeAsync<string?>("localStorage.getItem", "signupSession");

            if (string.IsNullOrEmpty(sessionJson))
            {
                Logger.LogInformation("[SignupComplete] No signup session found - user probably logged in normally, redirecting to dashboard");
                Navigation.NavigateTo("/", forceLoad: true);
                return;
            }

            var sessionData = JsonSerializer.Deserialize<SignupSessionData>(sessionJson);

            if (sessionData is null)
            {
                Logger.LogError("[SignupComplete] Failed to deserialize signup session data");
                errorMessage = "Invalid signup session data.";
                isProcessing = false;
                await InvokeAsync(StateHasChanged);
                return;
            }

            var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
            var user = authState.User;

            Logger.LogInformation("[SignupComplete] Creating {AccountType} account", sessionData.AccountType);

            // Create tenant/user based on account type
            if (sessionData.AccountType == "business")
            {
                loadingMessage = "Creating your organization...";
                await CreateBusinessAccountAsync(sessionData, user);
            }
            else
            {
                loadingMessage = "Creating your personal workspace...";
                await CreatePersonalAccountAsync(sessionData, user);
            }

            // Clear signup session data
            await JSRuntime.InvokeVoidAsync("localStorage.removeItem", "signupSession");

            // Success - start redirect countdown
            isSuccess = true;
            isProcessing = false;
            StartRedirectCountdown();

            Logger.LogInformation("[SignupComplete] Account setup completed successfully");
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "[SignupComplete] Error during account setup");
            errorMessage = "An unexpected error occurred during account setup. Please try again.";
            isProcessing = false;
        }

        await InvokeAsync(StateHasChanged);
    }

    private async Task CreatePersonalAccountAsync(SignupSessionData sessionData, System.Security.Claims.ClaimsPrincipal user)
    {
        // Get Logto user ID from claims
        string logtoUserId = user.FindFirst("sub")?.Value 
                            ?? user.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value 
                            ?? throw new InvalidOperationException("No user ID found in claims");
        
        string email = user.FindFirst("email")?.Value 
                      ?? user.FindFirst(System.Security.Claims.ClaimTypes.Email)?.Value 
                      ?? throw new InvalidOperationException("No email found in claims");

        Logger.LogInformation("[SignupComplete] Creating personal tenant for Logto user {LogtoUserId}, Email: {Email}", 
            logtoUserId, email);

        // Get IP address and user agent for audit logging
        string? ipAddress = HttpContextAccessor.HttpContext?.Connection.RemoteIpAddress?.ToString();
        string? userAgent = HttpContextAccessor.HttpContext?.Request.Headers["User-Agent"].ToString();

        // Create tenant and user atomically via secure stored procedure
        SignupResult result = await SignupService.CreateTenantAndUserAsync(new SignupRequest
        {
            TenantId = PrefixedUlid.Generate("tenant"),
            TenantName = $"{sessionData.FirstName} {sessionData.LastName}",
            UserId = PrefixedUlid.Generate("user"),
            FirstName = sessionData.FirstName,
            LastName = sessionData.LastName,
            Email = email,
            ExternalAuthId = logtoUserId,
            IpAddress = ipAddress,
            UserAgent = userAgent
        });

        Logger.LogInformation(
            "[SignupComplete] Personal account created - TenantId: {TenantId}, UserId: {UserId}, ProfileId: {ProfileId}",
            result.TenantId, result.UserId, result.ProfileId);
    }

    private async Task CreateBusinessAccountAsync(SignupSessionData sessionData, System.Security.Claims.ClaimsPrincipal user)
    {
        // Get Logto user ID from claims
        string logtoUserId = user.FindFirst("sub")?.Value 
                            ?? user.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value 
                            ?? throw new InvalidOperationException("No user ID found in claims");
        
        string email = user.FindFirst("email")?.Value 
                      ?? user.FindFirst(System.Security.Claims.ClaimTypes.Email)?.Value 
                      ?? throw new InvalidOperationException("No email found in claims");

        Logger.LogInformation("[SignupComplete] Creating business tenant for Logto user {LogtoUserId}, Company: {CompanyName}", 
            logtoUserId, sessionData.CompanyName);

        // Get IP address and user agent for audit logging
        string? ipAddress = HttpContextAccessor.HttpContext?.Connection.RemoteIpAddress?.ToString();
        string? userAgent = HttpContextAccessor.HttpContext?.Request.Headers["User-Agent"].ToString();

        // Create tenant and user atomically via secure stored procedure
        // Note: Business tenant creation may need extended stored procedure for VAT/country fields
        SignupResult result = await SignupService.CreateTenantAndUserAsync(new SignupRequest
        {
            TenantId = PrefixedUlid.Generate("tenant"),
            TenantName = sessionData.CompanyName,
            UserId = PrefixedUlid.Generate("user"),
            FirstName = sessionData.FirstName,
            LastName = sessionData.LastName,
            Email = email,
            ExternalAuthId = logtoUserId,
            IpAddress = ipAddress,
            UserAgent = userAgent
        });

        Logger.LogInformation(
            "[SignupComplete] Business account created - Company: {CompanyName}, TenantId: {TenantId}, UserId: {UserId}",
            sessionData.CompanyName, result.TenantId, result.UserId);
    }

    /// <summary>
    /// Creates an authenticated HTTP client with the user's JWT Bearer token from Logto.
    /// This ensures API calls are made with proper authorization.
    /// Token is retrieved from authentication cookie via HttpContext.GetTokenAsync().
    /// </summary>
    private HttpClient GetAuthenticatedHttpClient()
    {
        var httpClient = HttpClientFactory.CreateClient();
        httpClient.BaseAddress = new Uri("http://localhost:8091");

        if (!string.IsNullOrEmpty(accessToken))
        {
            httpClient.DefaultRequestHeaders.Authorization = new AuthenticationHeaderValue("Bearer", accessToken);
            Logger.LogInformation("[SignupComplete] Added Bearer token to HTTP client");
        }
        else
        {
            Logger.LogWarning("[SignupComplete] No access token found - API calls may fail with 401");
        }

        return httpClient;
    }

    // Response model for tenant creation
    private sealed class TenantCreationResponse
    {
        public required string Id { get; set; }
        public required string Name { get; set; }
    }

    private void StartRedirectCountdown()
    {
        redirectTimer = new Timer(_ =>
        {
            redirectCountdown--;
            InvokeAsync(StateHasChanged);

            if (redirectCountdown <= 0)
            {
                redirectTimer?.Dispose();
                Navigation.NavigateTo("/", forceLoad: true);
            }
        }, null, TimeSpan.FromSeconds(1), TimeSpan.FromSeconds(1));
    }

    private async Task RetrySetup()
    {
        errorMessage = string.Empty;
        isProcessing = true;
        await OnInitializedAsync();
    }

    public void Dispose()
    {
        redirectTimer?.Dispose();
    }
}
