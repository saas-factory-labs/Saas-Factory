@page "/settings/todos"
@attribute [Authorize]
@using Microsoft.AspNetCore.Authorization
@using AppBlueprint.TodoAppKernel.Domain
@using AppBlueprint.TodoAppKernel.Controllers
@using AppBlueprint.TodoAppKernel.Controllers.Dto
@using AppBlueprint.Web.Services
@inject TodoService TodoService
@inject ILogger<Todos> Logger

<div class="px-4 sm:px-6 lg:px-8 py-8 w-full max-w-[96rem] mx-auto">

    <!-- Page header -->
    <div class="mb-8">
        <h1 class="text-2xl md:text-3xl text-gray-800 dark:text-gray-100 font-bold">Todo Management</h1>
    </div>

    <!-- Content -->
    <div class="bg-white dark:bg-gray-800 shadow-xs rounded-xl mb-8">
        <div class="flex flex-col md:flex-row md:-mr-px">
            <AppBlueprint.UiKit.Components.Settings.SettingsSidebar />

            <!-- Todos Panel -->
            <div class="grow">
                <!-- Panel body -->
                <div class="p-6 space-y-6">
                    <div class="flex justify-between items-center mb-5">
                        <h2 class="text-2xl text-gray-800 dark:text-gray-100 font-bold">My Todos</h2>
                        <button @onclick="ShowAddTodoForm" class="btn bg-violet-500 hover:bg-violet-600 text-white">
                            <svg class="fill-current shrink-0 mr-2" width="16" height="16" viewBox="0 0 16 16">
                                <path d="M15 7H9V1c0-.6-.4-1-1-1S7 .4 7 1v6H1c-.6 0-1 .4-1 1s.4 1 1 1h6v6c0 .6.4 1 1 1s1-.4 1-1V9h6c.6 0 1-.4 1-1s-.4-1-1-1z"/>
                            </svg>
                            <span>Add Todo</span>
                        </button>
                    </div>

                    @if (isLoading)
                    {
                        <div class="flex justify-center items-center py-12">
                            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-violet-500"></div>
                        </div>
                    }
                    else if (errorMessage is not null)
                    {
                        <div class="bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-lg p-4">
                            <div class="flex items-center">
                                <svg class="w-5 h-5 text-red-500 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>
                                </svg>
                                <span class="text-red-800 dark:text-red-200">@errorMessage</span>
                            </div>
                        </div>
                    }
                    else if (showAddForm)
                    {
                        <!-- Add Todo Form -->
                        <div class="bg-gray-50 dark:bg-gray-900/50 border border-gray-200 dark:border-gray-700 rounded-lg p-6">
                            <h3 class="text-lg font-semibold text-gray-800 dark:text-gray-100 mb-4">Add New Todo</h3>
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium mb-1" for="title">Title</label>
                                    <input id="title" class="form-input w-full dark:bg-gray-700" type="text" @bind="newTodoTitle" placeholder="Enter todo title"/>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-1" for="description">Description</label>
                                    <textarea id="description" class="form-input w-full dark:bg-gray-700" rows="3" @bind="newTodoDescription" placeholder="Enter todo description"></textarea>
                                </div>
                                <div class="flex justify-end space-x-2">
                                    <button @onclick="CancelAddTodo" class="btn border-gray-200 dark:border-gray-700/60 hover:border-gray-300 dark:hover:border-gray-600 text-gray-800 dark:text-gray-300 bg-white dark:bg-gray-800">
                                        Cancel
                                    </button>
                                    <button @onclick="AddTodo" disabled="@isSubmitting" class="btn bg-violet-500 hover:bg-violet-600 text-white">
                                        @if (isSubmitting)
                                        {
                                            <span>Adding...</span>
                                        }
                                        else
                                        {
                                            <span>Add Todo</span>
                                        }
                                    </button>
                                </div>
                            </div>
                        </div>
                    }

                    <!-- Todo List -->
                    @if (todos is not null && todos.Any())
                    {
                        <div class="space-y-3">
                            @foreach (var todo in todos)
                            {
                                <div class="bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg p-4 hover:shadow-md transition-shadow">
                                    <div class="flex items-start justify-between">
                                        <div class="flex-1">
                                            <div class="flex items-center space-x-3">
                                                <button @onclick="() => ToggleTodoComplete(todo)" 
                                                        class="shrink-0 w-5 h-5 rounded border-2 @(todo.IsCompleted ? "bg-violet-500 border-violet-500" : "border-gray-300 dark:border-gray-600") flex items-center justify-center">
                                                    @if (todo.IsCompleted)
                                                    {
                                                        <svg class="w-3 h-3 text-white" fill="currentColor" viewBox="0 0 20 20">
                                                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                                                        </svg>
                                                    }
                                                </button>
                                                <div class="flex-1">
                                                    <h4 class="text-sm font-medium text-gray-800 dark:text-gray-100 @(todo.IsCompleted ? "line-through text-gray-500" : "")">
                                                        @todo.Title
                                                    </h4>
                                                    @if (!string.IsNullOrEmpty(todo.Description))
                                                    {
                                                        <p class="text-sm text-gray-600 dark:text-gray-400 mt-1 @(todo.IsCompleted ? "line-through" : "")">
                                                            @todo.Description
                                                        </p>
                                                    }
                                                    <p class="text-xs text-gray-500 dark:text-gray-500 mt-1">
                                                        Created: @todo.CreatedAt.ToLocalTime().ToString("MMM dd, yyyy h:mm tt")
                                                    </p>
                                                </div>
                                            </div>
                                        </div>
                                        <button @onclick="() => DeleteTodo(todo.Id)" 
                                                class="ml-4 text-red-500 hover:text-red-700 dark:text-red-400 dark:hover:text-red-300">
                                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                                                <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd"/>
                                            </svg>
                                        </button>
                                    </div>
                                </div>
                            }
                        </div>
                    }
                    else if (!isLoading && errorMessage is null)
                    {
                        <div class="text-center py-12">
                            <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
                            </svg>
                            <h3 class="mt-2 text-sm font-medium text-gray-900 dark:text-gray-100">No todos</h3>
                            <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">Get started by creating a new todo.</p>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>

</div>

@code {
    private List<TodoEntity> todos = new();
    private bool isLoading = true;
    private bool isSubmitting;
    private bool showAddForm = false;
    private string? errorMessage;
    private string newTodoTitle = string.Empty;
    private string newTodoDescription = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        await LoadTodosAsync();
    }

    private async Task LoadTodosAsync()
    {
        try
        {
            isLoading = true;
            errorMessage = null;
            StateHasChanged();

            var result = await TodoService.GetTodosAsync();
            todos = result.ToList();

            Logger.LogInformation("Loaded {Count} todos", todos.Count);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading todos");
            errorMessage = "Failed to load todos. Please try again.";
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private void ShowAddTodoForm()
    {
        showAddForm = true;
        newTodoTitle = string.Empty;
        newTodoDescription = string.Empty;
    }

    private void CancelAddTodo()
    {
        showAddForm = false;
        newTodoTitle = string.Empty;
        newTodoDescription = string.Empty;
    }

    private async Task AddTodo()
    {
        if (string.IsNullOrWhiteSpace(newTodoTitle))
        {
            return;
        }

        try
        {
            isSubmitting = true;
            StateHasChanged();

            var request = new CreateTodoRequest
            {
                Title = newTodoTitle.Trim(),
                Description = newTodoDescription?.Trim()
            };
            var createdTodo = await TodoService.CreateTodoAsync(request);

            if (createdTodo is not null)
            {
                todos.Insert(0, createdTodo);
                showAddForm = false;
                newTodoTitle = string.Empty;
                newTodoDescription = string.Empty;
                Logger.LogInformation("Todo created successfully: {Title}", createdTodo.Title);
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error creating todo");
            errorMessage = "Failed to create todo. Please try again.";
        }
        finally
        {
            isSubmitting = false;
            StateHasChanged();
        }
    }

    private async Task ToggleTodoComplete(TodoEntity todo)
    {
        try
        {
            if (!todo.IsCompleted)
            {
                var updated = await TodoService.CompleteTodoAsync(todo.Id);
                if (updated is not null)
                {
                    var index = todos.FindIndex(t => t.Id == todo.Id);
                    if (index >= 0)
                    {
                        todos[index] = updated;
                        StateHasChanged();
                    }
                }
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error toggling todo completion");
            errorMessage = "Failed to update todo. Please try again.";
            StateHasChanged();
        }
    }

    private async Task DeleteTodo(string todoId)
    {
        try
        {
            await TodoService.DeleteTodoAsync(todoId);
            todos.RemoveAll(t => t.Id == todoId);
            Logger.LogInformation("Todo deleted: {TodoId}", todoId);
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error deleting todo");
            errorMessage = "Failed to delete todo. Please try again.";
            StateHasChanged();
        }
    }
}
