@using System.Reflection
@using AppBlueprint.UiKit.Models
@using Microsoft.AspNetCore.Components.Authorization
@inherits LayoutComponentBase

@inject List<NavLinkMetadata> Links
@inject NavigationManager NavigationManager

<CascadingAuthenticationState>
    <CascadingValue Value="Links">
        <Router AppAssembly="@typeof(Program).Assembly"
                AdditionalAssemblies="@AdditionalAssemblies">
            <Found Context="routeData">
                <AuthorizeRouteView RouteData="@routeData" DefaultLayout="@typeof(AppBlueprint.UiKit.Components.Layout.MainLayout)">
                    <NotAuthorized>
                        @{
                            Console.WriteLine($"[Routes] NotAuthorized triggered for path: {NavigationManager.Uri}");
                            Console.WriteLine($"[Routes] User.Identity.IsAuthenticated: {context.User.Identity?.IsAuthenticated}");
                            Console.WriteLine($"[Routes] User.Identity.Name: {context.User.Identity?.Name}");
                            Console.WriteLine($"[Routes] User.Claims count: {context.User.Claims.Count()}");
                            foreach (var claim in context.User.Claims)
                            {
                                Console.WriteLine($"[Routes] Claim: {claim.Type} = {claim.Value}");
                            }
                        }
                        @if (context.User.Identity?.IsAuthenticated != true)
                        {
                            @RedirectToLogin()
                        }
                        else
                        {
                            <div class="flex justify-center items-center h-screen">
                                <p class="text-xl font-semibold text-gray-800 dark:text-gray-100">You are not authorized to access this page.</p>
                                <div class="mt-4 text-sm text-gray-600 dark:text-gray-400">
                                    <p>User: @context.User.Identity?.Name</p>
                                    <p>Authenticated: @context.User.Identity?.IsAuthenticated</p>
                                </div>
                            </div>
                        }
                    </NotAuthorized>
                    <Authorizing>
                        <div class="flex justify-center items-center h-screen">
                            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-violet-600"></div>
                        </div>
                    </Authorizing>
                </AuthorizeRouteView>
            </Found>
            <NotFound>
                <div class="flex justify-center items-center h-screen">
                    <p class="text-xl font-semibold text-gray-800 dark:text-gray-100">Sorry, there's nothing here!</p>
                </div>
            </NotFound>
        </Router>
    </CascadingValue>
</CascadingAuthenticationState>

@code {
    private IEnumerable<Assembly> AdditionalAssemblies { get; } = new[] 
    { 
        typeof(UiKit._Imports).Assembly
    };

    protected override void OnInitialized()
    {
        Console.WriteLine($"[Routes] Navigation links injected: {Links?.Count ?? 0}");
    }

    private RenderFragment RedirectToLogin() => _ =>
    {
        NavigationManager.NavigateTo("/signup", forceLoad: true);
    };
}

