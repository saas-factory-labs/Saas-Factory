@using AppBlueprint.Application.Interfaces
@using AppBlueprint.Domain.Entities.Notifications
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.SignalR.Client
@inject INotificationService NotificationService
@inject NavigationManager Navigation
@inject AuthenticationStateProvider AuthenticationStateProvider
@implements IAsyncDisposable

<div class="relative">
    <button @onclick="ToggleDropdown" class="relative p-2 text-gray-600 dark:text-gray-300 hover:text-gray-900 dark:hover:text-white rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" />
        </svg>
        @if (_unreadCount > 0)
        {
            <span class="absolute top-0 right-0 inline-flex items-center justify-center px-2 py-1 text-xs font-bold leading-none text-white transform translate-x-1/2 -translate-y-1/2 bg-red-600 rounded-full">
                @(_unreadCount > 99 ? "99+" : _unreadCount.ToString())
            </span>
        }
    </button>

    @if (_isOpen)
    {
        <div class="absolute right-0 z-50 mt-2 w-80 bg-white dark:bg-gray-800 rounded-lg shadow-xl border border-gray-200 dark:border-gray-700 max-h-96 overflow-hidden">
            <!-- Header -->
            <div class="flex items-center justify-between px-4 py-3 border-b border-gray-200 dark:border-gray-700">
                <h3 class="text-sm font-semibold text-gray-900 dark:text-white">
                    Notifications
                    @if (_unreadCount > 0)
                    {
                        <span class="ml-2 text-xs text-gray-500 dark:text-gray-400">(@_unreadCount unread)</span>
                    }
                </h3>
                @if (_unreadCount > 0)
                {
                    <button @onclick="MarkAllAsRead" class="text-xs text-blue-600 dark:text-blue-400 hover:underline">
                        Mark all read
                    </button>
                }
            </div>

            <!-- Notifications List -->
            <div class="max-h-80 overflow-y-auto">
                @if (_notifications.Any())
                {
                    @foreach (var notification in _notifications)
                    {
                        <div @onclick="() => HandleNotificationClick(notification)" 
                             class="px-4 py-3 border-b border-gray-100 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-700 cursor-pointer transition-colors @(!notification.IsRead ? "bg-blue-50 dark:bg-blue-900/20" : "")">
                            <div class="flex items-start gap-3">
                                <div class="flex-shrink-0 mt-1">
                                    @GetNotificationIcon(notification.Type)
                                </div>
                                <div class="flex-1 min-w-0">
                                    <p class="text-sm font-medium text-gray-900 dark:text-white @(!notification.IsRead ? "font-semibold" : "")">
                                        @notification.Title
                                    </p>
                                    <p class="text-xs text-gray-600 dark:text-gray-400 mt-1 line-clamp-2">
                                        @notification.Message
                                    </p>
                                    <p class="text-xs text-gray-500 dark:text-gray-500 mt-1">
                                        @GetRelativeTime(notification.CreatedAt)
                                    </p>
                                </div>
                                @if (!notification.IsRead)
                                {
                                    <div class="flex-shrink-0">
                                        <span class="inline-block w-2 h-2 bg-blue-600 rounded-full"></span>
                                    </div>
                                }
                            </div>
                        </div>
                    }
                }
                else
                {
                    <div class="px-4 py-8 text-center">
                        <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4" />
                        </svg>
                        <p class="mt-2 text-sm text-gray-500 dark:text-gray-400">No notifications</p>
                    </div>
                }
            </div>

            @if (_notifications.Any())
            {
                <!-- Footer -->
                <div class="px-4 py-3 border-t border-gray-200 dark:border-gray-700">
                    <a href="/demo/notifications" class="block text-center text-sm text-blue-600 dark:text-blue-400 hover:underline">
                        View all notifications
                    </a>
                </div>
            }
        </div>
    }
</div>

@code {
    private HubConnection? _hubConnection;
    private string? _userId;
    private bool _isOpen = false;
    private int _unreadCount = 0;
    private List<UserNotificationEntity> _notifications = new();

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;
        
        if (user.Identity?.IsAuthenticated == true)
        {
            _userId = user.FindFirst("sub")?.Value ?? user.Identity?.Name;
            
            if (!string.IsNullOrEmpty(_userId))
            {
                await LoadNotifications();
                await InitializeSignalR();
            }
        }
    }

    private async Task LoadNotifications()
    {
        try
        {
            _notifications = (await NotificationService.GetUserNotificationsAsync(_userId!, 10)).ToList();
            _unreadCount = await NotificationService.GetUnreadCountAsync(_userId!);
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Failed to load notifications: {ex.Message}");
        }
    }

    private async Task InitializeSignalR()
    {
        try
        {
            _hubConnection = new HubConnectionBuilder()
                .WithUrl(Navigation.ToAbsoluteUri("/hubs/notifications"), options =>
                {
                    options.WithCredentials = true; // Explicitly send cookies
                })
                .WithAutomaticReconnect()
                .Build();

            _hubConnection.On<string, string, string, NotificationType, string?, DateTime>("ReceiveNotification",
                async (id, title, message, type, actionUrl, createdAt) =>
                {
                    await InvokeAsync(async () =>
                    {
                        // Reload notifications to get the new one
                        await LoadNotifications();
                    });
                });

            await _hubConnection.StartAsync();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Failed to connect to SignalR: {ex.Message}");
        }
    }

    private void ToggleDropdown()
    {
        _isOpen = !_isOpen;
    }

    private async Task HandleNotificationClick(UserNotificationEntity notification)
    {
        if (!notification.IsRead)
        {
            await NotificationService.MarkAsReadAsync(notification.Id);
            notification.MarkAsRead();
            _unreadCount--;
        }

        if (!string.IsNullOrEmpty(notification.ActionUrl))
        {
            Navigation.NavigateTo(notification.ActionUrl);
        }

        _isOpen = false;
        StateHasChanged();
    }

    private async Task MarkAllAsRead()
    {
        try
        {
            await NotificationService.MarkAllAsReadAsync(_userId!);
            foreach (var notification in _notifications.Where(n => !n.IsRead))
            {
                notification.MarkAsRead();
            }
            _unreadCount = 0;
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Failed to mark all as read: {ex.Message}");
        }
    }

    private static RenderFragment GetNotificationIcon(NotificationType type) => builder =>
    {
        var (bgColor, iconColor, path) = type switch
        {
            NotificationType.Success => ("bg-green-100 dark:bg-green-900", "text-green-600 dark:text-green-400", "M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"),
            NotificationType.Warning => ("bg-yellow-100 dark:bg-yellow-900", "text-yellow-600 dark:text-yellow-400", "M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"),
            NotificationType.Error => ("bg-red-100 dark:bg-red-900", "text-red-600 dark:text-red-400", "M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"),
            _ => ("bg-blue-100 dark:bg-blue-900", "text-blue-600 dark:text-blue-400", "M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z")
        };

        builder.OpenElement(0, "div");
        builder.AddAttribute(1, "class", $"rounded-full p-1.5 {bgColor}");
        builder.OpenElement(2, "svg");
        builder.AddAttribute(3, "class", $"w-4 h-4 {iconColor}");
        builder.AddAttribute(4, "fill", "none");
        builder.AddAttribute(5, "stroke", "currentColor");
        builder.AddAttribute(6, "viewBox", "0 0 24 24");
        builder.OpenElement(7, "path");
        builder.AddAttribute(8, "stroke-linecap", "round");
        builder.AddAttribute(9, "stroke-linejoin", "round");
        builder.AddAttribute(10, "stroke-width", "2");
        builder.AddAttribute(11, "d", path);
        builder.CloseElement(); // path
        builder.CloseElement(); // svg
        builder.CloseElement(); // div
    };

    private static string GetRelativeTime(DateTime dateTime)
    {
        TimeSpan timeSpan = DateTime.UtcNow - dateTime;

        if (timeSpan.TotalMinutes < 1)
            return "Just now";
        if (timeSpan.TotalMinutes < 60)
            return $"{(int)timeSpan.TotalMinutes}m ago";
        if (timeSpan.TotalHours < 24)
            return $"{(int)timeSpan.TotalHours}h ago";
        if (timeSpan.TotalDays < 7)
            return $"{(int)timeSpan.TotalDays}d ago";
        
        return dateTime.ToString("MMM d");
    }

    public async ValueTask DisposeAsync()
    {
        if (_hubConnection is not null)
        {
            await _hubConnection.DisposeAsync();
        }
    }
}
